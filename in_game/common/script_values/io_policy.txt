io_members_and_potential_members_opinion_value = {
	desc = "OPINION_OF_OTHER_MEMBERS"

	save_temporary_value_as = {
		name = opinion_count
		value = 0
	}

	#IO might not exist yet
	if = {
		limit = {
			exists = scope:recipient
		}
		scope:recipient = {
			every_international_organization_member = {
				root = {
					add = {
						value = this_opinion_of_prev
					}
				}
			}
			save_temporary_value_as = {
				name = opinion_count
				value = {
					value = scope:opinion_count
					add = total_members
				}
			}	
		}
	}
	else = {
		#other potential member might not be specified
		scope:actor ?= {
			root = {
				add = {
					value = this_opinion_of_prev
				}
			}
			save_temporary_value_as = {
				name = opinion_count
				value = 1
			}	
		}
	}

	#potential target - let's see how much we don't like them
	scope:target ?= {
		root = {
			subtract = {
				value = this_opinion_of_prev
			}
		}
		save_temporary_value_as = {
			name = opinion_count
			value = {
				value = scope:opinion_count
				add = 1
			}
		}	
	}

	#take the average opinion
	if = {
		limit = {
			scope:opinion_count > 0
		}
		divide = scope:opinion_count
	}
}

io_electors_opinion_value = {
	desc = "OPINION_OF_ELECTORS"
	save_temporary_value_as = {
		name = opinion_count
		value = 0
	}
	#IO might not exist yet
	scope:recipient ?= {
		every_international_organization_elector = {
			limit = { not = { this = root } }
			root = { add = { value = this_opinion_of_prev } }
		}
		save_temporary_value_as = {
			name = opinion_count
			value = {
				value = scope:opinion_count
				add = total_members
			}
		}	
	}
	#take the average opinion
	if = {
		limit = { scope:opinion_count > 0 }
		divide = scope:opinion_count
	}
}

io_get_average_great_power_score = {
	desc = "AVERAGE_GREAT_POWER_SCORE_OF_IO"
	save_temporary_value_as = {
		name = great_power_score_count
		value = 0
	}
	#IO might not exist yet
	scope:recipient ?= {
		every_international_organization_member = {
			root = { add = { value = great_power_score } }
		}
		save_temporary_value_as = {
			name = great_power_score_count
			value = {
				value = scope:great_power_score_count
				add = total_members
			}
		}
	}
	#take the average opinion
	if = {
		limit = { scope:great_power_score_count > 0 }
		divide = scope:great_power_score_count
	}
}

io_compared_great_power_score_to_leader = {
	if = {
		limit = {
			scope:recipient = { international_organization_has_leader = yes }
			NOT = { is_leader_of_international_organization = scope:recipient }
		}
		add = {
			desc = "GREAT_POWER_LEADER_COMPARISON"
			value = scope:recipient.leader_country.great_power_score
			subtract = great_power_score
		}
	}
}

io_get_average_military_strength = {
	desc = "AVERAGE_MILITARY_STRENGTH_OF_IO"
	save_temporary_value_as = {
		name = military_strength_count
		value = 0
	}
	#IO might not exist yet
	scope:recipient ?= {
		every_international_organization_member = {
			root = { add = { value = military_strength } }
		}
		save_temporary_value_as = {
			name = military_strength_count
			value = {
				value = scope:military_strength_count
				add = total_members
			}
		}
	}
	#take the average opinion
	if = {
		limit = { scope:military_strength_count > 0 }
		divide = scope:military_strength_count
	}
}

io_wants_offensive_war_policy = {
	desc = "POLICY_STRATEGIC_VALUE"
	#check if the IO would beat any enemies we want to destroy
	add = io_get_average_military_strength
	subtract = {
		value = 0
		save_temporary_value_as = {
			name = potential_miltary_target_count
			value = 0
		}
		#Let's check OUR rivals
		every_rival = {
			limit = {
				trigger_if = {
					limit = { exists = scope:recipient }
					NOT = { is_member_of_international_organization = scope:recipient }
				}
			}
			subtract = military_strength
			save_temporary_value_as = {
				name = potential_miltary_target_count
				value = {
					value = scope:potential_miltary_target_count
					add = 1
				}
			}
		}
		#Then everyone who rivals US
		every_enemy = {
			limit = {
				trigger_if = {
					limit = { exists = scope:recipient }
					NOT = { is_member_of_international_organization = scope:recipient }
				}
			}
			subtract = military_strength
			save_temporary_value_as = {
				name = potential_miltary_target_count
				value = {
					value = scope:potential_miltary_target_count
					add = 1
				}
			}
		}
		if = {
			limit = { scope:potential_miltary_target_count > 0 }
			divide = scope:potential_miltary_target_count
		}
	}
	add = modifier:bias_for_militarist_policies
	subtract = modifier:bias_for_diplomat_policies
	#multiply it with the country's desire of military policies
	multiply = {
		value = modifier:aggressiveness_modifier
		add = 1
	}
	#...and the pacifists should be hardcore against it
	if = {
		limit = { modifier:carefulness_modifier > 0 }
		divide = {
			value = modifier:carefulness_modifier
			add = 1
		}
	}
}

# This default value is used to increase AI emperor desire to reform when they hvae a improved chance to pass
hre_default_emperor_policy_desire = {
	if = {
		limit = {
			scope:recipient = { international_organization_has_leader = yes }
			is_leader_of_international_organization = scope:recipient
		}
		if = {
			limit = { scope:recipient.var:imperial_authority > 50 }
			add = {
				desc = "imperial_authority"
				value = "scope:recipient.var:imperial_authority"
				subtract = 50
				multiply = 2.5
			}
		}
		# Emperor Diplo Rep
		add = {
			desc = "IO_LEADER_DIP_REP"
			value = scope:recipient.leader_country.modifier:diplomatic_reputation
		}
		# Dynastic Power of Emperor
		add = {
			desc = "IA_DYNASTIC_POWER"
			value = "scope:recipient.leader_country.dynastic_power(international_organization:hre)"
			multiply = 0.5
		}
	}
}
hre_default_policy_opinion = {
	if = {
		limit = {
			exists = scope:policy
			exists = scope:recipient
			scope:recipient = {
				has_variable = io_law_target
				international_organization_has_leader = yes
			}
			NOT = { is_leader_of_international_organization = scope:recipient }
		}
		if = {
			#voting FOR the proposed policy
			limit = { scope:recipient.var:io_law_target = scope:policy }
			#opinion of the leader country
			if = {
				limit = { "opinion(scope:recipient.leader_country)" > 0 }
				add = {
					desc = "POLICY_BIAS_OPINION_OF_EMPEROR"
					value = "opinion(scope:recipient.leader_country)"
					multiply = 0.25
				}
			}
			else = {
				add = {
					desc = "POLICY_BIAS_OPINION_OF_EMPEROR"
					value = "opinion(scope:recipient.leader_country)"
					multiply = 0.5
				}
			}
			#diplomatic rep of the leader country
			add = {
				desc = "IO_LEADER_DIP_REP"
				value = scope:recipient.leader_country.modifier:diplomatic_reputation
			}
			add = {
				desc = "POLICY_BIAS_FAVORS_OF_EMPEROR"
				value = "favors(scope:recipient.leader_country)"
				multiply = 2
			}
			add = {
				desc = "POLICY_BIAS_ANTAGONISM_OF_EMPEROR"
				value = "antagonism(scope:recipient.leader_country)"
				multiply = -0.5
			}
			add = {
				desc = "GREAT_POWER_LEADER_COMPARISON"
				value = scope:recipient.leader_country.great_power_score
				subtract = 250 # Dont take Great Power Score from being emperor into account here
				subtract = great_power_score
				multiply = 0.25 # Balance factor
			}
			if = {
				limit = { is_allied_with = { target = scope:recipient.leader_country } }
				add = {
					desc = "game_concept_alliance"
					value = 5
				}
			}
			if = {
				limit = { same_dynasty_as = { target = scope:recipient.leader_country } }
				add = {
					desc = "opinion_same_dynasty"
					value = 10
				}
			}
			if = {
				limit = { is_subject_of = scope:recipient.leader_country }
				add = {
					desc = "game_concept_subject"
					value = 25
				}
			}
			if = {
				limit = { culture.language = scope:recipient.leader_country.culture.language }
				add = {
					desc = "DIPLOREASON_SAME_COMMON_LANGUAGE"
					value = 5
				}
			}
			if = {
				limit = { NOT = { culture.language = scope:recipient.leader_country.culture.language } }
				add = {
					desc = "DIPLOREASON_DIFFERENT_COMMON_LANGUAGE"
					value = -5
				}
			}
			# Dynastic Power of Emperor
			add = {
				desc = "IA_DYNASTIC_POWER"
				value = "scope:recipient.leader_country.dynastic_power(international_organization:hre)"
				multiply = 0.5
			}
			# Higher IA gives higher ability to pass reforms
			if = {
				limit = { scope:recipient.var:imperial_authority > 50 }
				add = {
					desc = "imperial_authority"
					value = "scope:recipient.var:imperial_authority"
					subtract = 50
					multiply = 2.5
				}
			}
			if = {
				limit = { government_type = government_type:monarchy }
				add = {
					desc = "monarchy"
					value = 5
				}
			}
			if = {
				limit = { government_type = government_type:theocracy }
				add = {
					desc = "theocracy"
					value = -5
				}
			}
			if = {
				limit = { scope:recipient = { has_variable = hre_imperial_religion_group } }
				if = {
					limit = { NOT = { religion.group = scope:recipient.var:hre_imperial_religion_group } }
					add = {
						desc = "DIPLOREASON_DIFFERENT_RELIGION_GROUP"
						value = -250
					}
				}
			}
			if = {
				limit = { scope:recipient = { has_variable = hre_imperial_religion } }
				if = {
					limit = { NOT = { religion = scope:recipient.var:hre_imperial_religion } }
					add = {
						desc = "DIPLOREASON_DIFFERENT_RELIGION"
						value = -50
					}
				}
			}
		}
		else = {
			add = {
				desc = "VOTE_BASE_VALUE"
				value = 5
			}
			if = {
				limit = { scope:recipient.var:imperial_authority > 50 }
				add = {
					desc = "imperial_authority"
					value = "scope:recipient.var:imperial_authority"
					subtract = 50
					multiply = -2.5
				}
			}
		}
	}
}

hre_default_opinion_check = {
	if = {
		limit = {
			exists = scope:recipient
			NOT = { is_leader_of_international_organization = scope:recipient }
		}
		#opinion of the leader country
		if = {
			limit = { "opinion(scope:recipient.leader_country)" > 0 }
			add = {
				desc = "POLICY_BIAS_OPINION_OF_EMPEROR"
				value = "opinion(scope:recipient.leader_country)"
				multiply = 0.25
			}
		}
		else = {
			add = {
				desc = "POLICY_BIAS_OPINION_OF_EMPEROR"
				value = "opinion(scope:recipient.leader_country)"
				multiply = 0.5
			}
		}
		#diplomatic rep of the leader country
		add = {
			desc = "IO_LEADER_DIP_REP"
			value = scope:recipient.leader_country.modifier:diplomatic_reputation
		}
		add = {
			desc = "POLICY_BIAS_FAVORS_OF_EMPEROR"
			value = "favors(scope:recipient.leader_country)"
			multiply = 2
		}
		add = {
			desc = "POLICY_BIAS_ANTAGONISM_OF_EMPEROR"
			value = "antagonism(scope:recipient.leader_country)"
			multiply = -0.5
		}
		add = {
			desc = "GREAT_POWER_LEADER_COMPARISON"
			value = scope:recipient.leader_country.great_power_score
			subtract = 250 # Dont take Great Power Score from being emperor into account here
			subtract = great_power_score
			multiply = 0.25 # Balance factor
		}
		if = {
			limit = { is_allied_with = { target = scope:recipient.leader_country } }
			add = {
				desc = "game_concept_alliance"
				value = 5
			}
		}
		if = {
			limit = { same_dynasty_as = { target = scope:recipient.leader_country } }
			add = {
				desc = "opinion_same_dynasty"
				value = 10
			}
		}
		if = {
			limit = { is_subject_of = scope:recipient.leader_country }
			add = {
				desc = "game_concept_subject"
				value = 25
			}
		}
		if = {
			limit = { culture.language = scope:recipient.leader_country.culture.language }
			add = {
				desc = "DIPLOREASON_SAME_COMMON_LANGUAGE"
				value = 5
			}
		}
		if = {
			limit = { NOT = { culture.language = scope:recipient.leader_country.culture.language } }
			add = {
				desc = "DIPLOREASON_DIFFERENT_COMMON_LANGUAGE"
				value = -5
			}
		}
		# Dynastic Power of Emperor
		add = {
			desc = "IA_DYNASTIC_POWER"
			value = "scope:recipient.leader_country.dynastic_power(international_organization:hre)"
			multiply = 0.5
		}
		# Higher IA gives higher ability to pass reforms
		if = {
			limit = { scope:recipient.var:imperial_authority > 50 }
			add = {
				desc = "imperial_authority"
				value = "scope:recipient.var:imperial_authority"
				subtract = 50
				multiply = 2.5
			}
		}
		if = {
			limit = { government_type = government_type:monarchy }
			add = {
				desc = "monarchy"
				value = 5
			}
		}
		if = {
			limit = { government_type = government_type:theocracy }
			add = {
				desc = "theocracy"
				value = -5
			}
		}
		if = {
			limit = { scope:recipient = { has_variable = hre_imperial_religion_group } }
			if = {
				limit = { NOT = { religion.group = scope:recipient.var:hre_imperial_religion_group } }
				add = {
					desc = "DIPLOREASON_DIFFERENT_RELIGION_GROUP"
					value = -250
				}
			}
		}
		if = {
			limit = { scope:recipient = { has_variable = hre_imperial_religion } }
			if = {
				limit = { NOT = { religion = scope:recipient.var:hre_imperial_religion } }
				add = {
					desc = "DIPLOREASON_DIFFERENT_RELIGION"
					value = -50
				}
			}
		}
	}
}

hre_free_city_opinion_value = {
	desc = "OPINION_OF_FREE_CITIES"
	save_temporary_value_as = {
		name = opinion_count
		value = 0
	}
	#IO might not exist yet
	scope:recipient ?= {
		every_country_with_special_status_of_type = {
			type = free_city
			limit = {
				not = { this = root }
			}
			root = { add = { value = this_opinion_of_prev } }
		}
		save_temporary_value_as = {
			name = opinion_count
			value = {
				value = scope:opinion_count
				add = total_members
			}
		}	
	}
	#take the average opinion
	if = {
		limit = { scope:opinion_count > 0 }
		divide = scope:opinion_count
	}
}

country_needs_allies_value = {
	desc = "NEEDS_ALLIES_AGAINST_STRONG_RIVALS_AND_NEIGHBOURS"

	save_temporary_scope_as = root_country

	subtract = defensive_alliance_strength
	every_neighbor_country = {
		limit = {
			nor = { 
				has_mutual_scripted_relation = {
					type = relation_type:alliance
					target = scope:root_country
				}
				in_union_with = scope:root_country
				has_royal_marriage_with = scope:root_country
			}
			is_threat_to = scope:root_country
			trigger_if = {
				limit = {
					exists = scope:actor
				}
				not = { this = scope:actor }
			}
			trigger_if = {
				limit = {
					exists = scope:target
				}
				not = { this = scope:target }
			}
		}
		add = country_strength
	}
	every_rival = {
		limit = {
			trigger_if = {
				limit = {
					exists = scope:actor
				}
				not = { this = scope:actor }
			}
			trigger_if = {
				limit = {
					exists = scope:target
				}
				not = { this = scope:target }
			}
		}
		add = country_strength
	}
	scope:target ?= {
		add = country_strength
	}
	divide = {
		value = country_strength
		min = 0.001
	}
}

union_treasury_cost = {
	desc = "UNION_TREASURY_COST"
	value = 25
	every_international_organization_member = {
		add = country_tax_base
	}
	add = "total_payment_contribution(root|union_contribution)"
}
union_treasury_payment = {
	desc = "UNION_TREASURY_COST"
	value = union_treasury_cost
	multiply = -1
}

union_treasury_parliament_cost = {
	desc = "UNION_TREASURY_COST"
	value = union_treasury_cost
	multiply = 2.5
}

union_treasury_parliament_payment = {
	desc = "UNION_TREASURY_COST"
	value = union_treasury_parliament_cost
	multiply = -1
}

union_parliament_gold_bribe_recipient = {
	if = {
		limit = { exists = scope:recipient }
		save_temporary_value_as = {
			name = parliament_gold_bribe_upper_limit
			value = {
				value = scope:recipient.monthly_income_trade_and_tax
				multiply = 4
			}
		}
		value = scope:recipient.monthly_income_trade_and_tax
	}
	else = {
		save_temporary_value_as = {
			name = parliament_gold_bribe_upper_limit
			value = {
				value = root.monthly_income_trade_and_tax
				multiply = 4
			}
		}
		value = root.monthly_income_trade_and_tax
	}
	if = {
		limit = { exists = scope:union_cost_factor_multiplier }
		multiply = scope:union_cost_factor_multiplier
	}
	if = {
		limit = { exists = scope:union_special_status_multiplier }
		multiply = scope:union_special_status_multiplier
	}
	max = scope:parliament_gold_bribe_upper_limit
}

union_parliament_gold_bribe_actor = {
	value = union_parliament_gold_bribe_recipient
	multiply = -1
}

union_member_opinion_on_maintain = {
	add = {
		desc = "VOTE_BASE_VALUE"
		value = 10
	}
	if = {
		limit = {
			scope:recipient = {
				country_has_special_status = {
					type = special_status:senior_partner
					country = scope:actor
				}
			}
		}
		subtract = {
			desc = "UNION_WE_ARE_SENIOR_PARTNER"
			value = 1000
		}
	}
}

union_member_opinion_on_centralization = {
	add = {
		desc = "VOTE_BASE_VALUE"
		value = 1
	}
	if = {
		limit = {
			exists = scope:recipient
			scope:recipient.modifier:union_integration_level > 0
		}
		subtract = {
			desc = "UNION_CURRENT_CENTRALIZATION_LEVEL"
			value = scope:recipient.modifier:union_integration_level
			multiply = 25
		}
	}
	if = {
		limit = {
			get_senior_partner = { union = scope:recipient }
			exists = scope:senior_partner_scope
		}
		#Opinion
		add = {
			desc = "UNION_OPINION_OF_SENIOR_PARTNER"
			value = "root.opinion(scope:senior_partner_scope)"
			divide = 10
		}
		#Dip Rep
		add = {
			desc = "UNION_DIPLOMATIC_REPUTATION_OF_SENIOR_PARTNER"
			value = scope:senior_partner_scope.modifier:diplomatic_reputation
			multiply = 3
		}
		#Trust
		add = {
			desc = "UNION_TRUST_OF_SENIOR_PARTNER"
			value = "root.trust(scope:senior_partner_scope)"
			divide = 10
		}
		#Great Power Score comparison
		add = {
			desc = "UNION_GREAT_POWER_SCORE_COMPARED_TO_SENIOR_PARTNER"
			value = scope:senior_partner_scope.great_power_score
			subtract = root.great_power_score
		}
		#Different Culture
		if = {
			limit = {
				exists = scope:senior_partner_scope.culture
				exists = root.culture
				scope:senior_partner_scope.culture != root.culture
			}
			add = {
				desc = "UNION_CULTURAL_INFLUENCE_VS_TRADITION"
				save_temporary_value_as = {
					name = cultural_difference
					value = {
						value = root.culture.cultural_tradition
						subtract = scope:senior_partner_scope.culture.cultural_influence
					}
				}
				value = scope:cultural_difference
				if = {
					limit = { scope:cultural_difference > 0 }
					if = {
						limit = { root.culture ?= { cultural_view = { target = scope:senior_partner_scope.culture value >= kindred } } }
						multiply = 1.5
					}
					else_if = {
						limit = { root.culture ?= { cultural_view = { target = scope:senior_partner_scope.culture value >= positive } } }
						multiply = 1.25
					}
					else_if = {
						limit = { root.culture ?= { cultural_view = { target = scope:senior_partner_scope.culture value >= neutral } } }
						multiply = 1.05
					}
					else_if = {
						limit = { root.culture ?= { cultural_view = { target = scope:senior_partner_scope.culture value >= negative } } }
						multiply = 0.5
					}
					else = {
						multiply = 0
					}
				}
				else = {
					if = {
						limit = { root.culture ?= { cultural_view = { target = scope:senior_partner_scope.culture value >= kindred } } }
						multiply = 0
					}
					else_if = {
						limit = { root.culture ?= { cultural_view = { target = scope:senior_partner_scope.culture value >= positive } } }
						multiply = 0.5
					}
					else_if = {
						limit = { root.culture ?= { cultural_view = { target = scope:senior_partner_scope.culture value >= neutral } } }
						multiply = 1.05
					}
					else_if = {
						limit = { root.culture ?= { cultural_view = { target = scope:senior_partner_scope.culture value >= negative } } }
						multiply = 1.25
					}
					else = {
						multiply = 1.5
					}
				}
			}
		}
		#Different Religion
		if = {
			limit = {
				exists = scope:senior_partner_scope.religion
				exists = root.religion
				scope:senior_partner_scope.religion != root.religion
			}
			subtract = {
				desc = "DIPLOREASON_DIFFERENT_RELIGION"
				if = {
					limit = { root.religion = { religious_view = { target = scope:senior_partner_scope.religion value >= kindred } } }
					value = 25
				}
				else_if = {
					limit = { root.religion = { religious_view = { target = scope:senior_partner_scope.religion value >= positive } } }
					value = 50
				}
				else_if = {
					limit = { root.religion = { religious_view = { target = scope:senior_partner_scope.religion value >= neutral } } }
					#Kinda bad, it takes some convincing to hold the union together
					value = 100
				}
				else_if = {
					limit = { root.religion = { religious_view = { target = scope:senior_partner_scope.religion value >= negative } } }
					#Very bad, the smaller state must be insignificant to the senior partner to be integratable at this point
					value = 500
				}
				else = {
					#No matter how well everything else is, these two states would rather kill each other than keep the union going
					value = 10000
				}
			}
		}
		#Estate Opinion
		# Nobles
		if = {
			limit = { root = { country_has_estate = estate_type:nobles_estate } }
			add = {
				desc = "UNION_NOBLES_OPINION_OF_SENIOR_PARTNER"
				value = "root.estate_opinion(estate_type:nobles_estate|scope:senior_partner_scope)"
				#The happier the estate is, the more impactful their opinion of the target country gets, though only a little bit
				if = { 		limit = { "root.estate_satisfaction:nobles_estate" > 0.75 } 	multiply = 1.3 }
				else_if = { limit = { "root.estate_satisfaction:nobles_estate" > 0.5 } 	multiply = 1.2 }
				else_if = { limit = { "root.estate_satisfaction:nobles_estate" > 0.3 } 	multiply = 1.1 }
				else = { 	multiply = 0.8 }
				multiply = { value = "root.estate_power(estate_type:nobles_estate)" add = 1 }
			}
		}
		# Burghers
		if = {
			limit = { root = { country_has_estate = estate_type:burghers_estate } }
			add = {
				desc = "UNION_BURGHERS_OPINION_OF_SENIOR_PARTNER"
				value = "root.estate_opinion(estate_type:burghers_estate|scope:senior_partner_scope)"
				#The happier the estate is, the more impactful their opinion of the target country gets, though only a little bit
				if = { 		limit = { "root.estate_satisfaction:burghers_estate" > 0.75 } 	multiply = 1.3 }
				else_if = { limit = { "root.estate_satisfaction:burghers_estate" > 0.5 } 	multiply = 1.2 }
				else_if = { limit = { "root.estate_satisfaction:burghers_estate" > 0.3 } 	multiply = 1.1 }
				else = { 	multiply = 0.8 }
				multiply = { value = "root.estate_power(estate_type:burghers_estate)" add = 1 }
			}
		}
		# Clergy
		if = {
			limit = { root = { country_has_estate = estate_type:clergy_estate } }
			add = {
				desc = "UNION_CLERGY_OPINION_OF_SENIOR_PARTNER"
				value = "root.estate_opinion(estate_type:clergy_estate|scope:senior_partner_scope)"
				#The happier the estate is, the more impactful their opinion of the target country gets, though only a little bit
				if = { 		limit = { "root.estate_satisfaction:clergy_estate" > 0.75 } 	multiply = 1.3 }
				else_if = { limit = { "root.estate_satisfaction:clergy_estate" > 0.5 } 	multiply = 1.2 }
				else_if = { limit = { "root.estate_satisfaction:clergy_estate" > 0.3 } 	multiply = 1.1 }
				else = { 	multiply = 0.8 }
				multiply = { value = "root.estate_power(estate_type:clergy_estate)" add = 1 }
			}
		}
	}
}