alliance = { 
	type = diplomacy
	relation_type = mutual
    uses_diplo_capacity = mutual
    block_when_at_war = yes
    break_on_war = yes
    break_on_becoming_subject = yes
    annulled_by_peace_treaty = yes
    disallow_war = yes
    military_access = yes
    fleet_basing_rights = yes
    lifts_fog_of_war = yes
    called_in_defensively = mutual
    called_in_offensively = mutual
    mutual_color = define:NMapColors|DIPLOMACY_ALLIANCE_COLOR
    category = {
        offer = CATEGORY_FRIENDLY_ACTIONS
        cancellation = CATEGORY_HOSTILE_ACTIONS
    }

    relation_type_for_ai = friendly
	
	
	diplomatic_capacity_cost = alliance_upkeep_cost

    favors_to_first = {
        value = 1
        add = "scope:first.relative_military_strength(scope:second)"
        divide = 12
    }

    favors_to_second = {
        value = 1
        add = "scope:second.relative_military_strength(scope:first)"
        divide = 12
    }

    institution_spread_to_first = monthly_institution_spread_severe
    institution_spread_to_second = monthly_institution_spread_severe

	offer_enabled = {
        alliance_can_exist = yes
	}

	request_visible = no
	break_visible = no

    cancel_enabled = {
        scope:actor = {
            not = { is_fighting_war_together_with = scope:recipient }
        }
    }

    will_expire_trigger = {
        alliance_can_exist = no
    }

	offer_declined_effect = {
		scope:actor = {
			add_opinion = { target = scope:recipient modifier = opinion_decline_alliance }
		}
	}

    offer_effect = {
        #no need for guarantees with an alliance
        if = {
            limit = {
                scope:actor != scope:recipient
                scope:actor = {
                    giving_scripted_relation = {
                        type = relation_type:guarantee
                        target = scope:recipient
                    }
                }
            }
            scope:actor = {
                remove_relation = { 
                    first = scope:actor
                    second = scope:recipient
                    type = relation_type:guarantee
                }
            }
        }
        if = {
            limit = {
                scope:actor != scope:recipient
                scope:actor = {
                    receiving_scripted_relation = {
                        type = relation_type:guarantee
                        target = scope:recipient
                    }
                }
            }
            scope:actor = {
                remove_relation = { 
                    first = scope:recipient
                    second = scope:actor
                    type = relation_type:guarantee
                }
            }
        }
    }

    cancel_effect = {
        scope:actor = {
            add_truce_with = {
                target = scope:recipient
                mutual = yes
            }
        }
        scope:recipient = {
            add_opinion = {
                target = scope:actor
                modifier = opinion_broke_alliance
            }
        }
    }

    expire_effect = {
        #downgrade to guarantee
        if = {
            limit = {
                scope:actor = {
                    modifier:allowed_guarantee = yes
                    country_rank_level > scope:recipient.country_rank_level
                }
            }
            scope:actor = {
                create_relation = {
                    first = scope:actor
                    second = scope:recipient
                    type = relation_type:guarantee
                }
            }
        }
        else_if = {
            limit = {
                scope:recipient = {
                    modifier:allowed_guarantee = yes
                    country_rank_level > scope:actor.country_rank_level
                }
            }
            scope:actor = {
                create_relation = {
                    first = scope:recipient
                    second = scope:actor
                    type = relation_type:guarantee
                }
            }
        }
    }

    wants_to_give_diplo_chance = {
        actor_is_rival = -100
        actor_overlord_is_rival = -100
        base = -40
        #not_10_trust = -100
        trust_in_actor = 1
        positive_opinion = 0.25
        negative_opinion = -1
        border_distance = -0.05
        few_relations = 5
        same_court_language = 10
        royal_ties = 2
        strategic_interest = 1
        common_threat = 0.4
        relative_strength = 50
    }
    wants_to_give = {
        if = {
            #Actor needs to be close and relativly big
            limit = {
                scope:recipient = {
                    border_distance_to = {
                        country = scope:actor
                        value < 150
                    }
                    relative_strength = {
                        target = scope:actor
                        value < 0.60
                    }
                }
            }
            add = {
                desc = "NEEDS_ALLIES_AGAINST_STRONG_RIVALS_AND_NEIGHBOURS"
                # Check if the country needs allies at all
                value = scope:recipient.country_needs_allies_value
                max = 25
                min = 0
            }
        }
        scope:actor = {
            add = {
                desc = "COALITION_GRADE_ANTAGONISM_TOWARDS_THEM"
                value = {
                    every_country_with_coalition_grade_antagonism_against_us = {
                        limit = {
                            not = { is_subject_or_below_of = scope:actor }
                        }
                        add = {
                            value = military_strength
                        }
                    }
                    divide = military_strength
                    multiply = 10
                }
            }
        }
        if = {
            limit = {
                scope:actor = {
                    any_current_war = {
                        NOT = {
                            is_on_same_side = {
                                country = scope:actor
                                target = scope:recipient
                            }
                        }
                    }
                }
            }
            add = {
                desc = "ACTOR_IS_IN_DIFFERENT_WARS"
                value = -100
            }
        }

        if = {
            limit = {
                "scope:recipient.opinion(scope:actor)" < 175
                "scope:recipient.conquer_desire(scope:actor)" > 20
                scope:recipient = {
                    is_neighbor_of = scope:actor
                }
            }
            add = {
                desc = "RECIPIENTS_DESIRES_ACTORS_LOCATIONS"
                value = "scope:recipient.conquer_desire(scope:actor)"
                multiply = -1
            }
        }

        if = {
            limit = {
                scope:recipient.num_relations_above_limit > 0
            }
            add = {
                desc = "DIPLOREASON_MAX_RELATIONS"
                value = scope:recipient.num_relations_above_limit           
                multiply = -20
                add = -40
            }
        }

        add = {
            desc = "RECIPIENT_WOULD_NEED_TO_PAY_FOR_DIPLOMACY"
            value = scope:recipient.diplomatic_capacity_without_maintenance
            subtract = scope:recipient.used_diplomatic_capacity
            subtract = "scope:recipient.diplomatic_capacity_of_new_relation(scope:actor|scope:scripted_relation_type)"     
            max = 0
            multiply = 25
        }
    }

    wants_to_keep_diplo_chance = {
        recipient_is_rival = -100
        recipient_overlord_is_rival = -100
        base = 20
        trust_in_recipient = 1
        border_distance = -0.05
        same_court_language = 10
        royal_ties = 2
        strategic_interest = 1
        common_threat = 0.4
    }
    wants_to_keep = {
        add = {
            value = "scope:actor.opinion(scope:recipient)"
            max = 0
        }
        add = {
            value = "scope:actor.opinion(scope:recipient)"
            multiply = 0.25
            min = 0
        }
        if = {
            limit = {
                scope:actor.num_relations_above_limit > 0
            }
            add = {
                value = scope:actor.num_relations_above_limit           
                multiply = -20
                add = -40
            }
        }

        add = {
            value = "scope:actor.conquer_desire(scope:recipient)"
            multiply = -1
        }

        if = {
            limit = {
                "scope:actor.opinion(scope:recipient)" < 175
                "scope:actor.conquer_desire(scope:recipient)" > 20
                scope:actor = {
                    is_neighbor_of = scope:recipient
                    NOT = {
                        wants_to_subjugate = scope:recipient
                    }
                    
                }
            }
            add = {
                desc = "ACTOR_DESIRES_RECIPIENTS_LOCATIONS"
                value = "scope:actor.conquer_desire(scope:recipient)"
                multiply = -1
            }
        }

        add = {
            value = "scope:actor.relative_strength(scope:recipient)"
            multiply = 2
            add = -1
            multiply = 50
        }

        if = {
            #Recipient needs to be close and relativly big
            limit = {
                scope:actor = {
                    border_distance_to = {
                        country = scope:recipient
                        value < 150
                    }
                    relative_strength = {
                        target = scope:recipient
                        value < 0.60
                    }
                }
            }
            add = {
                desc = "NEEDS_ALLIES_AGAINST_STRONG_RIVALS_AND_NEIGHBOURS"
                # Check if the country needs allies at all
                value = scope:actor.country_needs_allies_value
                max = 25
                min = 0
            }
        }
        scope:recipient = {
            add = {
                desc = "COALITION_GRADE_ANTAGONISM_TOWARDS_THEM"
                value = {
                    every_country_with_coalition_grade_antagonism_against_us = {                    
                        limit = {
                            not = { is_subject_or_below_of = scope:recipient }
                        }
                        subtract = {
                            value = military_strength
                        }
                    }
                    divide = military_strength
                    multiply = 10
                }
            }
        }
        add = {
            value = scope:actor.diplomatic_capacity_without_maintenance
            subtract = scope:actor.used_diplomatic_capacity  
            max = 0
            multiply = 25
        }
    }
}	
