excommunicate_resolution = {

	international_organization_type = catholic_church


	potential = {
		papacy_active = yes
	}

	allow = {
		scope:actor ?= {
			is_member_of_international_organization = international_organization:catholic_church
		}
		excommunicate_allow_trigger = yes
		religion:catholic = {
			modifier:curia_actions_blocked = no
		}
		international_organization:catholic_church = {
			modifier:excommunication_disabled = no
		}
	}
	
	votes = {
		add = {
			desc = "[cardinal_s|e]"
			value = scope:actor.num_cardinals
		}
	}

	can_vote = {
		international_organization:catholic_church = {
			country_has_special_status = {
				type = special_status:curia
				country = scope:actor
			}
		}
	}

	proposal_price = price:propose_curia_action

	months = 6

	select_trigger = {
		looking_for_a = international_organization
		target_flag = recipient
		name = "choose_international_organization"
		column = {
			data = name
		}
		visible = {
			international_organization_type = international_organization_type:catholic_church
			#no actor = this is just the general "is the vote allowed"
			trigger_if = {
				limit = {
					exists = scope:actor
				}
				country_has_special_status = {
					type = special_status:curia
					country = scope:actor
				}
			}
		}
		enabled = {
		}
	}

	select_trigger = {
		looking_for_a = country
		target_flag = target
		name = "excommunicate_select_country"
		none_available_msg_key = "excommunicate_resolution_no_countries"
		column = {
			data = name
		}
		column = {
			data = population
		}
		visible = {
			excommunicate_target_trigger = yes
			scope:recipient = {
				or = {
					not = { resolution_is_active = resolution:excommunicate_resolution }
					"active_resolution(resolution:excommunicate_resolution)" ?= {
						"resolution_target(target)" = root
						or = {
							trigger_if = {
								limit = {
									exists = scope:proposer
								}
								scope:recipient = {
									has_variable = excommunication_target
									var:excommunication_target = root
								}
								#already proposed, so valid
								always = yes
							}
							trigger_else = {
								"resolution_target(target)" = {
									not = { this = root }
								}
							}
						}
					}
				}
			}
			c:PAP = { opinion = { target = root  value < 0 } }
		}
	}

	select_trigger = {
		looking_for_a = boolean
		target_flag = vote
		name = "select_vote"
		column = {
			data = name
		}
		visible = {
		}
		enabled = {
			trigger_if = {
				limit = {
					this = no
				}
				#can't select "no" when proposing something
				scope:recipient = {
					resolution_is_active = resolution:excommunicate_resolution
				}
			}
			trigger_else = {
				always = yes
			}
		}
	}

	propose_effect = {
		custom_tooltip = {
			text = "propose_excommunicate_tt"
			if = {
				limit = {
					exists = scope:target
				}
				scope:target = {
					add_opinion = {
						target = scope:proposer
						modifier = opinion_tried_to_excommunicate_us
					}
				}
				scope:recipient = {
					set_variable = {
						name = excommunication_target
						value = scope:target
					}
				}
			}
		}
	}

	effect = {
		if = {
			limit = {
				exists = scope:target
			}
			scope:target = {
				excommunicate_effect = yes
			}
			if = {
				limit = { exists = scope:recipient }
				scope:recipient = {
					remove_variable = excommunication_target
				}
			}
		}
		else = {
			custom_tooltip = cc_excommunicate_target_tt
		}
	}
	
	reject_effect = {
		scope:proposer = {
			add_prestige = prestige_extreme_penalty
		}
		if = {
			limit = { exists = scope:recipient }
			scope:recipient = {
				remove_variable = excommunication_target
			}
		}
	}

	ai_will_do = {
		if = {
			limit = {
				exists = scope:actor
				exists = scope:target
				exists = scope:vote
			}
			scope:actor = {
				if = {
					limit = { scope:vote = no }
					if = {
						limit = { NOT = { this = scope:target } }
						#Excommunicating enemies = good!
						if = {
							limit = { is_at_war_with = scope:target }
							add = {
								desc = "VOTE_WAR_WITH_COUNTRY"
								value = -100
							}
						}
						#do we like them?
						add = {
							desc = "VOTE_OPINION_OF_COUNTRY"
							value = "scope:actor.opinion(scope:target)"
							multiply = 0.1
						}
						#are they a threat to us?
						add = {
							desc = "VOTE_ANTAGONISM_OF_COUNTRY"
							value = "scope:actor.antagonism(scope:target)"
							multiply = -0.75
						}
						#friends don't excommunicate friends
						if = {
							limit = { is_allied_with = { target = scope:target } }
							add = {
								desc = "VOTE_ALLIED_WITH_COUNTRY"
								value = 1000
							}
						}
						#we shouldn't excommunicate our own ruler...
						if = {
							limit = { in_union_with = scope:target }
							add = {
								desc = "VOTE_UNION_WITH_COUNTRY"
								value = 1000
							}
						}
					}
					else = {
						#we also shouldn't excommunicate ourselves...
						add = {
							desc = "VOTE_IS_TARGET_COUNTRY"
							value = 1000
						}
					}
				}
				else = {
					if = {
						limit = { NOT = { this = scope:target } }
						#Excommunicating enemies = good!
						if = {
							limit = { is_at_war_with = scope:target }
							add = {
								desc = "VOTE_WAR_WITH_COUNTRY"
								value = 100
							}
						}
						#do we like them?
						add = {
							desc = "VOTE_OPINION_OF_COUNTRY"
							value = "scope:actor.opinion(scope:target)"
							multiply = -0.25
						}
						#are they a threat to us?
						add = {
							desc = "VOTE_ANTAGONISM_OF_COUNTRY"
							value = "scope:actor.antagonism(scope:target)"
							multiply = 0.5
						}
						#friends don't excommunicate friends
						if = {
							limit = { is_allied_with = { target = scope:target } }
							add = {
								desc = "VOTE_ALLIED_WITH_COUNTRY"
								value = -1000
							}
						}
						#we shouldn't excommunicate our own ruler...
						if = {
							limit = { in_union_with = scope:target }
							add = {
								desc = "VOTE_UNION_WITH_COUNTRY"
								value = -1000
							}
						}
					}
					else = {
						#we also shouldn't excommunicate ourselves...
						add = {
							desc = "VOTE_IS_TARGET_COUNTRY"
							value = -1000
						}
					}
				}
			}
		}
		#bias for the "no" vote, but only for votes, not for proposals.
		if = {
			limit = {
				not = { exists = scope:proposer }
			}
			if = {
				limit = {
					scope:vote = no
				}
				multiply = {
					desc = "BIAS_FOR_VOTE_AGAINST_IT"
					value = -1
				}
			}
		}
	}
	ai_proposer_risk = {
		value = "scope:actor.currency_utility(prestige|prestige_extreme_penalty)"
	}
}
