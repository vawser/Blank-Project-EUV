great_pestilence = {
	monthly_spawn_chance = {
		if = {
			limit = {
				#Any location in america has an owner of the old world
				continent:america = {
					any_location_in_continent = {
						population > 0
						owner_from_old_world = yes
					}
				}
			}
			#Has the situation spawned already?
			if = {
				#It has happened already
				limit = {
					situation:great_pestilence = {
						situation_is_active = no
						situation_has_ended = yes
					}
				}
				#It does not repeat anymore
				value = 0
			}
			else = {
				#It has not started or it is ongoing
				#If we can spawn we do
				value = 0.1
			}
		}
		else = {
			value = 0
		}
	}

	spawn = {
		#Has the Situation spawned already?
		if = {
			#It has ended already
			limit = {
				situation:great_pestilence = {
					situation_is_active = no
					situation_has_ended = yes
				}
			}
			#We never spawn again
			#Might be worth reviewing this for Oceania
		}
		else_if = {
			#It is ongoing
			limit = {
				situation:great_pestilence = {
					situation_is_active = yes
					situation_has_ended = no
				}
			}
			#We can spawn again in new colonies
			continent:america = {
				random_location_in_continent = {
					limit = {
						population > 0
						owner_from_old_world = yes
						"disease_resistance(scope:disease)" < 0.5
						#If we can't find an appropriate location we don't spawn
					}
					spawn_disease = {
						disease = scope:disease
						value = 1
						#save the outbreak created for later
						save_scope_as = outbreak
					}
				}
			}
		}
		#The situation has not started yet
		else = {
			continent:america = {
				random_location_in_continent = {
					limit = {
						population > 0
						owner_from_old_world = yes
						"disease_resistance(scope:disease)" < 0.5
						#If we can't find an appropriate location we don't spawn
					}
					spawn_disease = {
						disease = scope:disease
						value = 1
						#save the outbreak created for later
						save_scope_as = outbreak
					}

					if = {
						limit = {
							situation:great_pestilence = {
								situation_is_active = no
								situation_has_ended = no
							}
						}
						activate_situation = situation:great_pestilence
						#Add the outbreak to the situation to track it
						situation:great_pestilence = {
							set_variable = {
								name = original_outbreak
								value = scope:outbreak
							}
						}
					}
				}
			}
		}
	}

	#script value to get the R0 number of the disease, or
	#how many people one person will spread the disease to per interval
	r0 = {
		#base
		if = {
			limit = {
				location_rank ?= location_rank:rural_settlement
			}
			value = { 0 3 }
		}
		else_if = {
			limit = {
				location_rank ?= location_rank:town
			}
			value = {2 5 }
		}
		else = {
			value = { 5 10 }
		}
		#markets spread more person to person
		if = {
			limit = {
				OR = {
					has_building_with_at_least_one_level = market_village
					has_building_with_at_least_one_level = marketplace
					has_building_with_at_least_one_level = slave_market
					has_building_with_at_least_one_level = entrepot
					has_building_with_at_least_one_level = trading_hub
					has_building_with_at_least_one_level = stock_exchange
				}
			}
			multiply = 1.2
		}

		#stagnation reduces R0
		if = {
			limit = {
				OR = {
					disease_has_stagnated = scope:disease
					"disease_resistance(scope:disease)" > 0.5
				}
			}
			subtract = { 0.2 0.7 }
			#if low and we have stagnation, move to kill it off quickly
			if = {
				limit  = {
					disease_presence = {
						disease = scope:disease
						value <= 0.2
					}
				}
				subtract = 0.3
			}
		}

		if = {#Reduce the spread in difficult terrain locations
			limit = {
				num_roads = 0
				OR = {
					topography = mountains
					vegetation = desert
					vegetation = jungle
				}
			}
			multiply = 0.25
		}
		if = {#no spread outside of the Americas
			limit = {
				NOT = {continent = continent:america}
			}
			multiply = 0.0
		}
	}

	# script value for the minimum percentage there has to be in a location before it will start spreading
	# to new locations.
	#(root is the location, scope:disease is the disease,
	# scope:disease_outbreak is the specific outbreak,
	# scope:current_presence is the current disease presence in the location)
	location_infection_spread_threshold = {
		if = {#Reduce the spread in dificult terrain locations
			limit = {
				num_roads = 0
				OR = {
					topography = mountains
					vegetation = desert
					vegetation = jungle
				}
			}
			value = 0.85
		}
		else = {
			value = 0.60
		}
	}

	#script value for how long between spread calculations.
	#A lower number = possible faster spread, depending on the effect in spread.
	#Nothing in the scope, this will usually just be a number, but could be a random range
	calc_interval_days = { 4 16 }

	location_stagnation_chance = {
		#some locations will spread it much more easily than others. For this disease, rural places have much more distance between people so spread it less
		if = {
			limit = { location_rank ?= location_rank:rural_settlement }
			value = 0.1
		}
		else_if = {
			limit = {
				location_rank ?= location_rank:town
			}
			value = 0.08
		}
		else = {
			value = 0.01
		}

		if = {#Reduce the spread in dificult terrain locations
			limit = {
				num_roads = 0
				OR = {
					topography = mountains
					vegetation = desert
					vegetation = jungle
				}
			}
			multiply = 3
		}
		#if we've got a bit of resistance then stagnation chance will go up
		if = {
			limit = {
				"disease_resistance(scope:disease)" > 0.5
			}
			multiply = {
				value = "disease_resistance(scope:disease)"
				subtract = 0.5
				multiply = 6
			}
		}

		if = {
			limit = {
				"disease_resistance(scope:disease)" > 0.95
			}
			add = 0.1
		}
		if = {
			limit = {
				"disease_resistance(scope:disease)" > 0.98
			}
			add = 0.2
		}
		if = {#If the owner is protecting itself, increase change of stagnation
			limit = {
				is_ownable = yes
				has_owner = yes
				owner ?= {
					has_country_modifier = no_contact_with_outsiders
				}
			}
			add = 0.5
		}
		if = {#no spread outside of the Americas
			limit = {
				NOT = {continent = continent:america}
			}
			value = 1.0
		}
	}

	percentage_to_meet_their_fate_on_calc = {
		value = 0.10
	}

	#general bad effects on locations that have this
	location_modifier = {
		potential_trigger = {
			disease_presence = {
				disease = scope:disease
				value >= 0.2
			}
			NOT = {	disease_has_stagnated = scope:disease }
		}
		local_population_growth = -0.1
		local_forced_attrition = 5
		max_attrition = 10

		local_pop_promotion_speed_modifier = -2.0
		local_pop_demotion_speed_modifier = 2.0

		local_monthly_prosperity = -0.1
		local_monthly_control = -0.005

		local_monthly_development = -0.02
	}

	# The historians give it a mortality rate of 90%
	mortality_rate = { 0.75 0.9 }

	#script value for how likely it is that a character will die per calc interval (0..1)
	character_mortality_chance = {
		value = 0.04
		multiply = "disease_presence(scope:disease)"
	}

	##on_spread_to_country: event sent when the disease spreads to a country
	#(root is the country, scope:disease is the disease)
	on_spread_to_country = {
		trigger_event_non_silently = great_pestilence.1
	}

	map_color = {
		lerp = { #Red
			min_color = rgb { 248  180  194 }
			max_color = rgb { 61 0 0 }
			factor = "disease_presence(scope:disease)"
		}
	}
}