hide_from_black_death = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 40
	automation_tick = daily
	automation_tick_frequency = 7

	potential = {
		scope:actor ?= {
			NOT = { has_country_modifier = hiding_from_black_death }
		}
	}

	price = price:hide_from_black_death

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = {data = name}
		visible = {
			situation:black_death = this
			situation_is_active = yes
			scope:actor = {
				country_has_disease_outbreak = root.var:original_outbreak
			}
		}
	}

	effect = {
		scope:actor ?= {
			add_country_modifier = {
				modifier = hiding_from_black_death
				years = -1
				mode = add_and_extend
			}
		}
	}

	ai_will_do = {
		#this will be negative as it basically annoys your estates, so we need to bias against the advantage of not having characters killed off by black death
		#considering that includes your monarch, hiding really isn't a terrible option unless you've really got estate loyalty problems
		add = "scope:actor.add_static_modifier_utility(hiding_from_black_death)"
		add = {
			desc = "avoid characters killed off"
			value = 10
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}

stop_hide_from_black_death = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 120
	automation_tick = daily
	automation_tick_frequency = 7

	potential = {
		scope:actor ?= { has_country_modifier = hiding_from_black_death }
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = {data = name}
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			remove_country_modifier = hiding_from_black_death
		}
	}

	ai_will_do = {
		#this will be negative as it basically annoys your estates, so we need to bias against the advantage of not having characters killed off by black death
		#considering that includes your monarch, hiding really isn't a terrible option unless you've really got estate loyalty problems
		add = "scope:actor.add_static_modifier_utility(hiding_from_black_death)"
		add = 10
		multiply = -1
		#bias against doing anything
		subtract = 1
	}
}

isolate_cities_black_death = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 40
	automation_tick = daily
	automation_tick_frequency = 7

	potential = {
		scope:actor ?= {
			NOT = {
				any_owned_non_rural_location = {
					has_location_modifier = isolating_cities
				}
			}
			num_of_non_rural > 0
		}
	}

	allow = {
		scope:actor ?= {
			estate_satisfaction:burghers_estate > 0.75
			any_owned_non_rural_location = {
				disease_presence = {
					disease = disease:bubonic_plague
					value >= 0.2
				}
			}
		}
	}

	price = price:isolate_cities_black_death

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
			scope:actor = {
				country_has_disease_outbreak = root.var:original_outbreak
			}
		}
	}

	effect = {
		scope:actor ?= {
			add_estate_satisfaction = { 
				type = estate_type:burghers_estate
				value = estate_satisfaction_weak_penalty
			}
			custom_tooltip = {
				text = isolate_cities_effect_tt
				every_owned_non_rural_location = {
					add_location_modifier = {
						modifier = isolating_cities
						years = -1
						size = {
							value = {
								desc = game_concept_control
								value = local_control
								multiply = 0.85
								if = {
									limit = {
										scope:actor.num_of_non_rural > 4
									}
									divide = scope:actor.num_of_non_rural
									multiply = 4
								}
							}
						}
						mode = add
					}
				}
			}
		}
	}

	ai_will_do = {
		scope:actor ?= {
			add = "add_estate_satisfaction_utility(burghers_estate|-0.3)"
			every_owned_non_rural_location = {
				limit = {
					disease_presence = {
						disease = disease:bubonic_plague
						value >= 0.2
					}
				}
				add = {
					value = local_control
					multiply = -0.85
					save_temporary_value_as = modifier_scale
					value = "add_static_modifier_utility(isolating_cities|scope:modifier_scale)"
				}
			}
		}
	}
}

stop_isolate_cities_black_death = {
	type = situation
	ai_tick = daily
	ai_tick_frequency = 120
	automation_tick = daily
	automation_tick_frequency = 7

	potential = {
		scope:actor ?= {
			any_owned_non_rural_location = {
				has_location_modifier = isolating_cities
			}
		}
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			every_owned_non_rural_location = {
				limit = {
					has_location_modifier = isolating_cities
				}
				remove_location_modifier = isolating_cities
			}
		}
	}

	ai_will_do = {
		add = "scope:actor.add_static_modifier_utility(isolating_cities)"
		add = 10
		multiply = -1
		#bias against doing anything
		subtract = 1
	}
}

control_the_food_market = {
	type = situation
	ai_tick = daily
	ai_tick_frequency = 40
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = food_and_trade_actions

	potential = {
		scope:actor ?= {
			#It can be done as a preventive measure, so no need to already be infected
			NOT = { has_country_modifier = control_the_food_market }
		}
	}

	allow = {
		scope:actor ?= {
			NOT = { has_country_modifier = close_the_borders }
		}
	}

	price = price:control_the_food_market

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
			scope:actor = {
				country_has_disease_outbreak = root.var:original_outbreak
			}
		}
	}

	effect = {
		scope:actor ?= {
			add_country_modifier = { modifier = foodstuffs_exports_banned years = -1	mode = add_and_extend }
			add_country_modifier = { modifier = control_the_food_market years = -1	mode = add_and_extend }
		}
	}

	ai_will_do = {
		#this will be negative as it basically annoys your estates, so we need to bias against the advantage of reducing the trade happening
		#which will in turn reduce the speed of contagion
		add = "scope:actor.add_static_modifier_utility(foodstuffs_exports_banned)"
		add = "scope:actor.add_static_modifier_utility(control_the_food_market)"
		add = {
			desc = "reduce the amount of trade happening"
			value = 10
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}

stop_control_the_food_market = {
	type = situation
	ai_tick = daily
	ai_tick_frequency = 120
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = food_and_trade_actions

	potential = {
		scope:actor ?= {
			has_country_modifier = control_the_food_market
		}
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			remove_country_modifier = foodstuffs_exports_banned
			remove_country_modifier = control_the_food_market
		}
	}

	ai_will_do = {
		add = "scope:actor.add_static_modifier_utility(foodstuffs_exports_banned)"
		add = "scope:actor.add_static_modifier_utility(control_the_food_market)"
		add = 10
		multiply = -1
		#bias against doing anything
		subtract = 1
	}
}

close_the_borders = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 40
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = food_and_trade_actions

	potential = {
		scope:actor ?= {
			#It can be done as a preventive measure, so no need to already be infected
			NOT = { has_country_modifier = close_the_borders }
		}
	}

	allow = {
		scope:actor ?= {
			NOT = { has_country_modifier = control_the_food_market }
			any_neighbor_country = {
				country_has_disease = disease:bubonic_plague
			}
		}
	}

	price = price:close_the_borders

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			add_country_modifier = { modifier = close_the_borders years = -1	mode = add_and_extend }
		}
	}

	ai_will_do = {
		#this will be negative as it basically annoys your estates, so we need to bias against the advantage of removing trade happening
		#which will in turn reduce the speed of contagion
		add = "scope:actor.add_static_modifier_utility(close_the_borders)"
	}
}

stop_close_the_borders = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 120
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = food_and_trade_actions

	potential = {
		scope:actor ?= {
			has_country_modifier = close_the_borders
		}
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			remove_country_modifier = close_the_borders
		}
	}

	ai_will_do = {
		add = "scope:actor.add_static_modifier_utility(close_the_borders)"
		add = 10
		multiply = -1
		#bias against doing anything
		subtract = 1
	}
}

procure_remedies = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 40
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = bd_disease_control_actions

	potential = {
		scope:actor ?= {
			NOT = { has_country_modifier = procure_remedies }
		}
	}

	allow = {
		scope:actor ?= {
			NOT = { has_country_modifier = segregate_the_infected }
			NOT = { has_country_modifier = strict_quarantines }
		}
	}

	price = price:procure_remedies

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			OR = {
				situation:black_death = this
			}
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			add_country_modifier = { modifier = procure_remedies years = -1	mode = add_and_extend }
			if = {
				limit = {
					has_expensive_procure_remedies_goods = yes
				}
				add_country_modifier = {
					modifier = procure_remedies_cost
					years = -1
					mode = add_and_extend
					size = {
						add = {
							desc = "[income|e]"
							value = scope:actor.monthly_income_total
							multiply = 0.1
							min = 1
						}
					}
				}
			}
			else = {
				add_country_modifier = {
					modifier = procure_remedies_cost
					years = -1
					mode = add_and_extend
					size = {
						add = {
							desc = "[income|e]"
							value = scope:actor.monthly_income_total
							multiply = 0.05
							min = 1
						}
					}
				}
			}

			#Only added by the owners of the market
			if = {
				limit = {
					NOT = { religion.group = religion_group:muslim }
				}
				every_market_present_in_country = {
					add_temporary_demand = {
						type = demand:procure_remedies
						scale_with_pop = 0.002
						years = -1
					}
				}
			}
			else = {
				every_market_present_in_country = {
					add_temporary_demand = {
						type = demand:procure_remedies_no_liquor
						scale_with_pop = 0.002
						years = -1
					}
				}
			}
			add_stability = stability_mild_bonus
			add_government_power = government_power_weak_bonus
		}
	}

	ai_will_do = {
		#this will be too positive as it does not take into account the increase in demands

		# Replicate cost logic from the effect application
		if = {
			limit = {
				has_expensive_procure_remedies_goods = yes
			}

			if = {
				limit = {
					save_temporary_scope_value_as = {
						name = cost_mult_to_use
						value = {
							value = 0.1
							multiply = scope:actor.monthly_income_total
							min = 1
						}
					}
				}
			}
		}
		else = {
			if = {
				limit = {
					save_temporary_scope_value_as = {
						name = cost_mult_to_use
						value = {
							value = 0.05
							multiply = scope:actor.monthly_income_total
							min = 1
						}
					}
				}
			}
		}
		
		# Script workaround to resave the value into a scope value such that it works in tooltips

		add = "scope:actor.add_static_modifier_utility(procure_remedies_cost|scope:cost_mult_to_use)"
		add = "scope:actor.add_static_modifier_utility(procure_remedies)"
		
		#add if there are affected locations
		add = {
			desc = "present plague"
			if = {
				limit = {
					scope:actor = {
						country_has_disease = disease:bubonic_plague
					}
				}
				value = 50
			}
		}
		add = {
			desc = "increased demands"
			value = -10
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}

stop_procure_remedies = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 120
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = bd_disease_control_actions

	potential = {
		scope:actor ?= {
			has_country_modifier = procure_remedies
		}
	}

	price = price:stop_procure_remedies

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = {
			data = name
		}
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			remove_country_modifier = procure_remedies
			remove_country_modifier = procure_remedies_cost
			every_market_present_in_country = {
				if = {
					limit = { has_temporary_demand = demand:procure_remedies }
					remove_temporary_demand = demand:procure_remedies
				}
				if = {
					limit = { has_temporary_demand = demand:procure_remedies_no_liquor }
					remove_temporary_demand = demand:procure_remedies_no_liquor
				}
			}
		}
	}

	ai_will_do = {
		add = "scope:actor.add_static_modifier_utility(procure_remedies)"
		add = "scope:actor.add_static_modifier_utility(procure_remedies_cost)"
		#add if there are affected locations
		add = {
			if = {
				limit = {
					scope:actor = {
						country_has_disease = disease:bubonic_plague
					}
				}
				value = 50
			}
		}
		add = {
			desc = "increased demands"
			value = -10
		}
		multiply = -1
		#bias against doing anything
		subtract = 1
	}
}

segregate_the_infected = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 40
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = bd_disease_control_actions

	potential = {
		scope:actor ?= {
			country_has_disease = disease:bubonic_plague
			NOT = { has_country_modifier = segregate_the_infected }
		}
	}

	allow = {
		scope:actor ?= {
			NOT = { has_country_modifier = strict_quarantines }
			NOT = { has_country_modifier = procure_remedies }
		}
	}

	price = price:segregate_the_infected

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			add_country_modifier = { modifier = segregate_the_infected years = -1	mode = add_and_extend }
		}
	}

	ai_will_do = {
		add = "scope:actor.add_static_modifier_utility(segregate_the_infected)"
	}
}

stop_segregate_the_infected = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 120
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = bd_disease_control_actions
	potential = {
		scope:actor ?= {
			can_see_situation = situation:black_death
			has_country_modifier = segregate_the_infected
		}
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			remove_country_modifier = segregate_the_infected
		}
	}

	ai_will_do = {
		add = "scope:actor.add_static_modifier_utility(segregate_the_infected)"
		#add if there are affected locations
		add = {
			if = {
				limit = {
					scope:actor = {
						country_has_disease = disease:bubonic_plague
					}
				}
				value = 50
			}
		}
		multiply = -1
		#bias against doing anything
		subtract = 1
	}
}

strict_quarantines = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 40
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = bd_disease_control_actions

	potential = {
		scope:actor ?= {
			NOT = { has_country_modifier = strict_quarantines }
		}
	}

	allow = {
		scope:actor ?= {
			NOT = { has_country_modifier = segregate_the_infected }
			NOT = { has_country_modifier = procure_remedies }
		}
	}

	price = price:strict_quarantines

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = {
			data = name
		}
		visible = {
			situation:black_death = this
			situation_is_active = yes
			scope:actor = {
				country_has_disease_outbreak = root.var:original_outbreak
			}
		}
	}

	effect = {
		scope:actor ?= {
			add_country_modifier = {
				modifier = strict_quarantines
				years = -1
				mode = add_and_extend
			}
		}
	}

	ai_will_do = {
		#this will be negative as it basically annoys your estates
		#so we need to take into account the new ability to build a new building
		add = "scope:actor.add_static_modifier_utility(strict_quarantines)"

		#add if we have money to build any pest houses (we probably won't)
		add = {
			desc = "Available profit margin to build pest houses"
			value = {
				value = scope:actor.monthly_balance
				divide = scope:actor.monthly_income_total
				multiply = 20 # <- score for building pest houses with our profit margin
			} 
		}
	}
}

stop_strict_quarantines = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 120
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = bd_disease_control_actions

	potential = {
		scope:actor ?= {
			has_country_modifier = strict_quarantines
		}
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			remove_country_modifier = strict_quarantines
			every_owned_location = {
				limit = {
					has_building = building_type:pest_house
				}
				destroy_building = "building(building_type:pest_house|scope:actor)"
			}
		}
	}

	ai_will_do = {
		add = "scope:actor.add_static_modifier_utility(strict_quarantines)"
		add = {
			desc = "able to build pest houses"
			value = 15
		}
		#add if there are affected locations
		add = {
			if = {
				limit = {
					scope:actor = {
						country_has_disease = disease:bubonic_plague
					}
				}
				value = 50
			}
		}
		multiply = -1
		#bias against doing anything
		subtract = 1
	}
}

sponsor_sin_forgiveness = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 40
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = bd_social_actions

	potential = {
		scope:actor ?= {
			NOT = { has_country_modifier = sponsor_sin_forgiveness_bonus }
		}
	}

	allow = {
		scope:actor ?= {
			NOT = { has_country_modifier = blame_the_minorities }
		}
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = {data = name}
		visible = {
			situation:black_death = this
			situation_is_active = yes
			scope:actor = {
				country_has_disease_outbreak = root.var:original_outbreak
			}
		}
	}

	effect = {
		scope:actor ?= {
			add_country_modifier = { modifier = sponsor_sin_forgiveness_bonus years = -1	mode = add_and_extend }
			add_country_modifier = {
				modifier = sponsor_sin_forgiveness_cost
				years = -1
				mode = add_and_extend
				size = {
					value = 1
					multiply = {
						desc = "[income|e]"
						value = this.monthly_income_total
					}
					multiply = 0.1
				}
			}
			add_stability = stability_severe_bonus
		}
	}

	ai_will_do = {		
		# Calculate Cost
		if = {
			limit = {
				save_temporary_scope_value_as = {
					name = monthly_cost
					value = {
						value = scope:actor.monthly_income_total
						multiply = 0.1
					}
				}
			}
		}

		add = {
			desc = "stability effect"
			value = "scope:actor.currency_utility(stability|stability_severe_bonus)"
		}

		add = {
			desc = "Ongoing modifier"
			value = "scope:actor.add_static_modifier_utility(sponsor_sin_forgiveness_bonus)"
		}

		# Utility from upscaled cost
		add = {
			desc = "Cost"
			value = "scope:actor.add_static_modifier_utility(sponsor_sin_forgiveness_cost|scope:monthly_cost)"
		}
	}
}

stop_sponsor_sin_forgiveness = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 120
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = bd_social_actions
	potential = {
		scope:actor ?= {
			has_country_modifier = sponsor_sin_forgiveness_bonus
		}
	}

	price = price:stop_sponsor_sin_forgiveness

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			remove_country_modifier = sponsor_sin_forgiveness_bonus
			remove_country_modifier = sponsor_sin_forgiveness_cost
		}
	}

	ai_will_do = {
		add = "scope:actor.add_static_modifier_utility(sponsor_sin_forgiveness_bonus)"
		add = "scope:actor.add_static_modifier_utility(sponsor_sin_forgiveness_cost)"
		#add if there are affected locations
		add = {
			if = {
				limit = {
					scope:actor = {
						country_has_disease = disease:bubonic_plague
					}
				}
				value = 50
			}
		}
		multiply = -1
		#bias against doing anything
		subtract = 1
	}
}

blame_the_minorities = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 40
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = bd_social_actions

	potential = {
		scope:actor ?= {
			NOT = { has_country_modifier = blame_the_minorities }
		}
	}

	allow = {
		scope:actor ?= {
			NOT = { has_country_modifier = sponsor_sin_forgiveness_bonus }
		}
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
			scope:actor = {
				country_has_disease_outbreak = root.var:original_outbreak
			}
		}
	}

	effect = {
		scope:actor ?= {
			add_country_modifier = { modifier = blame_the_minorities years = -1	mode = add_and_extend }
			add_stability = stability_mild_bonus
		}
	}

	ai_will_do = {
		add = "scope:actor.add_static_modifier_utility(blame_the_minorities)"
		#add if there are affected locations
		add = {
			if = {
				limit = {
					scope:actor = {
						country_has_disease = disease:bubonic_plague
					}
				}
				value = 50
			}
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}

stop_blame_the_minorities = {
	type = situation

	ai_tick = daily
	ai_tick_frequency = 120
	automation_tick = daily
	automation_tick_frequency = 7

	exclusive_group = bd_social_actions

	potential = {
		scope:actor ?= {
			has_country_modifier = blame_the_minorities
		}
	}

	price = price:stop_blame_the_minorities

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:black_death = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			remove_country_modifier = blame_the_minorities
		}
	}

	ai_will_do = {
		add = "scope:actor.add_static_modifier_utility(blame_the_minorities)"
		#add if there are affected locations
		add = {
			if = {
				limit = {
					scope:actor = {
						country_has_disease = disease:bubonic_plague
					}
				}
				value = 50
			}
		}
		multiply = -1
		#bias against doing anything
		subtract = 1
	}
}