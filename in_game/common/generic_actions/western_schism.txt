schism_show_support_for_one_pope = {
	type = situation
	show_message = no
	potential = {
		scope:actor = {
			religion = religion:catholic
			is_member_of_international_organization = international_organization:catholic_church
			num_cardinals = 0
			NOT = {
				tag = PAP
			}
		}
	}

	allow = {
		is_situation_active = situation:western_schism
	}
	
	ai_tick = monthly
	ai_tick_frequency = 4

	automation_tick = never
	automation_tick_frequency = 12
	price = price:western_schism_ri_actions_price

	cooldown = {
		type = schism_show_support_for_one_pope
		years = 4
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = {
			data = name
		}
		visible = {
			situation:western_schism = this
			situation_is_active = yes
		}
	}

	select_trigger = {
		looking_for_a = country
		target_flag = target
		name = "choose_candidate_to_support"
		none_available_msg_key = "no_valid_countries"
		column = { data = name }
		allow_self = no
		visible = {
			OR = {
				tag = PAP
				situation:western_schism = {
					has_variable = schism_opponent_country
					var:schism_opponent_country = root
				}
			}
		}
	}
	effect = {
		if = {
			limit = {
				exists = scope:target
			}
			scope:target = {
				add_opinion = {
					target = scope:actor
					modifier = declared_oboedientia
				}
			}
			international_organization:catholic_church = {
				"active_resolution(resolution:western_schism_resolution)" = {
					save_temporary_scope_as = resolution
					scope:target = {
						save_temporary_scope_as = voter
						scope:resolution = {
							"vote_in_active_resolution(scope:voter)" ?= {
								change_variable = {
									name = western_schism_vote_weight
									add = {
										value = "scope:voter.num_cardinals"
										multiply = 0.5
									}
								}
							}
						}
					}
				}
			}
		}
		else = {
			custom_tooltip = ws_schism_show_support_for_one_pope_tt
		}
	}

	ai_will_do = {
		add = -20
		if = {
			limit = {
				exists = scope:target
				situation:western_schism = {
					has_variable = schism_opponent_country
				}
				country_exists = situation:western_schism.var:schism_opponent_country
			}
			if = {
				limit = {
					scope:target = c:PAP
				}
				c:PAP = {
					add = { value = scope:actor.this_opinion_of_prev }
				}
				situation:western_schism.var:schism_opponent_country = {
					subtract = { value = scope:actor.this_opinion_of_prev }
				}
			}
			else = {
				c:PAP = {
					subtract = { value = scope:actor.this_opinion_of_prev }
				}
				situation:western_schism.var:schism_opponent_country = {
					add = { value = scope:actor.this_opinion_of_prev }
				}
			}
			if = {
				limit = { 
					scope:target = { modifier:diplomatic_reputation != 0 }
				}
				add = {
					value = scope:target.modifier:diplomatic_reputation
					multiply = 5
				}
			}
		}
	}
}

schism_show_unity_of_faith = {
	type = situation
	show_message = no
	potential = {
		scope:actor = {
			religion = religion:catholic
			is_member_of_international_organization = international_organization:catholic_church
		}
	}

	allow = {
		is_situation_active = situation:western_schism
		scope:actor = {
			any_province = { 
				NOT = { has_province_modifier = ws_show_unity_of_faith }
			}
		}
	}
	
	ai_tick = monthly
	ai_tick_frequency = 6

	automation_tick = never
	automation_tick_frequency = 12
	price = price:western_schism_gold_actions_price

	cooldown = {
		type = schism_show_unity_of_faith
		years = 2
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = {
			data = name
		}
		visible = {
			situation:western_schism = this
			situation_is_active = yes
		}
	}

	select_trigger = {
		looking_for_a = province
		target_flag = target
		source = actor
		name = "choose_province"
		none_available_msg_key = "no_provinces_available"
		column = { data = name }
		column = { data = population }
		visible = {
			NOT = { has_province_modifier = ws_show_unity_of_faith }
			NOT = {
				any_location_in_province = {
					is_ownable = yes
					owner = scope:actor
					NOT = { controller = scope:actor }
				}
			}
		}
	}
	effect = {
		if = {
			limit = {
				exists = scope:target
			}
			scope:target = {
				add_province_modifier = {
					modifier = ws_show_unity_of_faith
					mode = replace
					years = 5
				}
			}
		}
		else = {
			custom_tooltip = ws_show_unity_of_faith_tt
		}
		scope:actor = {
			change_societal_value = {
				type = spiritualist_vs_humanist
				value = societal_value_move_to_left
			}
		}
	}

	ai_will_do = {
		add = -20
		add = {
			if = {
				limit = {
					exists = scope:target
					scope:actor.modifier:bias_for_tolerant_policies < 0
				}
				add = {
					value = {
						value = "scope:actor.modifier:bias_for_tolerant_policies"
						multiply = -1
					}
				}
			}
		}
	}
}

schism_demand_support_from_one_pope = {
	type = situation
	show_message = no
	potential = {
		scope:actor = {
			religion = religion:catholic
			is_member_of_international_organization = international_organization:catholic_church
			num_cardinals = 0
			NOT = {
				tag = PAP
			}
		}
	}

	allow = {
		is_situation_active = situation:western_schism
		situation:western_schism = {
			days_since_situation_start > 365
		}
	}
	
	ai_tick = monthly
	ai_tick_frequency = 6

	automation_tick = never
	automation_tick_frequency = 12
	price = price:western_schism_ri_actions_price

	cooldown = {
		type = schism_demand_support_from_one_pope
		years = 6
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = {
			data = name
		}
		visible = {
			situation:western_schism = this
			situation_is_active = yes
		}
	}

	select_trigger = {
		looking_for_a = country
		target_flag = target
		name = "choose_candidate_for_demands"
		none_available_msg_key = "no_valid_countries"
		column = { data = name }
		allow_self = no
		visible = {
			OR = {
				tag = PAP
				situation:western_schism = {
					has_variable = schism_opponent_country
					var:schism_opponent_country = root
				}
			}
		}
	}
	effect = {
		if = {
			limit = {
				exists = scope:target
			}
			scope:actor = {
				if = {
					limit = {
						scope:target = {
							opinion = {
								target = scope:actor
								value >= 50
							}
						}
					}
					trigger_event_non_silently = western_schism.1001
				}
				else = {
					trigger_event_non_silently = western_schism.1002
				}
			}
		}
		else = {
			custom_tooltip = western_schism_action_event_tt
		}
	}

	ai_will_do = {
		if = {
			limit = {
				exists = scope:target
				situation:western_schism = {
					has_variable = schism_opponent_country
				}
				exists = situation:western_schism.var:schism_opponent_country
			}
			save_temporary_value_as = {
				name = opinion_of_pope_vs_anti_pope
				value = "scope:actor.opinion_difference_between(c:PAP|situation:western_schism.var:schism_opponent_country)"
			}
			if = {
				limit = { exists = scope:opinion_of_pope_vs_anti_pope }
				value = scope:opinion_of_pope_vs_anti_pope
				if = {
					limit = {
						scope:target = situation:western_schism.var:schism_opponent_country
						scope:opinion_of_pope_vs_anti_pope < -20
					}
					multiply = -1
				}
				else_if = {
					limit = {
						scope:target = c:PAP
						scope:opinion_of_pope_vs_anti_pope > 20
					}
					multiply = 1
				}
			}
		}
		else = {
			value = 0
		}
	}
}