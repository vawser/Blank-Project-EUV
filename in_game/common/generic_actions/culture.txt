add_accepted_culture = {
	type = owncountry

	potential = {
	}

	allow = {
		trigger_if = {
			limit = {
				exists = scope:target
				exists = scope:actor
			}
			scope:actor = {
				culture_population_in_country = {
					culture = scope:target
					value > 0
				}
			}
		}
	}

	ai_tick = never
	ai_tick_frequency = 12

	automation_tick = monthly
	automation_tick_frequency = 1
	player_automated_category = cultureacceptance
	
	price = price:add_accepted_culture

	select_trigger = {
		looking_for_a = culture
		target_flag = target
		source = actor
		source_flags = only_tolerated

		name = "add_accepted_culture_select_culture"
		none_available_msg_key = "add_accepted_culture_no_cultures"
		column = {
			data = name
		}
		visible = {
			not = { is_accepted_in = scope:actor }
		}
		enabled = {
			is_tolerated_in = scope:actor
			NOT = {
				scope:actor.culture = this
			}
			scope:actor = {
				OR = {
					culture_percentage_in_country = {
						culture = root
						value >= 0.025
					}
					
					culture_population_in_country = {
						culture = root
						value >= 1000
					}
				}
			}
		}
	}

	effect = {
		scope:actor = {
			if = {
				limit = {
					exists = scope:target
				}
				add_accepted_culture = scope:target
			}
		}
	}

	ai_will_do = {
		# handled in code
	}
}

remove_accepted_culture = {
	type = owncountry

	potential = {
	}

	allow = {
	}

	ai_tick = monthly
	ai_tick_frequency = 12

	automation_tick = monthly
	automation_tick_frequency = 1
	player_automated_category = cultureacceptance
	
	price = price:remove_accepted_culture
	price_modifier = {
		if = {
			limit = { 
				exists = scope:target 
			}
			add = {
				desc = "SORT_CULTURE_POPULATION"
				value = "scope:actor.culture_percentage_in_country(scope:target)"
				multiply = 100
			}
		}
	}

	select_trigger = {
		looking_for_a = culture
		source = actor
		target_flag = target
		source_flags = only_accepted
		name = "remove_accepted_culture_select_culture"
		none_available_msg_key = "remove_accepted_culture_no_cultures"
		column = {
			data = name
		}
	}

	effect = {
		scope:actor = {
			if = {
				limit = {
					exists = scope:target
				}
				remove_accepted_culture = scope:target
				custom_tooltip = {
					text = lose_75_pop_satisfaction_ct
					every_pop = {
						limit = {
							owner = scope:actor
							culture = scope:target
						}
						add_pop_satisfaction = pop_satisfaction_ultimate_penalty
					}
				}
			}
		}
	}
	
	ai_will_do = {
		add = {
			desc = "willingness"
			value = 500
		}

		subtract = {
			desc = "less accepted pops"
			scope:actor = {
				value = 100
				multiply = "culture_percentage_in_country(scope:target)"
			}
		}

		# Remove cultures that are below 7.5% if we are at peace and have 50 stability and over our cap
		if = {
			limit = {
				scope:actor = {
					OR = {
						used_cultures_capacity <= modifier:cultures_capacity
						stability < 50
						at_war = yes
					}
				}
			}
			multiply = 0
		}

		if = {
			limit = {
				scope:actor = {
					"culture_percentage_in_country(scope:target)" > 0.075
				}
			}
			multiply = 0
		}
	}
}

change_primary_culture = {
	type = owncountry

	potential = {
	}

	allow = {
		 scope:actor = {
			is_colonial_subject = no
		 }
	}

	ai_tick = monthly
	ai_tick_frequency = 12

	automation_tick = monthly
	automation_tick_frequency = 1
	player_automated_category = cultureacceptance
	
	price = price:change_primary_culture

	cooldown = {
		type = convert_culture
		years = 10
	}

	select_trigger = {
		looking_for_a = culture
		source = actor
		target_flag = target
		name = "change_culture_select_culture"
		none_available_msg_key = "change_primary_culture_no_cultures"
		column = {
			data = name
		}
		visible = {
			trigger_if = {
				limit = {
					has_game_rule = dynamic_culture
				}
				always = yes
			}
			trigger_else_if = {
				limit = {
					has_game_rule = culture_group_only
				}
				scope:actor = {
					culture = {
						any_culture_group = {
							root = {
								has_culture_group = prev
							}
						}
					}
				}
			}
			trigger_else_if = {
				limit = {
					has_game_rule = culture_present_in_country
				}
				scope:actor = {
					culture_population_in_country = {
						culture = root
						value > 0
					}
				}
			}
			trigger_else = {
				always = yes
			}
		}
		enabled = {
			trigger_if = {
				limit = {
					has_game_rule = dynamic_culture
				}
				scope:actor = {
					has_accepted_culture = root
					not = { culture = root }
					OR = {
						dominant_culture ?= root
						ruler ?= { culture = root }
						dominant_upper_class_culture ?= root
					}
				}
			}
			can_change_primary_culture = {
				country = scope:actor
				culture = root
			}
		}
	}

	effect = {
		scope:actor = {
			if = {
				limit = {
					exists = scope:target
				}
				culture = {
					save_scope_as = old_culture
				}
				change_culture = scope:target
				add_accepted_culture = scope:old_culture
			}
		}
	}
	
	ai_will_do = {
		add = {
			desc = "inertia"
			value = -1
		}

		if = {
			limit = {
				scope:actor = {
					at_war = yes
				}
			}
			multiply = 0
		}

		# change our primiary culture if it is 10% bigger than our current one and we are at peace
		if = {
			limit = {
				scope:actor = {
					"culture_percentage_in_country(scope:target)" > { value = "culture_percentage_in_country(scope:actor.culture)" add = 0.1 }
				}
			}
			add = 1000
		}

		subtract = {
			desc = "less accepted pops"
			scope:actor = {
				value = 100
				multiply = "culture_percentage_in_country(scope:target)"
			}
		}
		
		
		if = {
			limit = {
				scope:actor = {
					ruler ?= { culture = scope:actor.culture }
				}
			}
			multiply = 0
		}
	}
}


add_tolerated_culture = {
	type = owncountry

	potential = {
	}

	allow = {
		trigger_if = {
			limit = {
				exists = scope:target
				exists = scope:actor
			}
			scope:actor = {
				culture_population_in_country = {
					culture = scope:target
					value > 0
				}
			}
		}
	}

	ai_tick = never
	ai_tick_frequency = 12

	automation_tick = monthly
	automation_tick_frequency = 1
	player_automated_category = cultureacceptance
	
	price = price:add_tolerated_culture

	select_trigger = {
		looking_for_a = culture
		#for the AI we have an optimisation to only look through cultures that are present. Human can look at all...but will have some disabled
		source_ai_override = actor
		target_flag = target
		source_flags_ai_override = include_any_present
		name = "add_tolerated_culture_select_culture"
		none_available_msg_key = "add_tolerated_culture_no_cultures"
		column = {
			data = name
		}
		enabled = {
			NOR = {
				scope:actor.culture = this
				is_tolerated_in = scope:actor
				is_accepted_in = scope:actor
			}
			scope:actor = {
				OR = {
					culture_percentage_in_country = {
						culture = root
						value >= 0.01
					}
				
				
					culture_population_in_country = {
						culture = root
						value >= 1000
					}
				}
			}
		}
	}

	effect = {
		scope:actor = {
			if = {
				limit = {
					exists = scope:target
				}
				add_tolerated_culture = scope:target
			}
		}
	}
	
	ai_will_do = {
		# handled in code
	}
}

remove_tolerated_culture = {
	type = owncountry

	potential = {
	}

	allow = {
	}

	ai_tick = monthly
	ai_tick_frequency = 12

	automation_tick = monthly
	automation_tick_frequency = 1
	player_automated_category = cultureacceptance
	
	price = price:remove_tolerated_culture
	price_modifier = {
		if = {
			limit = { 
				exists = scope:target 
			}
			add = {
				desc = "SORT_CULTURE_POPULATION"
				value = "scope:actor.culture_percentage_in_country(scope:target)"
				multiply = 100
			}
		}
	}

	select_trigger = {
		looking_for_a = culture
		source = actor
		target_flag = target
		source_flags = only_tolerated

		
		name = "remove_tolerated_culture_select_culture"
		none_available_msg_key = "remove_tolerated_culture_no_cultures"
		column = {
			data = name
		}
	}

	effect = {
		scope:actor = {
			if = {
				limit = {
					exists = scope:target
				}
				remove_tolerated_culture = scope:target
				custom_tooltip = {
					text = lose_50_pop_satisfaction_ct
					every_pop = {
						limit = {
							owner ?= scope:actor
							culture = scope:target
						}
						add_pop_satisfaction = pop_satisfaction_ultimate_penalty
					}
				}
			}
		}
	}
	
	ai_will_do = {
		add = {
			desc = "willingness"
			value = 500
		}

		subtract = {
			desc = "less tolerated pops"
			scope:actor = {
				value = 100
				multiply = "culture_percentage_in_country(scope:target)"
			}
		}

		# Remove cultures that are below 7.5% if we are at peace and have 50 stability and over our cap
		if = {
			limit = {
				scope:actor = {
					OR = {
						used_cultures_capacity <= modifier:cultures_capacity
						stability < 50
						at_war = yes
					}
				}
			}
			multiply = 0
		}

		if = {
			limit = {
				scope:actor = {
					"culture_percentage_in_country(scope:target)" > 0.075
				}
			}
			multiply = 0
		}
	}
}
