grant_shugo_office = {
	type = internationalorganization

	ai_tick = monthly
	ai_tick_frequency = 6

	automation_tick = never
	automation_tick_frequency = 12
	show_message_to_target = yes

	potential = {
		exists = international_organization:japanese_shogunate
		scope:actor = { is_member_of_international_organization = international_organization:japanese_shogunate }
	}

	allow = {
		international_organization:japanese_shogunate ?= {
			international_organization_has_policy = policy:appointed_posts_policy
			leader_country ?= scope:actor
		}
	}
	
	price = price:grant_shugo_office

	cooldown = {
		type = grant_shugo_office
		years = 5
	}

	select_trigger = {
		looking_for_a = international_organization
		source = actor
		target_flag = recipient
		name = "choose_international_organization"
		column = {
			data = name
		}
		visible = {
			international_organization_type = international_organization_type:japanese_shogunate
		}
	}

	select_trigger = {
		looking_for_a = location
		source = recipient
		target_flag = target_location
		name = "choose_province"
		none_available_msg_key = "no_provinces_available"
		source_global_list = shugo_capital_locations
		column = {
			data = shugo_province_name
		}
		enabled = {
			NOT = {
				has_building = building_type:kokufu
			}
		}
	}

	select_trigger = {
		looking_for_a = country
		source = recipient
		target_flag = target
		name = "choose_country"
		none_available_msg_key = "no_countries_available"
		column = {
			data = name
		}
		visible = {
			is_member_of_international_organization = international_organization:japanese_shogunate
		}
		enabled = {
			NOT = { is_at_war_with = scope:actor }
			NOT = { is_rival_of = scope:actor }
			NOT = { is_enemy_of = scope:actor }
		}
	}

	effect = {
		scope:actor = {
			add_stability = stability_mild_bonus
		}
		if = {
			limit = {
				exists = scope:target_location
				exists = scope:target
			}
			scope:target_location = {
				change_building_level_in_location = {
					building = building_type:kokufu
					value = 1
					owner = scope:target
				}
			}
			international_organization:japanese_shogunate = {
				if = {
					limit = {
						NOT = {
							country_has_special_status = {
								type = special_status:shugo_daimyo
								country = scope:target
							}
						}
					}
					international_organization_add_special_status = {
						type = special_status:shugo_daimyo
						country = scope:target
					}
				}
				else = {
					custom_tooltip = already_shugo_daimyo_tt
				}
			}
		}
		else = {
			custom_tooltip = grant_shugo_office_effect_tt
		}
	}

	ai_will_do = {
		if = {
			limit = { exists = scope:target }
			add = {
				desc = "game_concept_opinion"
				value = "scope:actor.opinion(scope:target)"
			}
		}
		add = {
			desc = "game_concept_stability"
			value = "scope:actor.currency_utility(stability|stability_mild_bonus)"
		}
	}
}

revoke_shugo_office = {
	type = internationalorganization

	ai_tick = monthly
	ai_tick_frequency = 6

	automation_tick = never
	automation_tick_frequency = 12
	show_message_to_target = yes

	potential = {
		exists = international_organization:japanese_shogunate
		scope:actor = { is_member_of_international_organization = international_organization:japanese_shogunate }
	}

	allow = {
		international_organization:japanese_shogunate ?= {
			international_organization_has_policy = policy:appointed_posts_policy
			leader_country ?= scope:actor
		}
	}
	
	price = price:revoke_shugo_office

	cooldown = {
		type = revoke_shugo_office
		years = 5
	}

	select_trigger = {
		looking_for_a = international_organization
		source = actor
		target_flag = recipient
		name = "choose_international_organization"
		column = {
			data = name
		}
		visible = {
			international_organization_type = international_organization_type:japanese_shogunate
		}
	}

	select_trigger = {
		looking_for_a = location
		source = recipient
		target_flag = target_location
		name = "choose_province"
		none_available_msg_key = "no_provinces_available"
		column = {
			data = shugo_province_name
		}
		source_global_list = shugo_capital_locations
		enabled = {
			any_buildings_in_location = {
				building_type = building_type:kokufu
				owner ?= {
					NOT = { is_at_war_with = scope:actor }
					NOT = { is_allied_with = { target = scope:actor } }
				}
			}
		}
	}

	effect = {
		if = {
			limit = {
				exists = scope:target_location
			}
			scope:target_location = {
				random_buildings_in_location = {
					limit = { building_type = building_type:kokufu }
					owner = { save_scope_as = target }
				}
				scope:target = {
					add_opinion = { target = scope:actor modifier = opinion_revoked_shugo_office }
					add_casus_belli = { target = scope:actor type = casus_belli:cb_japanese_clan_rebel_against_shogunate_authority }
					if = {
						limit = {
							any_owned_foreign_building = {
								building_type = building_type:kokufu
								count = 1
							}
						}
						international_organization:japanese_shogunate = {
							international_organization_remove_special_status = {
								type = special_status:shugo_daimyo
								country = scope:target
							}
						}
					}
					else = {
						custom_tooltip = still_shugo_daimyo_tt
					}
				}
				destroy_building = "building(building_type:kokufu|scope:target)"
			}
		}
		else = {
			custom_tooltip = revoke_shugo_office_effect_tt
		}
	}

	ai_will_do = {
		if = {
			limit = { exists = scope:target }
			add = {
				desc = "game_concept_opinion"
				value = "scope:actor.opinion(scope:target)"
				multiply = -1
			}
		}
	}
}

claim_shugo_office = {
	type = internationalorganization

	ai_tick = monthly
	ai_tick_frequency = 6

	automation_tick = never
	automation_tick_frequency = 12
	show_message_to_target = yes

	potential = {
		exists = international_organization:japanese_shogunate
		scope:actor = { is_member_of_international_organization = international_organization:japanese_shogunate }
	}

	allow = {
		international_organization:japanese_shogunate ?= {
			OR = {
				international_organization_has_policy = policy:appointed_posts_policy
				international_organization_has_policy = policy:established_domains_policy
			}
			OR = {
				international_organization_has_leader = no
				scope:actor = {
					NOT = { is_leader_of_international_organization = prev }
					NOT = { is_at_war_with = prev.leader_country }
				}
			}
		}
	}
	
	price = price:claim_shugo_office

	cooldown = {
		type = claim_shugo_office
		years = 5
	}

	select_trigger = {
		looking_for_a = international_organization
		source = actor
		target_flag = recipient
		name = "choose_international_organization"
		column = {
			data = name
		}
		visible = {
			international_organization_type = international_organization_type:japanese_shogunate
		}
	}

	select_trigger = {
		looking_for_a = location
		source = recipient
		target_flag = target_location
		name = "choose_province"
		none_available_msg_key = "no_provinces_available"
		column = {
			data = shugo_province_name
		}
		source_global_list = shugo_capital_locations
		enabled = {
			NOT = { has_building = building_type:kokufu }
			owner ?= {
				trigger_if = {
					limit = { exists = international_organization:japanese_shogunate.leader_country }
					this = international_organization:japanese_shogunate.leader_country
				}
				trigger_else = {
					is_member_of_international_organization = international_organization:japanese_shogunate
				}
			}
			any_buildings_in_location = {
				OR = {
					building_type = building_type:yamashiro
					building_type = building_type:yakata
				}
				owner ?= scope:actor
			}
		}
	}

	effect = {
		if = {
			limit = {
				exists = scope:target_location
			}
			scope:target_location = {
				scope:target_location = {
					change_building_level_in_location = {
						building = building_type:kokufu
						value = 1
						owner = scope:actor
					}
				}
			}
		}
		else = {
			custom_tooltip = claim_shugo_office_effect_tt
		}
		international_organization:japanese_shogunate = {
			if = {
				limit = {
					NOT = {
						country_has_special_status = {
							type = special_status:shugo_daimyo
							country = scope:actor
						}
					}
				}
				international_organization_add_special_status = {
					type = special_status:shugo_daimyo
					country = scope:actor
				}
			}
			leader_country ?= {
				save_scope_as = target
				add_opinion = { target = scope:actor modifier = opinion_usurped_shugo_office }
				add_casus_belli = { target = scope:actor type = casus_belli:cb_shogunate_reassert_authority }
			}
		}
	}

	ai_will_do = {
		if = {
			limit = { exists = scope:target }
			add = {
				desc = "game_concept_opinion"
				value = "scope:actor.opinion(scope:target)"
				multiply = -1
			}
		}
	}
}