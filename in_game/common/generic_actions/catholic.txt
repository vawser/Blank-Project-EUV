demand_church_tax = {
	type = religious

	sound = UI_action_religion_generic
	
	ai_tick = monthly
	ai_tick_frequency = 120
	automation_tick = monthly
	automation_tick_frequency = 12

	automation_tick = monthly
	automation_tick_frequency = 12
	player_automated_category = religiousdoctrines

	
	potential = {
		scope:actor.religion = religion:catholic
		scope:actor = { tag = PAP }
	}

	allow = {
		papacy_active = yes
		religion:catholic = {
			any_country_in_religion = {
				has_estate_privilege = estate_privilege:apostolic_tax_privilege
			}
		}
	}
	
	price = price:demand_church_tax_price

	select_trigger = {
		looking_for_a = religion
		source = actor
		target_flag = recipient
		name = "choose_religion"
		column = {
			data = name
		}
	}

	cooldown = { type = recently_demanded_church_tax years = 20 }

	effect = {
		custom_tooltip = every_catholic_asked_to_pay_tt
		hidden_effect = {
			religion:catholic = { 
				every_country_in_religion = {
					limit = {
						NOT = { tag = PAP }
						has_estate_privilege = estate_privilege:apostolic_tax_privilege
					}
					trigger_event_non_silently = flavor_pap.9
				}
			}
		}
	}

	ai_will_do = {
		#base
		value = 20
		#we have better actions available:
		if = {
			limit = {
				scope:actor = {
					can_do_generic_action = {
						generic_action = generic_action:request_cardinal_seat
						recipient = scope:actor.religion
						target_location = scope:actor.capital	#yes, that action is available for other locations in your country too, but checking every other location would be too costly
					}
				}
			}
			multiply = 0
		}
	}
}

#Actions for Holy Orders
request_aid = {
	type = religious

	sound = UI_action_religion_generic
	
	ai_tick = monthly
	ai_tick_frequency = 60

	automation_tick = monthly
	automation_tick_frequency = 6
	player_automated_category = religiousdoctrines
	
	potential = {
		scope:actor.religion = religion:catholic
		scope:actor = { NOT = { tag = PAP } }
	}

	allow = {
		papacy_active = yes
		custom_tooltip = {
			text = 10_years_cd
		}
		scope:actor = { 
			has_reform = government_reform:military_order_reform
			NOR = {
				is_rival_of = c:PAP
				is_enemy_of = c:PAP
			}
			c:PAP = {
				this_opinion_of_prev > 100 
			}
		}
		country_exists = c:PAP
	}

	cooldown = {
		type = recently_requested_aid
		years = 20
	}
	
	price = price:request_aid_price

	select_trigger = {
		looking_for_a = religion
		source = actor
		target_flag = recipient
		name = "choose_religion"
		column = {
			data = name
		}
	}

	effect = {
		scope:actor = {
			trigger_event_non_silently = military_order_events.1
		}
	}

	ai_will_do = {
		#base value
		value = 100	
	}
}

#Actions for non-theocratic Catholics
placitum_regium = {
	ai_tick = never
	ai_tick_frequency = 60
	automation_tick = monthly
	automation_tick_frequency = 6

	automation_tick = never
	automation_tick_frequency = 12
	#player_automated_category = religiousdoctrines

	type = religious

	sound = UI_action_religion_generic

	potential = {
		scope:actor.religion = religion:catholic
		scope:actor = { NOT = { tag = PAP } }
	}
	allow = {
		papacy_active = yes
		scope:actor = {
			OR = {
				country_rank = country_rank:rank_kingdom
				country_rank = country_rank:rank_empire
				is_emperor = yes
			}
			"estate_power(estate_type:clergy_estate)" <= 0.15
		}
		custom_tooltip = {
			text = once_per_ruler
			scope:actor = {
				exists = ruler
				has_ruler = yes
				ruler = { not = { has_character_modifier = enacted_placitum_regium } }
			}
		}
		country_exists = c:PAP
	}

	select_trigger = {
		looking_for_a = religion
		source = actor
		target_flag = recipient
		name = "choose_religion"
		column = {
			data = name
		}
	}

	effect = {
		scope:actor = {
			add_religious_influence = religious_influence_radical_penalty
			if = {
				limit = { has_ruler = yes }
				ruler = {
					add_character_modifier = {
						modifier = enacted_placitum_regium
						years = -1
						
					}
				}
			}
			add_estate_satisfaction = { 
				type = estate_type:clergy_estate
				value = estate_satisfaction_severe_penalty
			}
		}
	}

	ai_will_do = {
		value = -30
		add = {
			value = "c:PAP.opinion(scope:actor)"
			multiply = -0.5
		}
		if = {
			limit = {
				scope:actor = {
					has_ruler = yes
					ruler ?= {
						has_trait = sinner
					}
				}
			}
			add = 50
		}
		if = {
			limit = {
				"scope:actor.societal_value:spiritualist_vs_humanist" < 0
			}
			add = {
				value = "scope:actor.societal_value:spiritualist_vs_humanist"
				multiply = -1
			}
		}
	}
}

request_cardinal_seat = {

	ai_tick = monthly
	ai_tick_frequency = 24
	automation_tick = monthly
	automation_tick_frequency = 6
	player_automated_category = religiousdoctrines

	type = religious

	sound = UI_action_religion_generic

	potential = {
		scope:actor.religion = religion:catholic
	}
	allow = {
		papacy_active = yes
		country_exists = c:PAP
		scope:actor = {
			OR = {
				country_rank = country_rank:rank_duchy
				country_rank = country_rank:rank_kingdom
				country_rank = country_rank:rank_empire
				is_emperor = yes
			}
		}
	}

	cooldown = {
		type = recently_requested_cardinal
		years = 1
	}

	price = price:cardinal_price

	select_trigger = {
		looking_for_a = religion
		source = actor
		target_flag = recipient
		name = "choose_religion"
		column = {
			data = name
		}
	}

	select_trigger = {
		looking_for_a = location
		interaction_source_list = {
			scope:actor = {
				every_owned_location = {
					limit = {
						has_building = building_type:cathedral
						NOT = {
							has_building = building_type:seat_of_cardinal
						}
					}
					add_to_list = source
				}
			}
		}
		target_flag = target_location
		name = "choose_location"
		none_available_msg_key = "no_locations_available"
		column = { data = name }
		column = { data = population }
		column = { data = rank }
		visible = {
			has_owner = yes
			owner ?= scope:actor
			has_building = building_type:cathedral
		}
	}

	effect = {
		if = {
			limit = {
				exists = scope:target_location
			}
			scope:actor = {
				set_variable = {
					name = cost_of_cardinal
					value = {
						add = 33
						if = {
							limit = {
								scope:actor = { num_cardinals > 0 }
							}
							multiply = {
								value = 1.25
								multiply = scope:actor.num_cardinals
							}
						}
						add = {
							value = 33
							multiply = {
								value = 0.2
								multiply = religion:catholic.total_cardinals
							}
						}
					}
				}
			}
			c:PAP = {
				trigger_event_non_silently = catholic_flavor.1000
			}
		}
		else = {
			custom_tooltip = request_cardinal_tt
		}
	}

	ai_will_do = {
		value = -100
		if = {
			limit = { scope:actor = { NOT = { tag = PAP } } }
			add = "c:PAP.opinion(scope:actor)"
		}
	}
}