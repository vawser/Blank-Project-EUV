#First Phase
tordesillas_claim_area = { #Used by the Main countries during the "first phase" to claim the world
	type = situation

	potential = {
		situation:treaty_of_tordesillas = {
			has_variable = var_west_country
			has_variable = var_east_country
		}
		trigger_if = {
			limit = {
				situation:treaty_of_tordesillas = {
					has_variable = var_west_country
					has_variable = var_east_country
				}
			}
			OR = {
				scope:actor = situation:treaty_of_tordesillas.var:var_west_country
				scope:actor = situation:treaty_of_tordesillas.var:var_east_country
			}
		}
		#Only Phase 1
		situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
	}

	automation_tick = never
	automation_tick_frequency = 12
	
	price = price:tordesillas_claim_area_price

	cooldown = {
		type = tordesillas_claim_area_cooldown
		years = 1
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}
	
	select_trigger = {
		looking_for_a = area
		target_flag = target_area
		name = "tordesillas_claim_area_select_title"
		none_available_msg_key = "steal_maps_no_areas"
		column = { data = name }
		visible = {
			within_colonial_range_of = scope:actor
			#Cannot claim anything in this regions
			NOR = {
				continent = continent:europe
				sub_continent = sub_continent:south_asia
				sub_continent = sub_continent:east_asia
			}
			#Only discovered
			scope:actor = { has_discovered_area = prev }
			#Only land areas
			#It needs to have unowned locations
			any_location_in_area = {
				is_land = yes
				is_ownable = yes
				has_owner = no
			}
			#It cannot have any non pagan country already on it
			NOT = {
				any_location_in_area = {
					has_owner = yes
					top_owner ?= {
						is_country_religion_pagan = no
					}
				}
			}
		}
		enabled = {
			#scope:actor needs to have an adjacent area with a claim or with controlled land
			custom_tooltip = {
				text = tordesillas_claim_area.tt.owns_location_in_neighbor_area
				any_neighbor_area = {
					#Is this new area a land area?
					trigger_if = {
						limit = {
							any_location_in_area = {
								is_land = yes
							}	
						}					
						#Yes, it is a Land Area
						#Check if there are adjacent claims
						any_location_in_area = {
							is_location_claimed_or_owned_by_country = {
								owner_country = scope:actor
							}
						}
					}
					trigger_else = {
						#No, it is a sea Area
						#Do a second check from this sea area to try and get to land
						any_neighbor_area = {
							#Check if there are adjacent claims
							any_location_in_area = {
								is_land = yes
								is_location_claimed_or_owned_by_country = {
									owner_country = scope:actor
								}
							}
						}
					}
				}
			}
			#Nobody can have a claim already on it
			custom_tooltip = {
				text = tordesillas_claim_area.tt.no_claims_in_area
				NOT = {
					any_province_definition_in_area = {
						OR = {						
							situation:treaty_of_tordesillas.var:var_west_country ?= {
								has_colonial_claim = prev
							}
							situation:treaty_of_tordesillas.var:var_east_country ?= {
								has_colonial_claim = prev
							}
						}
					}
				}
			}
		}
		#(root = location, scope:actor/recipient etc)
		map_color = {
			if = {
				limit = {
					situation:treaty_of_tordesillas ?= {
						has_variable = var_east_country
					}
					has_owner = yes
					top_owner ?= situation:treaty_of_tordesillas.var:var_east_country
				}
				value = top_owner.country_color
			}
			else_if = {
				limit = {
					situation:treaty_of_tordesillas ?= {
						has_variable = var_west_country
					}
					has_owner = yes
					top_owner ?= situation:treaty_of_tordesillas.var:var_west_country
				}
				value = top_owner.country_color
			}
			#This area has a conflict, more than one colony
			else_if = {
				limit = {
					area = {
						any_ownable_location_in_area = {
							has_owner = yes
							is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_east_country
						}
						any_ownable_location_in_area = {
							has_owner = yes
							is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_west_country
						}
					}
				}
				value = define:NMapColors|MAP_COLOR_LOW
			}
			#Neutral
			else = {
				value = define:NMapColors|MAP_COLOR_HIGH
			}
		}
	}


	effect = {
        #Claims the selected area for the scope actor
		scope:target_area ?= {
			every_province_definition_in_area = {
				scope:actor ?= {
					add_colonial_claim = {
						province_definition = prev
						reason = claim_reason_treaty_of_tordesillas
						category = same_religion
					}
				}
			}
		}
	}
	
	ai_will_do = {
		#This action should be used a lot if the country prioritizes colonialism
		add =  scope:actor.societal_value:land_vs_naval
		add = {
			value = {
				add =  scope:actor.societal_value:outward_vs_inward
				multiply = -1
			}			
		}		
		if = {
			limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
			add = {
				value = {
					value = scope:actor.modifier:bias_for_colonialist_policies
				}
			}
		}
		if = {
			limit = {
				scope:actor = {
					country_tax_base > 50
				}
			}
			scope:target_area = {
				every_province_in_area = {
					add = population
					add = province_capital.proximity
				}
			}
		}
		else = {
			add = -1000
		}

		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}

#Used by the Main countries during the "first phase" to claim the world if they do not have a claim already and there are no conflicting areas
tordesillas_free_claim_area = { 
	type = situation

	potential = {
		situation:treaty_of_tordesillas = {
			has_variable = var_west_country
			has_variable = var_east_country
		}
		trigger_if = {
			limit = {
				situation:treaty_of_tordesillas = {
					has_variable = var_west_country
					has_variable = var_east_country
				}
			}
			OR = {
				scope:actor = situation:treaty_of_tordesillas.var:var_west_country
				scope:actor = situation:treaty_of_tordesillas.var:var_east_country
			}
		}
		#The country has no claims at all
		scope:actor = {
			any_colonial_claim_province_definition = {
				count = 0
			}
		}
		#The are no conflicting areas
		situation:treaty_of_tordesillas.var:var_east_country = {
			any_owned_location = {
				count = 0	
				NOR = {
					continent = continent:europe
					sub_continent = sub_continent:south_asia
					sub_continent = sub_continent:east_asia
				}
				area = {
					any_ownable_location_in_area = {
						has_owner = yes
						is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_west_country
					}
				}
			}
		}
		#Only Phase 1
		situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
	}

	automation_tick = never
	automation_tick_frequency = 12
	
	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}
	
	select_trigger = {
		looking_for_a = area
		target_flag = target_area
		name = "tordesillas_claim_area_select_title"
		none_available_msg_key = "steal_maps_no_areas"
		column = { data = name }
		visible = {
			within_colonial_range_of = scope:actor
			#Cannot claim anything in this regions
			NOR = {
				continent = continent:europe
				sub_continent = sub_continent:south_asia
				sub_continent = sub_continent:east_asia
			}
			#Only discovered
			scope:actor = { has_discovered_area = prev }
			#Only land areas
			any_location_in_area = {
				is_land = yes
			}			
			#It cannot have any non pagan country already on it
			NOT = {
				any_present_country = {
					is_country_religion_pagan = no
				}
			}
			#It needs to have unowned locations
			any_location_in_area = {
				is_ownable = yes
				has_owner = no
			}
		}
		enabled = {
			#Nobody can have a claim already on it
			custom_tooltip = {
				text = tordesillas_claim_area.tt.no_claims_in_area
				NOT = {
					any_province_definition_in_area = {
						OR = {						
							situation:treaty_of_tordesillas.var:var_west_country ?= {
								has_colonial_claim = prev
							}
							situation:treaty_of_tordesillas.var:var_east_country ?= {
								has_colonial_claim = prev
							}
						}
					}
				}
			}
		}
		#(root = location, scope:actor/recipient etc)
		map_color = {
			if = {
				limit = {
					situation:treaty_of_tordesillas ?= {
						has_variable = var_east_country
					}
					has_owner = yes
					top_owner ?= situation:treaty_of_tordesillas.var:var_east_country
				}
				value = top_owner.country_color
			}
			else_if = {
				limit = {
					situation:treaty_of_tordesillas ?= {
						has_variable = var_west_country
					}
					has_owner = yes
					top_owner ?= situation:treaty_of_tordesillas.var:var_west_country
				}
				value = top_owner.country_color
			}
			#This area has a conflict, more than one colony
			else_if = {
				limit = {
					area = {
						any_ownable_location_in_area = {
							has_owner = yes
							is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_east_country
						}
						any_ownable_location_in_area = {
							has_owner = yes
							is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_west_country
						}
					}
				}
				value = define:NMapColors|MAP_COLOR_LOW
			}
			#Neutral
			else = {
				value = define:NMapColors|MAP_COLOR_HIGH
			}
		}
	}


	effect = {
        #Claims the selected area for the scope actor
		scope:target_area ?= {
			every_province_definition_in_area = {
				scope:actor ?= {
					add_colonial_claim = {
						province_definition = prev
						reason = claim_reason_treaty_of_tordesillas
						category = same_religion
					}
				}
			}
		}
	}
	
	ai_will_do = {
		#Do it immediately 
		add = 100
	}
}
	
#Claim conflicting Area
tordesillas_claim_conflicting_area = { #Used by the Main countries to claim a conflicting area
	type = situation

	potential = {
		situation:treaty_of_tordesillas = {
			has_variable = var_west_country
			has_variable = var_east_country
		}
		trigger_if = {
			limit = {
				situation:treaty_of_tordesillas = {
					has_variable = var_west_country
					has_variable = var_east_country
				}
			}
			OR = {
				scope:actor = situation:treaty_of_tordesillas.var:var_west_country
				scope:actor = situation:treaty_of_tordesillas.var:var_east_country
			}
		}
		#Only Phase 1
		situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
	}
	allow = {
		trigger_if = {
			limit = {
				scope:actor = situation:treaty_of_tordesillas.var:var_west_country
			}
			#More Diplo Rep
			scope:actor.modifier:diplomatic_reputation > situation:treaty_of_tordesillas.var:var_east_country.modifier:diplomatic_reputation
			#More or equal opinion with PAP
			"c:PAP.opinion(scope:actor)">= "c:PAP.opinion(situation:treaty_of_tordesillas.var:var_east_country)"
		}
		trigger_else = {
			#More Diplo Rep
			scope:actor.modifier:diplomatic_reputation > situation:treaty_of_tordesillas.var:var_west_country.modifier:diplomatic_reputation
			#More or equal opinion with PAP
			"c:PAP.opinion(scope:actor)">= "c:PAP.opinion(situation:treaty_of_tordesillas.var:var_west_country)"
		}
	}

	automation_tick = never
	automation_tick_frequency = 12
	
	price = {
		#If the country has no claims the action is free
		if = {
			limit = {
				scope:actor = {
					any_colonial_claim_province_definition = {
						count > 0
					}
				}
			}
			value = price:tordesillas_claim_conflicting_area_price
		}
	}
 	

	cooldown = {
		type = tordesillas_claim_area_cooldown
		years = 1
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}
	
	select_trigger = {
		looking_for_a = area
		target_flag = target_area
		name = "tordesillas_claim_area_select_title"
		none_available_msg_key = "steal_maps_no_areas"
		column = { data = name }
		visible = {
			within_colonial_range_of = scope:actor
			
			#Cannot claim anything in this regions
			NOR = {
				continent = continent:europe
				sub_continent = sub_continent:south_asia
				sub_continent = sub_continent:east_asia
			}

			#Only discovered
			scope:actor = { has_discovered_area = prev }

			#Only land areas
			any_location_in_area = {
				is_land = yes
			}

			#It needs to have unowned locations
			any_location_in_area = {
				has_owner = no
			}

			#Both countries have land or colonies already on it
			any_ownable_location_in_area = {
				has_owner = yes
				is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_east_country
			}
			any_ownable_location_in_area = {
				has_owner = yes
				is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_west_country
			}
		}
		#(root = location, scope:actor/recipient etc)
		map_color = {
			if = {
				limit = {
					situation:treaty_of_tordesillas ?= {
						has_variable = var_east_country
					}
					has_owner = yes
					top_owner ?= situation:treaty_of_tordesillas.var:var_east_country
				}
				value = top_owner.country_color
			}
			else_if = {
				limit = {
					situation:treaty_of_tordesillas ?= {
						has_variable = var_west_country
					}
					has_owner = yes
					top_owner ?= situation:treaty_of_tordesillas.var:var_west_country
				}
				value = top_owner.country_color
			}
			#This area has a conflict, more than one colony
			else_if = {
				limit = {
					area = {
						any_ownable_location_in_area = {
							has_owner = yes
							is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_east_country
						}
						any_ownable_location_in_area = {
							has_owner = yes
							is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_west_country
						}
					}
				}
				value = define:NMapColors|MAP_COLOR_HIGH
			}
		}
	}


	effect = {
        #Claims the selected area for the scope actor
		scope:target_area ?= {
			every_province_definition_in_area = {
				scope:actor ?= {
					add_colonial_claim = {
						province_definition = prev
						reason = claim_reason_treaty_of_tordesillas
						category = same_religion
					}
				}
			}
		}
		c:PAP = {
			add_favors = { target = scope:actor value = 2 }
			add_opinion = { target = scope:actor modifier = opinion_asked_for_favor }
		}
	}
	
	ai_will_do = {
		#This action should be used a lot if the country prioritizes colonialism
		add =  scope:actor.societal_value:land_vs_naval
		add = {
			value = {
				add =  scope:actor.societal_value:outward_vs_inward
				multiply = -1
			}			
		}		
		if = {
			limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
			add = {
				value = {
					value = scope:actor.modifier:bias_for_colonialist_policies
				}
			}
		}
		#If the country has no claims the action is very important
		if = {
			limit = {
				scope:actor = {
					any_colonial_claim_province_definition = {
						count = 0
					}
				}
			}
			add = 1000
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}
	
#Ask for revoke of claim
#Used by the Main countries during the "first phase" to convince the Pope to revoke a claim on the other signatory
tordesillas_revoke_claim = { 
	type = situation

	potential = {
		situation:treaty_of_tordesillas = {
			has_variable = var_west_country
			has_variable = var_east_country
		}
		trigger_if = {
			limit = {
				situation:treaty_of_tordesillas = {
					has_variable = var_west_country
					has_variable = var_east_country
				}
			}
			OR = {
				scope:actor = situation:treaty_of_tordesillas.var:var_west_country
				scope:actor = situation:treaty_of_tordesillas.var:var_east_country
			}
		}
		#Only Phase 1
		situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
	}
	
	allow = {
		trigger_if = {
			limit = {
				scope:actor = situation:treaty_of_tordesillas.var:var_west_country
			}
			#More Diplo Rep
			scope:actor.modifier:diplomatic_reputation > situation:treaty_of_tordesillas.var:var_east_country.modifier:diplomatic_reputation
			#More or equal opinion with PAP
			"c:PAP.opinion(scope:actor)">= "c:PAP.opinion(situation:treaty_of_tordesillas.var:var_east_country)"
		}
		trigger_else = {
			#More Diplo Rep
			scope:actor.modifier:diplomatic_reputation > situation:treaty_of_tordesillas.var:var_west_country.modifier:diplomatic_reputation
			#More or equal opinion with PAP
			"c:PAP.opinion(scope:actor)">= "c:PAP.opinion(situation:treaty_of_tordesillas.var:var_west_country)"
		}
	}

	price = price:tordesillas_revoke_claim

	cooldown = {
		type = tordesillas_revoke_claim
		years = 1
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}
	
	select_trigger = {
		looking_for_a = area
		target_flag = target_area
		ai_interaction_source_list = {
			#Get only the neighboring areas to areas already claimed by Actor, to avoid the AI choosing useless areas
			every_area = {
				limit = {
					#Only discovered
					scope:actor = { has_discovered_area = prev }
					#Claimed Areas
					any_province_definition_in_area = {
						scope:actor ?= {
							has_colonial_claim = prev
						}
					}
				}
				every_neighbor_area = {
					limit = {
						scope:actor = { has_discovered_area = prev }
						#Areas claimed by the other signatory
						any_province_definition_in_area = {
							#If actor is var_west_country
							trigger_if = {
								limit = {
									scope:actor ?= situation:treaty_of_tordesillas.var:var_west_country
								}
								situation:treaty_of_tordesillas.var:var_east_country ?= {
									has_colonial_claim = prev
								}
							}
							#If actor is var_east_country
							trigger_else = {
								situation:treaty_of_tordesillas.var:var_west_country ?= {
									has_colonial_claim = prev
								}
							}
						}
					}
					add_to_list = source
				}
			}
		}
		name = "tordesillas_demand_colony_select_title"
		none_available_msg_key = "steal_maps_no_areas"
		column = { data = name }
		visible = {
			#Only discovered
			scope:actor = { has_discovered_area = prev }
			#Areas claimed by the other signatory
			any_province_definition_in_area = {
				#If actor is var_west_country
				trigger_if = {
					limit = {
						scope:actor ?= situation:treaty_of_tordesillas.var:var_west_country
					}
					situation:treaty_of_tordesillas.var:var_east_country ?= {
						has_colonial_claim = prev
					}
				}
				#If actor is var_east_country
				trigger_else = {
					situation:treaty_of_tordesillas.var:var_west_country ?= {
						has_colonial_claim = prev
					}
				}
			}
		}
		#(root = location, scope:actor/recipient etc)
		map_color = {
			if = {
				limit = {
					situation:treaty_of_tordesillas ?= {
						has_variable = var_east_country
					}
					has_owner = yes
					top_owner ?= situation:treaty_of_tordesillas.var:var_east_country
				}
				value = top_owner.country_color
			}
			else_if = {
				limit = {
					situation:treaty_of_tordesillas ?= {
						has_variable = var_west_country
					}
					has_owner = yes
					top_owner ?= situation:treaty_of_tordesillas.var:var_west_country
				}
				value = top_owner.country_color
			}
			#This area has a conflict, more than one colony
			else_if = {
				limit = {
					area = {
						any_ownable_location_in_area = {
							has_owner = yes
							is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_east_country
						}
						any_ownable_location_in_area = {
							has_owner = yes
							is_owned_or_owned_by_subjects_or_below_of = situation:treaty_of_tordesillas.var:var_west_country
						}
					}
				}
				value = define:NMapColors|MAP_COLOR_LOW
			}
			#Neutral
			else = {
				value = define:NMapColors|MAP_COLOR_HIGH
			}
		}
	}
	

	effect = {
        #Remove the claims in the Area
		scope:target_area ?= {
			every_province_definition_in_area = {
				remove_colonial_claim = this
			}
		}
		
		c:PAP = {
			add_favors = { target = scope:actor value = 2 }
			add_opinion = { target = scope:actor modifier = opinion_asked_for_favor }
		}
		if = {
			limit = {
				scope:actor ?= situation:treaty_of_tordesillas.var:var_west_country
			}
			situation:treaty_of_tordesillas.var:var_east_country ?= {
				add_opinion = { target = scope:actor modifier = opinion_got_our_claim_revoked }
			}
		}
		#If actor is var_east_country
		else = {
			situation:treaty_of_tordesillas.var:var_west_country ?= {
				add_opinion = { target = scope:actor modifier = opinion_got_our_claim_revoked }
			}
		}
	}
	
	ai_will_do = {
		#This action should be used a lot if the country prioritizes colonialism
		add =  scope:actor.societal_value:land_vs_naval
		add = {
			value = {
				add =  scope:actor.societal_value:outward_vs_inward
				multiply = -1
			}			
		}		
		if = {
			limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
			add = {
				value = {
					value = scope:actor.modifier:bias_for_colonialist_policies
				}
			}
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}

#Used by the Main countries during the "first phase" to push towards settlement (change situation to phase 2)
tordesillas_push_to_settle_treaty = { 
	type = situation

	potential = {
		situation:treaty_of_tordesillas = {
			has_variable = var_west_country
			has_variable = var_east_country
		}
		trigger_if = {
			limit = {
				situation:treaty_of_tordesillas = {
					has_variable = var_west_country
					has_variable = var_east_country
				}
			}
			OR = {
				scope:actor = situation:treaty_of_tordesillas.var:var_west_country
				scope:actor = situation:treaty_of_tordesillas.var:var_east_country
			}
		}
		#Only Phase 1
		situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
	}

	automation_tick = never
	automation_tick_frequency = 12
	
	price = price:tordesillas_push_to_settle_treaty

	cooldown = {
		type = tordesillas_push_to_settle_treaty
		years = 1
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}
	
	effect = {
		custom_tooltip = {
			text = tordesillas_push_to_settle_treaty.tt
			situation:treaty_of_tordesillas = {
				change_variable = { name = var_treaty_progress add = 10 }
				clamp_variable = { name = var_treaty_progress max = 100 min = 0.0 } 
			}
		}
	}
	
	ai_will_do = {
		#This action should be used if the country prioritizes colonialism and the other main country has more claims that actor does to stop them from getting even more
		add =  scope:actor.societal_value:land_vs_naval
		add = {
			value = {
				add =  scope:actor.societal_value:outward_vs_inward
				multiply = -1
			}			
		}		
		if = {
			limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
			add = {
				value = {
					value = scope:actor.modifier:bias_for_colonialist_policies
				}
			}
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}

#Move the Line Origin
#Used by the Main countries during the "first phase" to push the Line that will divide the world
tordesillas_move_the_line = { 
	type = situation

	potential = {
		situation:treaty_of_tordesillas = {
			has_variable = var_west_country
			has_variable = var_east_country
		}
		trigger_if = {
			limit = {
				situation:treaty_of_tordesillas = {
					has_variable = var_west_country
					has_variable = var_east_country
				}
			}
			OR = {
				scope:actor = situation:treaty_of_tordesillas.var:var_west_country
				scope:actor = situation:treaty_of_tordesillas.var:var_east_country
			}
		}
		#Only Phase 1
		situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
	}

	automation_tick = never
	automation_tick_frequency = 12
	
	price = price:tordesillas_move_the_line
	price_modifier = {
		value = 1
		multiply = {
			if = {
				limit = {
					exists = scope:target
				}
				if = {
					limit = {
						exists = scope:actor.var:var_tordesillas_moved_the_line
					}
					value = scope:actor.var:var_tordesillas_moved_the_line	
				}
			}
		}
	}

	cooldown = {
		type = tordesillas_move_the_line
		years = 1
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}
	
	select_trigger = {
		looking_for_a = province_definition
		target_flag = target_province_definition
		interaction_source_list = {
			#Save all the province neighboring twice the province that contains the origin of the line and the origin province itself
			situation:treaty_of_tordesillas.var:var_line_location = {
				province_definition = {
					add_to_list = source
					every_neighbor_province_definition = {
						every_neighbor_province_definition = {
							limit = {								
								any_location_in_province_definition = {
									is_land = yes
								}		
							}
							add_to_list = source
						}
					}
				}
			}
		}
		name = "choose_province"
		none_available_msg_key = "migrate_pop_based_country_no_provinces"
		column = { data = name }
		visible = {
			#Only discovered
			area = {
				scope:actor = { has_discovered_area = prev }
			}			
		}
	}

	select_trigger = {
		looking_for_a = location
		source = target_province_definition
		target_flag = target_location
		name = "choose_location"
		none_available_msg_key = "no_locations_available"
		column = { data = name }
		visible = {
			is_land = yes
			trigger_if = {
				limit = {					
					scope:actor ?= situation:treaty_of_tordesillas.var:var_east_country
				}
				NOT = { is_east_of = situation:treaty_of_tordesillas.var:var_line_location }
			}
			trigger_else = {
				is_east_of = situation:treaty_of_tordesillas.var:var_line_location
			}
		}
	}

	effect = {
		custom_tooltip = {
			text = tordesillas_move_the_line.tt
			situation:treaty_of_tordesillas = {			
				set_variable = {
					name = var_line_location
					value = scope:target_location
				}
			}
		}
		custom_tooltip = {
			text = tordesillas_move_the_line.tt2
			situation:treaty_of_tordesillas = {
				change_variable = { name = var_treaty_progress add = -5 }
				clamp_variable = { name = var_treaty_progress max = 100 min = 0.0 } 
			}
		}
	}
	
	ai_will_do = {
		#This action is always positive so it should be done as much as possible if the country is interested in colonialism
		add =  scope:actor.societal_value:land_vs_naval
		add = {
			value = {
				add =  scope:actor.societal_value:outward_vs_inward
				multiply = -1
			}			
		}		
		if = {
			limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
			add = {
				value = {
					value = scope:actor.modifier:bias_for_colonialist_policies
				}
			}
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}

#Swap the side of the claims
#Used by the Main countries during the "first phase" to swap which side of the world will they get
tordesillas_swap_sides = { 
	type = situation

	potential = {
		situation:treaty_of_tordesillas = {
			has_variable = var_west_country
			has_variable = var_east_country
		}
		OR = {
			scope:actor = situation:treaty_of_tordesillas.var:var_west_country
			scope:actor = situation:treaty_of_tordesillas.var:var_east_country
		}
		#Only Phase 1
		situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
	}

	ai_tick = monthly
	ai_tick_frequency = 12
	automation_tick = never
	automation_tick_frequency = 12
	
	price = price:tordesillas_swap_sides

	cooldown = {
		type = tordesillas_swap_sides
		years = 1
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}
	
	effect = {
		if = {
			limit ={
				scope:actor = situation:treaty_of_tordesillas.var:var_west_country
			}
			situation:treaty_of_tordesillas.var:var_east_country = {
				trigger_event_non_silently = { id = treaty_of_tordesillas.7 days = 7 }
			}
		}
		else = {
			situation:treaty_of_tordesillas.var:var_west_country = {
				trigger_event_non_silently = { id = treaty_of_tordesillas.7 days = 7 }
			}
		}
		custom_tooltip = {
			text = tordesillas_move_the_line.tt2
			situation:treaty_of_tordesillas = {
				change_variable = { name = var_treaty_progress add = -5 }
				clamp_variable = { name = var_treaty_progress max = 100 min = 0.0 } 
			}
		}
	}
	
	ai_will_do = {
		#This action is mostly useful for Humans, for AI will will consider the value of the claims we gain against the ones we use
		add =  scope:actor.societal_value:land_vs_naval
		add = {
			value = {
				add =  scope:actor.societal_value:outward_vs_inward
				multiply = -1
			}			
		}		
		if = {
			limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
			add = {
				value = {
					value = scope:actor.modifier:bias_for_colonialist_policies
				}
			}
		}
		#Add the value of the East side
		add = {
			value = {
				every_region = {
					limit = {					
						continent != continent:europe
						sub_continent != sub_continent:south_asia
						sub_continent != sub_continent:east_asia
					}
					every_area_in_region = {
						every_province_in_area = {
							limit = {
								any_location_in_province = {
									is_ownable = yes
									NAND = {
										has_owner = yes
										owner ?= { is_country_religion_pagan = no }
									}
									is_east_of = scope:target.var:var_line_location
								}
							}
							add = population
							add = province_capital.proximity
						}
					}
				}
			}
			if = {
				limit = {
					#If we are the east country, this is the value that we are going to lose, so make it negative
					scope:actor = situation:treaty_of_tordesillas.var:var_east_country
				}
				multiply = -1
			}
		}
		#Add the value of the West side
		add = {
			value = {
				every_region = {
					limit = {					
						continent != continent:europe
						sub_continent != sub_continent:south_asia
						sub_continent != sub_continent:east_asia
					}
					every_area_in_region = {
						every_province_in_area = {
							limit = {
								any_location_in_province = {
									is_ownable = yes
									NAND = {
										has_owner = yes
										owner ?= { is_country_religion_pagan = no }
									}
									NOT = { is_east_of = scope:target.var:var_line_location }
								}
							}
							add = population
							add = province_capital.proximity
						}
					}
				}
			}			
			if = {
				limit = {
					#If we are the west country, this is the value that we are going to lose, so make it negative
					scope:actor = situation:treaty_of_tordesillas.var:var_west_country
				}
				multiply = -1
			}
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}


#Second Phase

#Violate Treaty
violate_treaty_of_tordesillas = {
	type = situation
	
	ai_prerequisite = {
		ai_country_should_colonize = yes
	}

	potential = {
		situation:treaty_of_tordesillas = {
			has_variable = var_east_country
		}
		scope:actor ?= {
			religion = situation:treaty_of_tordesillas.var:var_east_country.religion
			NOT = {
				has_country_modifier = violate_treaty_of_tordesillas
			}
			#Cannot do this action if actor is both east and west country (maybe one annexed the other)			
			NAND = {
				scope:actor = situation:treaty_of_tordesillas.var:var_west_country
				scope:actor = situation:treaty_of_tordesillas.var:var_east_country
			}
		}
		#Only Phase 2
		situation:treaty_of_tordesillas.var:var_treaty_phase = 2.0
	}

	automation_tick = never
	automation_tick_frequency = 12
	
	price = price:violate_treaty_of_tordesillas

	cooldown = {
		type = violate_treaty_of_tordesillas
		years = 1
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}

	effect = {
        #Gives to the actor a modifier that allows them to ignore the religious claims created
		#by this situation
		scope:actor ?= {
			add_country_modifier = { modifier = violate_treaty_of_tordesillas years = -1	mode = add_and_extend }
			
			drop_antagonism_bomb = {
				modifier = antagonism_violate_treaty_of_tordesillas
				target = capital
			}
		}
	}
	
	ai_will_do = {
		#add negative effect of getting the mad modifier
		add = "scope:actor.add_static_modifier_utility(violate_treaty_of_tordesillas)"
		
		add = {
			desc = "bias from our colonialist policies"
			value = scope:actor.modifier:bias_for_colonialist_policies
		}
	}
}
	
stop_violate_treaty_of_tordesillas = {
	type = situation

	potential = {
		scope:actor ?= {
			has_country_modifier = violate_treaty_of_tordesillas
		}
		#Only Phase 2
		situation:treaty_of_tordesillas.var:var_treaty_phase = 2.0
	}
	
	allow = {
		scope:actor = {
			NOT = { has_cooldown = violate_treaty_of_tordesillas }
		}
	}

	automation_tick = never
	automation_tick_frequency = 12

	cooldown = {
		type = violate_treaty_of_tordesillas
		years = 1
	}
	
	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}

	effect = {
		scope:actor ?= {
			remove_country_modifier = violate_treaty_of_tordesillas

			#Abandon all colonial charters in provinces with a claim not owned by the actor
			every_colonial_charter = {
				save_scope_as = colonial_charter_scope
				#If the actor is not the New country of the situation
				if = {
					limit = {
						NOT = {scope:actor = situation:treaty_of_tordesillas.var:var_east_country }
					}
					#Scope to the New country
					situation:treaty_of_tordesillas.var:var_east_country = {
						#For each colonial claim of New Country
						every_colonial_claim_province_definition = {
							#Check if the province of the charter and the claim are the same
							limit = {
								this = scope:colonial_charter_scope.province_definition
							}
							#If so abandon the claim
							abandon_colonial_charter = scope:colonial_charter_scope
						}
					}
				}
				if = {
					limit = {
						NOT = {scope:actor = situation:treaty_of_tordesillas.var:var_west_country }
					}
					#Scope to the New country
					situation:treaty_of_tordesillas.var:var_west_country = {
						#For each colonial claim of New Country
						every_colonial_claim_province_definition = {
							#Check if the province of the charter and the claim are the same
							limit = {
								this = scope:colonial_charter_scope.province_definition
							}
							#If so abandon the claim
							abandon_colonial_charter = scope:colonial_charter_scope
						}
					}
				}
			}	
		}
	}

	ai_will_do = {
		# Add the score from having a bad modifier
		add = "scope:actor.add_static_modifier_utility(violate_treaty_of_tordesillas)"
		multiply = -1 # the modifier is bad so we need to invert it since we are removing it
		
		add = {
			desc = "bias from our colonialist policies"
			value = scope:actor.modifier:bias_for_colonialist_policies
			multiply = -1
		}
	}
}

#Increase the treaty upheld value
#Used by the Main countries during the "second phase" to keep the situation from ending
tordesillas_upheld_treaty_relevance = { 
	type = situation

	potential = {
		situation:treaty_of_tordesillas = {
			has_variable = var_west_country
			has_variable = var_east_country
		}
		OR = {
			scope:actor = situation:treaty_of_tordesillas.var:var_west_country
			scope:actor = situation:treaty_of_tordesillas.var:var_east_country
		}
		#Only Phase 1
		situation:treaty_of_tordesillas.var:var_treaty_phase = 2.0
	}
	
	price = price:tordesillas_upheld_treaty_relevance

	cooldown = {
		type = tordesillas_upheld_treaty_relevance
		years = 1
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}
	
	effect = {
		custom_tooltip = {
			text = tordesillas_upheld_treaty_relevance.tt
			situation:treaty_of_tordesillas = {
				change_variable = { name = var_treaty_progress add = 10 }
				clamp_variable = { name = var_treaty_progress max = 100 min = 0.0 } 
			}
		}
	}
	
	ai_will_do = {
		#This action should be used if the country prioritizes colonialism and the other main country has more claims that actor does to stop them from getting even more
		add =  scope:actor.societal_value:land_vs_naval
		add = {
			value = {
				add =  scope:actor.societal_value:outward_vs_inward
				multiply = -1
			}			
		}		
		if = {
			limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
			add = {
				value = {
					value = scope:actor.modifier:bias_for_colonialist_policies
				}
			}
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}

#Swap claims
#Used in the "second phase" to swap claims between two countries
tordesillas_swap_claim = { 
	type = situation

	potential = {		
		#The country has claims
		scope:actor = {
			any_colonial_claim_province_definition = {
				count > 0
			}
		}
	}
	
	price = price:tordesillas_revoke_claim

	cooldown = {
		type = tordesillas_revoke_claim
		years = 1
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
			#Only Phase 2
			situation:treaty_of_tordesillas.var:var_treaty_phase = 2.0
		}
	}
	
	select_trigger = {
		looking_for_a = area
		target_flag = target_actor_area
		interaction_source_list = {
			#Save all the areas neighboring areas claimed by other countries
			religion:catholic = {
				every_country_in_religion = {
					limit = {
						NOT = {this = scope:actor}
					}
					every_colonial_claim_province_definition = {
						area = {
							#Add it to the list if it is not repeated
							every_neighbor_area = {
								limit = {
									NOT = { is_in_list = source }
								}
								add_to_list = source
							}
						}
					}
				}
			}
		}
		name = "tordesillas_swap_claim_select_title"
		none_available_msg_key = "steal_maps_no_areas"
		column = { data = name }
		visible = {
			#Only discovered
			scope:actor = { has_discovered_area = prev }
			#Only land areas
			any_location_in_area = {
				is_land = yes
			}
			#If this area is claimed by actor
			scope:actor = {
				any_colonial_claim_province_definition = {
					area = {
						this = root
					}
				}
			}
		}
	}
	
	select_trigger = {
		looking_for_a = area
		target_flag = target_recipient_area
		interaction_source_list = {
			#Save all the areas neighboring our target area and claimed by other countries
			religion:catholic = {
				every_country_in_religion = {
					limit = {
						NOT = {this = scope:actor}
					}
					every_colonial_claim_province_definition = {
						limit = {
							area = {
								any_neighbor_area = {
									this = scope:target_actor_area
								}
								NOT = { is_in_list = source }
							}
						}
						area = {
							add_to_list = source
						}
					}
				}
			}
		}
		name = "tordesillas_swap_claim_select_title"
		none_available_msg_key = "steal_maps_no_areas"
		column = { data = name }
		visible = {
			#Only discovered
			scope:actor = { has_discovered_area = prev }
			#Only land areas
			any_location_in_area = {
				is_land = yes
			}
		}
	}
	

	effect = {
		#Get the country that has the claim on the target_recipient_area
		religion:catholic = {
			every_country_in_religion = {
				limit = {
					NOT = {this = scope:actor}
					any_colonial_claim_province_definition = {
						area = {
							scope:target_recipient_area ?= this
						}
					}
				}
				save_scope_as = target_country_scope
			}
		}
		#Launch the event that asks for the swap of the area claims
		scope:target_country_scope ?= {
			trigger_event_non_silently = { id = treaty_of_tordesillas.6 days = 7 }
		}
	}
	
	ai_will_do = {
		#This action should be used if the country prioritizes colonialism
		add =  scope:actor.societal_value:land_vs_naval
		add = {
			value = {
				add =  scope:actor.societal_value:outward_vs_inward
				multiply = -1
			}			
		}		
		if = {
			limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
			add = {
				value = {
					value = scope:actor.modifier:bias_for_colonialist_policies
				}
			}
		}
		#We lose the utility of a charter in this area
		scope:target_actor_area = {
			every_province_in_area = {
				subtract = population
				subtract = province_capital.proximity
			}
		}
		#We gain the utility of a charter in this area
		scope:target_recipient_area = {
			every_province_in_area = {
				add = population
				add = province_capital.proximity
			}
		}
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}

#Demand transfer of colony
tordesillas_demand_transfer_colony = { 
	type = situation

	potential = {
		situation:treaty_of_tordesillas = {
			has_variable = var_west_country
			has_variable = var_east_country
		}
		OR = {
			scope:actor = situation:treaty_of_tordesillas.var:var_west_country
			scope:actor = situation:treaty_of_tordesillas.var:var_east_country
		}
		#Only Phase 2
		situation:treaty_of_tordesillas.var:var_treaty_phase = 2.0
	}
	
	price = price:tordesillas_demand_transfer_colony

	cooldown = {
		type = tordesillas_demand_transfer_colony
		years = 2
	}

	select_trigger = {
		looking_for_a = situation
		target_flag = recipient
		name = "choose_situation"
		column = { data = name }
		visible = {
			situation:treaty_of_tordesillas = this
			situation_is_active = yes
		}
	}
	
	select_trigger = {
		looking_for_a = area
		target_flag = target_area
		name = "tordesillas_demand_colony_select_title"
		none_available_msg_key = "steal_maps_no_areas"
		column = { data = name }
		visible = {
			#Claimed Areas
			any_province_definition_in_area = {		
				scope:actor ?= {
					has_colonial_claim = prev
				}
			}
			#Only discovered
			scope:actor = { has_discovered_area = prev }
		}
		enabled = {			
			#Areas with other countries on them
			any_ownable_location_in_area = {
				has_owner = yes
				NOT = {top_owner ?= scope:actor}
			}
		}
	}
	
	select_trigger = {
		looking_for_a = province
		source = target_area
		target_flag = selected_province
		name = "tordesillas_demand_colony_select_title.province"
		none_available_msg_key = "increase_control_no_provinces"
		column = { data = name }
		column = { data = population }
		column = { data = province_tax_base }
		visible = {
			any_location_in_province = {
				NOT = { is_owned_or_owned_by_subjects_or_below_of = scope:actor }
			}			
		}
		#(root = location, scope:actor/recipient etc)
		map_color = {
			value = top_owner.country_color
		}
	}
	select_trigger = {
		looking_for_a = country
		interaction_source_list = {
			scope:selected_province = {
				every_location_in_province = {
					limit = {
						has_owner = yes
					}
					owner = {
						add_to_list = source
					}
				}
			}
		}
		target_flag = selected_country
		name = "tordesillas_demand_colony_select_title.country"
		none_available_msg_key = "break_others_alliance_no_countries"
		column = { data = name }
		visible = {
		}
		enabled = {
			NOT = { is_subject_or_below_of = scope:actor }
			scope:actor = {
				within_diplomatic_range = scope:selected_country
			}	
		}
		map_color = {
			value = owner.country_color
		}
	}
	
	effect = {
		#Launch the event that demands the province
		scope:selected_country ?= {
			trigger_event_non_silently = { id = treaty_of_tordesillas.5 days = 7 }
		}
		custom_tooltip = tordesillas_demand_transfer_colony.tt
	}
	
	ai_will_do = {
		#This action should be used if the country prioritizes colonialism 
		add =  scope:actor.societal_value:land_vs_naval
		add = {
			value = {
				add = scope:actor.societal_value:outward_vs_inward
				multiply = -1
			}			
		}		
		if = {
			limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
			add = {
				value = {
					value = scope:actor.modifier:bias_for_colonialist_policies
				}
			}
		}
		if = {
			limit = { scope:actor.modifier:bias_for_militarist_policies > 0 }
			add = {
				value = {
					value = scope:actor.modifier:bias_for_militarist_policies
				}
			}
		}
		
		#bias against doing anything
		subtract = {
			desc = "bias against doing stuff"
			value = 1
		}
	}
}