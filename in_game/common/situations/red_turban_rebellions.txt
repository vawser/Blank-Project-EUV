red_turban_rebellions = {
	monthly_spawn_chance = monthly_spawn_chance_unique
	can_start = {
		current_age = age_2_renaissance
		current_year > 1350
		country_exists = c:CHI
		c:CHI = {
			government_type = government_type:monarchy
			OR = {
				stability < 95
				legitimacy < 50
				weighted_calc_true_if = {
					amount >= 2
					1 = { estate_satisfaction:nobles_estate < 0.75 }
					1 = { estate_satisfaction:clergy_estate < 0.75 }
					1 = { estate_satisfaction:burghers_estate < 0.75 }
					2 = { estate_satisfaction:peasants_estate < 0.75 }
				}
				custom_tooltip = {
					text = rtr_sped_up_red_turban_rebellions
					has_variable = chi_red_turban_leader_arrested
				}
			}
		}
	}
	can_end = {
		rtr_situation_end_requirements = yes
	}
	visible = {
		OR = {
			tag = CHI
			AND = {
				country_exists = c:CHI
				OR = {
					is_neighbor_of = c:CHI
					is_subject_of = c:CHI
					is_enemy_of = c:CHI
					is_rival_of = c:CHI
				}
			}
			capital ?= {
				sub_continent ?= sub_continent:east_asia
			}
			is_member_of_international_organization = international_organization:red_turban_rebels
		}
	}
	on_start = {
		c:CHI = {
			trigger_event_non_silently = red_turban_rebellions.1
			add_to_global_variable_list = {
				name = rtr_loyal_faction
				target = c:CHI
			}
			
			remove_list_global_variable = {
				name = rtr_faction_list
				target = this
			}

		}
		every_country = {
			limit = {
				NOT = { tag = CHI }
				OR = {
					is_neighbor_of = c:CHI
					is_subject_of = c:CHI
					is_enemy_of = c:CHI
					is_rival_of = c:CHI
					capital.sub_continent = sub_continent:east_asia
				}
			}
			trigger_event_non_silently = {
				id = red_turban_rebellions.2
				days = 1
			}
		}
	}
	on_monthly = {
		c:CHI = {
			#The Song rebellion should ALWAYS happen
			trigger_event_non_silently = { id = red_turban_rebellions.3 days = { 5 15 } }
			if = {
				limit = {
					has_variable = rtr_historical_countries_to_release
					var:rtr_historical_countries_to_release > 0
				}
				random = {
					chance = 20
					switch = {
						trigger = has_variable
						rtr_release_jurchen_culture = { trigger_event_non_silently = { id = red_turban_rebellions.4 days = { 5 15 } } }
						rtr_release_tag_CTW = { trigger_event_non_silently = { id = red_turban_rebellions.5 days = { 5 15 } } }
						rtr_release_tag_CHE = { trigger_event_non_silently = { id = red_turban_rebellions.6 days = { 5 15 } } }
						rtr_release_tag_WUU = { trigger_event_non_silently = { id = red_turban_rebellions.7 days = { 5 15 } } }
						rtr_release_tag_CFN = { trigger_event_non_silently = { id = red_turban_rebellions.8 days = { 5 15 } } }
						rtr_release_tag_CMO = { trigger_event_non_silently = { id = red_turban_rebellions.9 days = { 5 15 } } }
						rtr_release_tag_CXI = { trigger_event_non_silently = { id = red_turban_rebellions.10 days = { 5 15 } } }
						rtr_release_tag_CGU = { trigger_event_non_silently = { id = red_turban_rebellions.11 days = { 5 15 } } }
						rtr_release_tag_MNG = { trigger_event_non_silently = { id = red_turban_rebellions.12 days = { 5 15 } } }
						rtr_release_tag_CNP = { trigger_event_non_silently = { id = red_turban_rebellions.13 days = { 5 15 } } }
						rtr_release_tag_CDN = { trigger_event_non_silently = { id = red_turban_rebellions.14 days = { 5 15 } } }
						rtr_release_tag_CSI = { trigger_event_non_silently = { id = red_turban_rebellions.15 days = { 5 15 } } }
						rtr_release_tag_CKO = { trigger_event_non_silently = { id = red_turban_rebellions.16 days = { 5 15 } } }
						rtr_release_tag_CNA = { trigger_event_non_silently = { id = red_turban_rebellions.17 days = { 5 15 } } }
					}
				}
			}
			#Releasing a generic culture tag should happen very rarely
			if = {
				limit = {
					has_variable = rtr_historical_countries_to_release
					var:rtr_historical_countries_to_release < 4
					var:rtr_country_additional_releaser_counter > 0
				}
				random = {
					chance = 1
					modifier = {
						var:rtr_historical_countries_to_release < 3
						add = 1
					}
					modifier = {
						var:rtr_historical_countries_to_release < 2
						add = 1
					}
					modifier = {
						var:rtr_historical_countries_to_release < 1
						add = 1
					}
					trigger_event_non_silently = { id = red_turban_rebellions.18 days = { 20 50 } }
				}
			}
			random_list = {
				10 = { trigger_event_non_silently = red_turban_rebellions.20 }
				10 = { trigger_event_non_silently = red_turban_rebellions.21 }
				500 = {}
			}

			random = { chance = 5 trigger_event_non_silently = red_turban_rebellions.40 }
			random = { chance = 5 trigger_event_non_silently = red_turban_rebellions.41 }
			random = { chance = 10 trigger_event_non_silently = red_turban_rebellions.42 }
			random = { chance = 10 trigger_event_non_silently = red_turban_rebellions.43 }
			random = { chance = 10 trigger_event_non_silently = red_turban_rebellions.44 }
		}
		random = {
			chance = 2
			c:KOR = { trigger_event_non_silently = red_turban_rebellions.1000 }
		}
	}
	on_ended = {
		if = {
			limit = {
				country_exists = c:CHI
			}
			c:CHI = {
				if = {
					limit = { has_country_modifier = chi_red_turban_propaganda }
					remove_country_modifier = chi_red_turban_propaganda
				}
				remove_variable = chi_rtr_modifier_intensity
			}
		}
		
		if = {
			limit = {
				exists = international_organization:red_turban_rebels.leader_country
				international_organization:middle_kingdom = {
					any_international_organization_owned_location = {
						is_owned_or_owned_by_subjects_or_below_of = international_organization:red_turban_rebels.leader_country
						percent >= 0.65
					}
				}
			}
			international_organization:red_turban_rebels = {
				leader_country = {
					trigger_event_non_silently = red_turban_rebellions.100
				}
			}
		}
		else_if = {
			limit = {
				c:CHI ?= {
					legitimacy >= 90
					stability >= 30
					current_celestial_authority = { value = 50 }
					international_organization:red_turban_rebels = { total_members < 1 }
				}
			}
			c:CHI = {
				trigger_event_non_silently = red_turban_rebellions.103
			}
		}
		else = {
			if = { #Yuán still exists
				limit = { country_exists = c:CHI }
				c:CHI = { save_scope_as = new_china }
			}
			else_if = { #Yuán doesn't exist but there's a leader of the red turban rebels
				limit = {
					international_organization:red_turban_rebels ?= {
						exists = leader_country
					}
				}
				international_organization:red_turban_rebels.leader_country = { save_scope_as = new_china }
			}
			else_if = { #Neither Yuán, the middle kingdom, or the red turban rebels exist
				limit = {
					location:dadu.owner ?= {
						culture = {
							OR = {
								has_culture_group = culture_group:chinese_group
								has_culture_group = culture_group:mongolian_group
								has_culture_group = culture_group:jurchen_group
							}
						}
					}
				}
				location:dadu.owner = { save_scope_as = new_china }
			}
			else_if = {
				limit = {
					location:shangyuan.owner ?= {
						culture = {
							OR = {
								has_culture_group = culture_group:chinese_group
								has_culture_group = culture_group:mongolian_group
								has_culture_group = culture_group:jurchen_group
							}
						}
					}
				}
				location:shangyuan.owner = { save_scope_as = new_china }
			}
			else = {
				sub_continent:east_asia = {
					ordered_present_country = {
						limit = {
							culture = {
								OR = {
									has_culture_group = culture_group:chinese_group
									has_culture_group = culture_group:mongolian_group
									has_culture_group = culture_group:jurchen_group
								}
							}
						}
						order_by = total_population
						max = 1
						save_scope_as = new_china
					}
				}
			}
			if = {
				limit = {
					NOT = { exists = international_organization:middle_kingdom }
				}
				every_country = {
					limit = {
						OR = {
							capital.sub_continent = sub_continent:east_asia
							is_member_of_international_organization = international_organization:red_turban_rebels
						}
					}
					trigger_event_non_silently = red_turban_rebellions.105
				}
			}
			else = {
				every_country = {
					limit = {
						OR = {
							capital.sub_continent = sub_continent:east_asia
							is_member_of_international_organization = international_organization:red_turban_rebels
						}
					}
					trigger_event_non_silently = red_turban_rebellions.106
				}
			}
			destroy_international_organization_no_instigator = { target = international_organization:red_turban_rebels }
		}
		if = {
			limit = { country_exists = c:CHI }
			c:CHI = {
				if = {
					limit = { has_country_modifier = rtr_red_turban_rebellions }
					remove_country_modifier = rtr_red_turban_rebellions
				}
			}
		}
	}
	tooltip = {
		if = {
			limit = { owner = c:CHI }
			custom_tooltip = RTR_EMPEROR
		}
		else_if = {
			limit = {
				has_owner = yes
				exists = international_organization:red_turban_rebels
				owner ?= {
					is_leader_of_international_organization = international_organization:red_turban_rebels
				}
			}
			custom_tooltip = RTR_STRONGEST_REBEL
		}
		else_if = {
			limit = {	
				has_owner = yes
				owner ?= { 
					has_reform = government_reform:warring_state
					OR = {
						is_allied_with = { target = c:CHI }
						var:rtr_yuan_allegiance >= 50
					}
				}
			}
			custom_tooltip = RTR_LOYALIST
		}
		else_if = {
			limit = {	
				has_owner = yes
				owner ?= { 
					has_reform = government_reform:warring_state
					OR = {
						is_at_war_with = c:CHI
						var:rtr_yuan_allegiance < 0
					}
				}
			}
			custom_tooltip = RTR_REBEL
		}
		else_if = {
			limit = {	
				has_owner = yes
				owner ?= { 
					has_reform = government_reform:warring_state
				}
			}
			custom_tooltip = RTR_NEUTRAL
		}
	}
	map_color = {
		if = {
			limit = { 
				has_owner = yes
				owner ?= c:CHI 
			}
			value = rtr_emperor_color
		}
		else_if = {
			limit = {
				has_owner = yes
				exists = international_organization:red_turban_rebels
				owner ?= {
					is_leader_of_international_organization = international_organization:red_turban_rebels
				}
			}
			value = rtr_strongest_rebel_color
		}
		else_if = {
			limit = {	
				has_owner = yes
				owner ?= { 
					has_reform = government_reform:warring_state
					OR = {
						is_allied_with = { target = c:CHI }
						AND = {
							has_variable = rtr_yuan_allegiance
							var:rtr_yuan_allegiance > 50
						}
					}
				}
			}
			value = rtr_loyalist_color
		}
		else_if = {
			limit = {	
				has_owner = yes
				owner ?= { 
					has_reform = government_reform:warring_state
					OR = {
						is_at_war_with = c:CHI
						AND = {
							has_variable = rtr_yuan_allegiance
							var:rtr_yuan_allegiance < -25
						}
					}
				}
			}
			value = rtr_rebel_color
		}
		else_if = {
			limit = {	
				has_owner = yes
				owner ?= { 
					has_reform = government_reform:warring_state
				}
			}
			value = rtr_neutral_color
		}
	}
	
	legend_key = { 
		desc = "emperor"
		color = rtr_emperor_color
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "STATIC_MODIFIER_NAME_rebel_leader_modifier"
		color = rtr_strongest_rebel_color
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "loyalist"
		color = rtr_loyalist_color
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "game_concept_rebel"
		color = rtr_rebel_color
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "RTR_NEUTRALS_TITLE"
		color = rtr_neutral_color
		require_color_on_map = yes
	}
}