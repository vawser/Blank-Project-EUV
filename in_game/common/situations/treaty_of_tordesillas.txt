treaty_of_tordesillas = {
	monthly_spawn_chance = 0

	can_start = {
		#Activated by treaty_of_tordesillas.2
		always = no
	}

	can_end = {
		#If the situation has reached the second phase and treaty relevance 
		situation:treaty_of_tordesillas.var:var_treaty_phase = 2.0
		situation:treaty_of_tordesillas.var:var_treaty_progress <= 0.0
	}
	visible = {
		religion ?= religion:catholic
		
		#On the first Stage
		trigger_if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
			}
			#only Signatory countries
			OR = {
				this = situation:treaty_of_tordesillas.var:var_west_country
				this = situation:treaty_of_tordesillas.var:var_east_country
			}
		}
	}

	on_start = {
		#Settlement of the Treaty Progress
		set_variable = {
			name = var_treaty_progress
			value = { value = 0.0 }
		}
		set_variable = {
			name = var_treaty_phase
			value = { value = 1.0 }
		}
		set_variable = {
			name = var_treaty_subtract
			value = { value = 0.1 }
		}
		#Create the cost multipliers for the "Move the Line" action
		#Keeps track of the amount of times that they have used the action + 1
		situation:treaty_of_tordesillas.var:var_west_country = {
			set_variable = {
				name = var_tordesillas_moved_the_line
				value = 1
			}
		}
		situation:treaty_of_tordesillas.var:var_east_country = {
			set_variable = {
				name = var_tordesillas_moved_the_line
				value = 1
			}
		}
		#Fallback treaty location
		if = {
			limit = {
				NOT = {exists = var:treaty_location}
			}
			set_variable = {
				name = treaty_location
				value = location:tordesillas
			}
		}
		#Fallback colony location
		if = {
			limit = {
				NOT = {exists = var:var_east_colony}
			}
			set_variable = {
				name = var_east_colony
				value = location:kururupu
			}
		}
		if = {
			limit = {
				NOT = {exists = var:var_west_colony}
			}
			set_variable = {
				name = var_west_colony
				value = location:lokono
			}
		}
		#Fallback countries
		if = {
			limit = {
				NOT = {exists = var:var_east_country}
			}
			set_variable = {
				name = var_east_country
				value = var:var_east_colony.owner
			}
		}
		if = {
			limit = {
				NOT = {exists = var:var_west_country}
			}
			set_variable = {
				name = var_west_country
				value = var:var_west_colony.owner
			}
		}
		
		#Create the Division Line Origin
		set_variable = {
			name = var_line_location
			value = var:var_east_colony #Choosing the easternmost point
		}
		#Claim all non conflicting areas where the countries have colonies
		claim_non_conflicting_owned_areas = {
			the_owner = var:var_west_country
		}
		claim_non_conflicting_owned_areas = {
			the_owner = var:var_east_country
		}
		
	}

	on_monthly = {
		#On the first Stage
		if = {
			limit = {
				var:var_treaty_phase = 1.0
			}
			#Move the progress forward
			change_variable = { name = var_treaty_progress add = 0.5 }
			clamp_variable = { name = var_treaty_progress max = 100 min = 0.0 } 

			#If the treaty is complete
			if = {
				limit = {
					var:var_treaty_progress >= 100
				}
				set_variable = { name = var_treaty_progress value = { value = 100 } }
				set_variable = { name = var_treaty_phase value = { value = 2.0 } }

				#Launch treaty complete event
				religion:catholic = {		
					every_country_in_religion = {
						trigger_event_silently = {
							id = treaty_of_tordesillas.3
						}
					}
				}
				distribute_world = yes
			}
		}
		else_if = {			
			#On the second Stage
			limit = {
				var:var_treaty_phase = 2.0
			}
			#Move the relevance value downwards
			set_variable = { name = var_treaty_subtract value = 0.0 }
			religion:catholic = {
				every_country_in_religion = {
					limit = {
						has_country_modifier = violate_treaty_of_tordesillas
					}
					situation:treaty_of_tordesillas = {
						change_variable = { name = var_treaty_subtract add = 0.1 }
					}
				}
			}
			change_variable = { name = var_treaty_subtract add = 0.1 }
			change_variable = { name = var_treaty_progress subtract = var:var_treaty_subtract }
			clamp_variable = { name = var_treaty_progress max = 100 min = 0.0 }

		}
	}

	on_ending = {
		religion:catholic = {
			every_country_in_religion = {
				limit = {
					can_see_situation = situation:treaty_of_tordesillas
				}
				trigger_event_non_silently = treaty_of_tordesillas.4
			}
		}
	}

	on_ended = {
		#Remove all claims
		var:var_east_country ?= {
			every_colonial_claim_province_definition = {
				remove_colonial_claim = this
			}
			#Remove modifiers
			religion = {
				every_country_in_religion = {
					limit = {
						has_country_modifier = violate_treaty_of_tordesillas
					}
					remove_country_modifier = violate_treaty_of_tordesillas
				}
			}
		}
		var:var_west_country ?= {
			every_colonial_claim_province_definition = {
				remove_colonial_claim = this
			}
		}
	}

	tooltip = {
		#Location is west of the Line
		if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
				is_location_claimable = yes
				NOT ={
					is_east_of = scope:target.var:var_line_location
				}
			}
			custom_tooltip = "treaty_of_tordesillas.tt.location_is_west_of_line"
		}
		else_if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
				is_location_claimable = yes
				is_east_of = scope:target.var:var_line_location
			}
			custom_tooltip = "treaty_of_tordesillas.tt.location_is_east_of_line"
		}
		#Location is the Origin of the Line
		if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
				situation:treaty_of_tordesillas = {
					has_variable = var_line_location
				}
				situation:treaty_of_tordesillas.var:var_line_location ?= this
			}
			custom_tooltip = "treaty_of_tordesillas.tt.location_is_line_origin"
		}
		#Location is controlled by a Main country
		if = {
			limit = {
				situation:treaty_of_tordesillas = {
					has_variable = var_east_country
				}
				has_owner = yes
				top_owner ?= situation:treaty_of_tordesillas.var:var_east_country
			}
			custom_tooltip = "treaty_of_tordesillas.tt.location_is_first_country"
		}
		else_if = {
			limit = {
				situation:treaty_of_tordesillas = {
					has_variable = var_west_country
				}
				has_owner = yes
				top_owner ?= situation:treaty_of_tordesillas.var:var_west_country
			}
			custom_tooltip = "treaty_of_tordesillas.tt.location_is_second_country"
		}
		#Location is claimed by a Main country
		else_if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_east_country ?= {
					has_colonial_claim = root.province_definition
				}
			}
			custom_tooltip = "treaty_of_tordesillas.tt.location_is_claim_of_first_country"
		}
		else_if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_west_country ?= {
					has_colonial_claim = root.province_definition
				}
			}
			custom_tooltip = "treaty_of_tordesillas.tt.location_is_claim_of_second_country"
		}
		#This area has a conflict, more than one colony
		else_if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
				area = {
					#This area has a conflict, more than one colony
					any_ownable_location_in_area = {
						has_owner = yes
						is_owned_or_owned_by_subjects_or_below_of = scope:target.var:var_east_country
					}
					any_ownable_location_in_area = {
						has_owner = yes
						is_owned_or_owned_by_subjects_or_below_of = scope:target.var:var_west_country
					}
				}
			}
			custom_tooltip = "treaty_of_tordesillas.tt.location_is_in_conflict"
		}
	}

	map_color = {
		#Location is controlled by a Main country
		if = {
			limit = {
				scope:target ?= {
					has_variable = var_east_country
				}
				has_owner = yes
				top_owner ?= scope:target.var:var_east_country
			}
			value = top_owner.country_color
		}
		else_if = {
			limit = {
				scope:target ?= {
					has_variable = var_west_country
				}
				has_owner = yes
				top_owner ?= scope:target.var:var_west_country
			}
			value = top_owner.country_color
		}
		#Neutral
		else = {
			value = define:NMapColors|DEFAULT_COLOR
		}
		
		#Location is the Origin of the Line
		if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
				scope:target = {
					has_variable = var_line_location
				}
				scope:target.var:var_line_location ?= this
			}
			value = rgb { 0.502 0 0.612 } #dark purple
		}
		
	}
	
	legend_key = {
		limit = {
			scope:target ?= {
				has_variable = var_east_country
			}
			has_owner = yes
			top_owner ?= scope:target.var:var_east_country
		}
		desc = "EAST"
		color = top_owner.country_color
	}
	legend_key = {
		limit = {
			scope:target ?= {
				has_variable = var_west_country
			}
			has_owner = yes
			top_owner ?= scope:target.var:var_west_country
		}
		desc = "WEST"
		color = top_owner.country_color
	}

	secondary_map_color = {
		#Location is west of the Line
		if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
				is_location_colonial = yes
				NOT ={
					is_east_of = scope:target.var:var_line_location
				}
			}
			value = {
				lerp = {
					min_color = scope:target.var:var_west_country.country_color
					max_color = define:NMapColors|DEFAULT_COLOR
					factor = 0.40
				}
			}
		}
		#Location is east of the Line
		else_if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
				is_location_colonial = yes
				is_east_of = scope:target.var:var_line_location
			}
			value = {
				lerp = {
					min_color = scope:target.var:var_east_country.country_color
					max_color = define:NMapColors|DEFAULT_COLOR
					factor = 0.40
				}
			}
		}
		#Location has a claim or is controlled by a Main country
		if = {
			limit = {
				is_location_claimed_or_owned_by_country = {
					owner_country = scope:target.var:var_east_country
				}
			}
			value = scope:target.var:var_east_country.country_color
		}
		else_if = {
			limit = {
				is_location_claimed_or_owned_by_country = {
					owner_country = scope:target.var:var_west_country
				}
			}
			value = scope:target.var:var_west_country.country_color
		}
		else_if = {
			limit = {
				situation:treaty_of_tordesillas.var:var_treaty_phase = 1.0
				area = {
					#This area has a conflict, more than one colony
					any_ownable_location_in_area = {
						has_owner = yes
						is_owned_or_owned_by_subjects_or_below_of = scope:target.var:var_east_country
					}
					any_ownable_location_in_area = {
						has_owner = yes
						is_owned_or_owned_by_subjects_or_below_of = scope:target.var:var_west_country
					}
				}
			}
			value = define:NMapColors|MAP_COLOR_LOW
		}
	}
}
