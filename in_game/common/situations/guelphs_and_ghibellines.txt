guelphs_and_ghibellines = {
	voters = guelphs_and_ghibellines_voters
	monthly_spawn_chance = monthly_spawn_chance_unique
	
	can_start = {
		game_is_initialized = yes
		current_date > 1337.4.1
	}
	
	can_end = {
		guelphs_and_ghibellines_end_trigger = yes
	}
	
	visible = {
		OR = { #The Pope and Emperor can see it every Italian country is involved
			has_presence_in = region:italy_region
			tag = PAP
			is_leader_of_international_organization = international_organization:hre
			is_member_of_international_organization = international_organization:guelphs_io
			is_member_of_international_organization = international_organization:ghibellines_io
		}
	}
	

	on_start = { #Introduction Events for all initial participants
		set_variable = { name = guelphs_progress value = 0 }
		set_variable = { name = ghibellines_progress value = 0 }
		add_to_global_variable_list = { name = guelphs_and_ghibellines_voters target = international_organization:guelphs_io }
		every_country = {
			limit = {
				OR = {
					is_member_of_international_organization = international_organization:guelphs_io
					is_member_of_international_organization = international_organization:ghibellines_io
					has_presence_in = region:italy_region
					is_leader_of_international_organization = international_organization:hre
				}
			}
			add_to_global_variable_list = { name = guelphs_and_ghibellines_voters target = international_organization:ghibellines_io }
			add_to_global_variable_list = { name = guelphs_and_ghibellines_voters target = international_organization:guelphs_io }
			trigger_event_non_silently = guelphs_and_ghibellines.1
			if = {
				limit = {
					NOT = { tag = PAP }
				}
				trigger_event_non_silently = {
					id = guelphs_and_ghibellines.2
					days = 20
				}
			}
			if = {
				limit = { country_exists = c:PAP }
				c:PAP = {
					if = {
						limit = {
							NOT = { is_member_of_international_organization = international_organization:guelphs_io }
							can_join_international_organization = international_organization:guelphs_io
						}
						international_organization:guelphs_io = {
							add_country_to_international_organization = root
						}
					}
				}
			}
		}
		c:PAP = {
			trigger_event_non_silently = {
				id = guelphs_and_ghibellines.3
				days = 20
			}
		}

		religion:catholic = {
			ordered_country_in_religion = {  
				limit = {
					capital.region = region:italy_region
					NAND = {
						is_allied_with = { target = c:PAP }
						OR = {
							AND = {
								is_subject_of = c:PAP
								liberty_desire < 50
							}
							AND = {
								is_subject = yes 
								NOT = { is_subject_of = c:PAP }
							}
						}
						is_during_bankruptcy = yes
					}
				}
				order_by = country_tax_base
				max = 1
				check_range_bounds = no
			}
		}
	}

	on_monthly = {
		hidden_effect = {
			#event for neutral countries in the situation but not in an io
			c:PAP ?= {
				if = {
					limit = {
						NOR = {
							is_member_of_international_organization = international_organization:guelphs_io
							is_member_of_international_organization = international_organization:ghibellines_io
						}
					}
					random_list = {
						2 = { trigger_event_non_silently = guelphs_and_ghibellines.9 }
						98 = { }
					}
				}
			}
			international_organization:hre.leader_country ?= {
				if = {
					limit = {
						NOR = {
							is_member_of_international_organization = international_organization:guelphs_io
							is_member_of_international_organization = international_organization:ghibellines_io
						}
					}
					random_list = {
						2 = { trigger_event_non_silently = guelphs_and_ghibellines.9 }
						98 = { }
					}
				}
			}
			region:italy_region = {
				every_present_country = {
					limit = {
						NOR = {
							tag = PAP
							is_leader_of_international_organization = international_organization:hre
							is_member_of_international_organization = international_organization:guelphs_io
							is_member_of_international_organization = international_organization:ghibellines_io
						}
					}
					random_list = {
						2 = { trigger_event_non_silently = guelphs_and_ghibellines.9 }
						98 = { }
					}
				}
			}
			
			set_variable = {
				name = gag_total_tax
				value = 0
			}
			region:italy_region = {
				every_location_in_region = {
					limit = { is_capital = yes }
					owner = {
						root = {
							change_variable = {
								name = gag_total_tax
								add = prev.country_tax_base
							}
						}
					}
				}
			}
			set_local_variable = {
				name = guelphs_total_tax
				value = 0
			}
			international_organization:guelphs_io = {
				every_international_organization_member = {
					root = {
						change_local_variable = {
							name = guelphs_total_tax
							add = prev.country_tax_base
						}
					}
				}
			}
			set_local_variable = {
				name = ghibellines_total_tax
				value = 0
			}
			international_organization:ghibellines_io = {
				every_international_organization_member = {
					root = {
						change_local_variable = {
							name = ghibellines_total_tax
							add = prev.country_tax_base
						}
					}
				}
			}
			change_variable = {
				name = gag_total_tax
				multiply = 400
			}
			if = {
				limit = {
					var:gag_total_tax > 1
				}
				change_local_variable = { #tracking guelph progress
					name = guelphs_total_tax
					divide = var:gag_total_tax
				}
				change_local_variable = { #tracking ghibellines progress
					name = ghibellines_total_tax
					divide = var:gag_total_tax
				}
			}
			else = {
				set_local_variable = { #tracking guelph progress
					name = guelphs_total_tax
					value = 0
				}
				set_local_variable = { #tracking ghibellines progress
					name = ghibellines_total_tax
					value = 0
				}
			}

			#guelphs progress
			international_organization:guelphs_io ?= {
				if = {
					limit = { not = { has_variable = guelphs_progress } }
					set_variable = { name = guelphs_progress value = 0 }
				}
				set_variable = { name = guelphs_progress_monthly value = 0 }
				change_variable = {
					name = guelphs_progress
					add = local_var:guelphs_total_tax
				}
				change_variable = {
					name = guelphs_progress_monthly
					add = local_var:guelphs_total_tax
				}
			}
			#ghibellines progress
			international_organization:ghibellines_io ?= {
				if = {
					limit = { not = { has_variable = ghibellines_progress } }
					set_variable = { name = ghibellines_progress value = 0 }
				}
				set_variable = { name = ghibellines_progress_monthly value = 0 }
				change_variable = {
					name = ghibellines_progress
					add = local_var:ghibellines_total_tax
				}
				change_variable = {
					name = ghibellines_progress_monthly
					add = local_var:ghibellines_total_tax
				}
			}
		}
	}


	on_ended = {
		if = {
			limit = { international_organization:guelphs_io = { var:guelphs_progress >= 1 } }
			set_global_variable = { name = guelphs_and_ghibellines_ended value = 1 }
		}
		else_if = {
			limit = { international_organization:ghibellines_io = { var:ghibellines_progress >= 1 } }
			set_global_variable = { name = guelphs_and_ghibellines_ended value = -1 }
		}
		else = {
			set_global_variable = { name = guelphs_and_ghibellines_ended value = 0 }
		}
		international_organization:guelphs_io ?= {
			if = {
				limit = { var:guelphs_progress >= 1 }
				international_organization:guelphs_io ?= { every_international_organization_member = { trigger_event_non_silently = guelphs_and_ghibellines.4 } }
				international_organization:ghibellines_io ?= { every_international_organization_member = { trigger_event_non_silently = guelphs_and_ghibellines.5 } }
			}
		}
		international_organization:ghibellines_io ?= {
			if = {
				limit = { var:ghibellines_progress >= 1 }
				international_organization:ghibellines_io ?= { every_international_organization_member = { trigger_event_non_silently = guelphs_and_ghibellines.6 } }
				international_organization:guelphs_io ?= { every_international_organization_member = { trigger_event_non_silently = guelphs_and_ghibellines.7 } }
			}
		}
		if = {
			limit = { current_age_or_later = { age = age_3_discovery } }
			international_organization:ghibellines_io ?= { every_international_organization_member = { trigger_event_non_silently = guelphs_and_ghibellines.8 } }
			international_organization:guelphs_io ?= { every_international_organization_member = { trigger_event_non_silently = guelphs_and_ghibellines.8 } }
		}
		if = {
			limit = { country_exists = c:PAP }
			c:PAP = { trigger_event_non_silently = { id = guelphs_and_ghibellines.10 days = 3 } }
		}
		else_if = {
			limit = {
				global_var:guelphs_and_ghibellines_ended = 1
				international_organization:guelphs_io ?= { international_organization_has_leader = yes }
			}
			international_organization:guelphs_io = {
				leader_country ?= { trigger_event_non_silently = { id = guelphs_and_ghibellines.10 days = 3 } }
			}
		}
		else_if = {
			limit = {
				global_var:guelphs_and_ghibellines_ended = -1
				international_organization:ghibellines_io ?= { international_organization_has_leader = yes }
			}
			international_organization:ghibellines_io = {
				leader_country ?= { trigger_event_non_silently = { id = guelphs_and_ghibellines.10 days = 3 } }
			}
		}
		else = {
			random_country = {
				limit = { capital.sub_continent = sub_continent:western_europe }
				trigger_event_non_silently = { id = guelphs_and_ghibellines.10 days = 3 }
			}
		}
	}

	tooltip = {
		if = {
			limit = {
				has_owner = yes
				owner ?= {
					is_member_of_international_organization = international_organization:guelphs_io
					is_leader_of_international_organization = international_organization:guelphs_io
				}
			}
			custom_tooltip = guelphs_side_leader.tt
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					is_member_of_international_organization = international_organization:ghibellines_io
					is_leader_of_international_organization = international_organization:ghibellines_io
				}
			}
			custom_tooltip = ghibellines_side_leader.tt
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= { is_member_of_international_organization = international_organization:guelphs_io }
			}
			custom_tooltip = guelphs_side.tt
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= { is_member_of_international_organization = international_organization:ghibellines_io }
			}
			custom_tooltip = ghibellines_side.tt
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					NOT = {
						OR = {
							is_member_of_international_organization = international_organization:guelphs_io
							is_member_of_international_organization = international_organization:ghibellines_io
						}
					}
				}
			}
			custom_tooltip = guelphs_ghibellines_neutral.tt
		}
	}

	map_color = {
		if = {
			limit = {
				has_owner = yes
				owner ?= {
					is_member_of_international_organization = international_organization:guelphs_io
					is_leader_of_international_organization = international_organization:guelphs_io
				}
			}
			value = gag_guelphs_leader_color
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					is_member_of_international_organization = international_organization:ghibellines_io
					is_leader_of_international_organization = international_organization:ghibellines_io
				}
			}
			value = gag_ghibellines_leader_color
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= { is_member_of_international_organization = international_organization:guelphs_io }
			}
			value = gag_guelphs_color
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= { is_member_of_international_organization = international_organization:ghibellines_io }
			}
			value = gag_ghibellines_color
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					NOT = {
						OR = {
							is_member_of_international_organization = international_organization:guelphs_io
							is_member_of_international_organization = international_organization:ghibellines_io
						}
					}
				}
			}
			value = rtr_neutral_color
		}
		else = {
			value = define:NMapColors|DEFAULT_COLOR
		}
	}
	
	legend_key = { 
		desc = "GAG_GUELPH_LEADER"
		color = gag_guelphs_leader_color
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "GAG_GHIBELLINES_LEADER"
		color = gag_ghibellines_leader_color
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "GAG_GUELPH_SUPPORTER"
		color = gag_guelphs_color
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "GAG_GHIBELLINE_SUPPORTER"
		color = gag_ghibellines_color
		require_color_on_map = yes
	}
}
