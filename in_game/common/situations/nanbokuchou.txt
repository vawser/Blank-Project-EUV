nanbokuchou = {
	monthly_spawn_chance = monthly_spawn_chance_unique
	resolution = "nanbokuchou_resolution"
	voters = nanbokuchou_voters
	
	can_start = {
		current_date > 1336.1.1
		international_organization:japanese_shogunate ?= {
			"num_countries_with_special_status(special_status:japanese_emperor)" > 1
		}
	}
	
	can_end = {
		nanbokuchou_end_trigger = yes
	}
	
	visible = {
		is_member_of_international_organization = international_organization:japanese_shogunate
	}

	on_start = {
		work_of_art:kusanagi_no_tsurugi = { set_art_owner = c:STC }
		work_of_art:yata_no_kagami = { set_art_owner = c:STC }
		work_of_art:yasakani_no_magatama = { set_art_owner = c:STC }

		c:STC = {
			add_to_global_variable_list = { name = nanbokuchou_voters target = this }
			propose_resolution = {
				resolution = resolution:nanbokuchou_resolution
				actor = this
				recipient = situation:nanbokuchou
				vote = this
			}
		}

		international_organization:japanese_shogunate = {
			every_international_organization_member = { 
				limit = { this != c:STC }
				if = {
					limit = { has_variable = supports_northern_court }
					add_to_global_variable_list = { name = nanbokuchou_northern_supporters target = this }
					situation:nanbokuchou = {
						set_vote = {
							voter = prev
							resolution = resolution:nanbokuchou_resolution
							vote = c:NTC
							locked = yes
						}
					}
				}
				if = {
					limit = { has_variable = supports_southern_court }
					add_to_global_variable_list = { name = nanbokuchou_southern_supporters target = this }
					situation:nanbokuchou = {
						set_vote = {
							voter = prev
							resolution = resolution:nanbokuchou_resolution
							vote = c:STC
							locked = yes
						}
					}
				}
				if = {
					limit = {
						NOT = { has_variable = supports_northern_court }
						NOT = { has_variable = supports_southern_court }
					}
					add_to_global_variable_list = { name = nanbokuchou_neutral_countries target = this }
					situation:nanbokuchou = {
						set_vote = {
							voter = prev
							resolution = resolution:nanbokuchou_resolution
							locked = yes
						}
					}
				}

				add_country_modifier = { modifier = jap_nanbokuchou years = -1 mode = add }
				trigger_event_non_silently = nanbokuchou.1
				add_to_global_variable_list = { name = nanbokuchou_voters target = this }
			}
		}
	}

	on_monthly = {
		#Update variables
		clear_global_variable_list = nanbokuchou_northern_supporters
		clear_global_variable_list = nanbokuchou_southern_supporters
		clear_global_variable_list = nanbokuchou_neutral_countries
		if = {
			limit = { country_exists = c:NTC }
			add_to_global_variable_list = {
				name = nanbokuchou_northern_supporters
				target = c:NTC
			}
		}
		if = {
			limit = { country_exists = c:JAP }
			add_to_global_variable_list = {
				name = nanbokuchou_northern_supporters
				target = c:JAP
			}
		}
		if = {
			limit = { country_exists = c:STC }
			add_to_global_variable_list = {
				name = nanbokuchou_southern_supporters
				target = c:STC
			}
		}
		international_organization:japanese_shogunate = {
			every_international_organization_member = {
				limit = {
					NOR = {
						tag = NTC
						tag = STC
						tag = JAP
					}
				}
				if = {
					limit = { has_variable = supports_northern_court }
					add_to_global_variable_list = { name = nanbokuchou_northern_supporters target = this }
				}
				if = {
					limit = { has_variable = supports_southern_court }
					add_to_global_variable_list = { name = nanbokuchou_southern_supporters target = this }
				}
				if = {
					limit = {
						NOT = { has_variable = supports_northern_court }
						NOT = { has_variable = supports_southern_court }
					}
					add_to_global_variable_list = { name = nanbokuchou_neutral_countries target = this }
				}
			}
		}

		random_list = {
			20 = { #Event for changing sides
				trigger = { #If there's a clan that hates their current side
					country_exists = c:NTC
					country_exists = c:STC
					international_organization:japanese_shogunate = {
						any_international_organization_member = {
							AND = {
								is_japanese_emperor_or_shogun = no
								OR = {
									AND = {
										has_variable = supports_northern_court
										OR = {
											AND = {
												exists = international_organization:japanese_shogunate.leader_country
												opinion = {
													target = international_organization:japanese_shogunate.leader_country
													value <= -50
												}
											}
											opinion = {	target = c:NTC value <= -50 }
										}
										opinion = { target = c:STC value >= 0 }
									}
									AND = {
										has_variable = supports_southern_court
										opinion = { target = c:STC value <= -50 }
										OR = {
											AND = {
												exists = international_organization:japanese_shogunate.leader_country
												opinion = {
													target = international_organization:japanese_shogunate.leader_country
													value >= 0
												}
											}
											opinion = {	target = c:NTC value >= 0 }
										}
									}
								}
							}
						}
					}
				}
				international_organization:japanese_shogunate = {
					random_international_organization_member = {
						limit = {
							is_japanese_emperor_or_shogun = no
							OR = {
								AND = {
									has_variable = supports_northern_court
									OR = {
										AND = {
											exists = international_organization:japanese_shogunate.leader_country
											opinion = {
												target = international_organization:japanese_shogunate.leader_country
												value <= -50
											}
										}
										opinion = {	target = c:NTC value <= -50 }
									}
									opinion = { target = c:STC value >= 0 }
								}
								AND = {
									has_variable = supports_southern_court
									opinion = { target = c:STC value <= -50 }
									OR = {
										AND = {
											exists = international_organization:japanese_shogunate.leader_country
											opinion = {
												target = international_organization:japanese_shogunate.leader_country
												value >= 0
											}
										}
										opinion = {	target = c:NTC value >= 0 }
									}
								}
							}
						}
						trigger_event_non_silently = nanbokuchou.3
					}
				}
			}

			20 = { #Event for losing purity due to war
				trigger = {
					country_exists = c:NTC
					country_exists = c:STC
					international_organization:japanese_shogunate = {
						any_international_organization_member = {
							at_war = yes
						}
					}
				}
				international_organization:japanese_shogunate = {
					random_international_organization_member = {
						limit = { at_war = yes }
						trigger_event_non_silently = nanbokuchou.5
					}
				}
			}

			20 = { #Event for giving cbs
				trigger = {
					international_organization:japanese_shogunate = {
						any_international_organization_member = {
							is_valid_nanbokuchou_cb_target = yes
						}
					}
				}
				international_organization:japanese_shogunate = {
					random_international_organization_member = {
						limit = { is_valid_nanbokuchou_cb_target = yes }
						trigger_event_non_silently = nanbokuchou.6
					}
				}
			}

			20 = { #Event for starting wars
				trigger = {
					international_organization:japanese_shogunate = {
						any_international_organization_member = {
							is_subject = no
							is_valid_nanbokuchou_war_target = yes
						}
					}
				}
				international_organization:japanese_shogunate = {
					random_international_organization_member = {
						limit = { is_valid_nanbokuchou_war_target = yes }
						trigger_event_non_silently = nanbokuchou.7
					}
				}
			}

			20 = { #Event for a new line of the imperial line
				trigger = {
					international_organization:japanese_shogunate = {
						any_international_organization_member = {
							NOT = { tag = NTC }
							NOT = { tag = STC }
							has_ruler = yes
							has_regent = no
							ruler.dynasty ?= dynasty:yamato_dynasty
						}
					}
				}
				international_organization:japanese_shogunate = {
					every_international_organization_member = {
						trigger_event_non_silently = nanbokuchou.8
					}
				}
			}

			200 = { }
		}
	}


	on_ended = {
		international_organization:japanese_shogunate = {
			every_international_organization_member = { 
				if = {
					limit = { has_country_modifier = jap_nanbokuchou }
					remove_country_modifier = jap_nanbokuchou
				}
				trigger_event_non_silently = nanbokuchou.2
			}
		}
		clear_global_variable_list = nanbokuchou_northern_supporters
		clear_global_variable_list = nanbokuchou_southern_supporters
		clear_global_variable_list = nanbokuchou_neutral_countries
		clear_global_variable_list = nanbokuchou_voters
	}



	tooltip = {
		if = { #Northern Supporter
			limit = {	
				OR = {
					any_foreign_building_countries_in_location = {
						AND = {
							has_variable = supports_northern_court 
							NOT = {
								has_special_status_in_international_organization = {
									type = special_status:japanese_emperor
									international_organization = international_organization:japanese_shogunate
								}
							}
						}
					}
					AND = {
						num_foreign_buildings = 0
						owner ?= { has_variable = supports_northern_court	}
					}
				}
			}
			custom_tooltip = "NORTHERN_COURT_SUPPORTER"
		}
		else_if = { #Northern Emperor
			limit = {	
				OR = {
					any_foreign_building_countries_in_location = { 
						AND = {
							has_variable = supports_northern_court
							has_special_status_in_international_organization = {
								type = special_status:japanese_emperor
								international_organization = international_organization:japanese_shogunate
							}
						}
					}
					AND = {
						num_foreign_buildings = 0
						owner ?= { 
							AND = {
								has_variable = supports_northern_court
								has_special_status_in_international_organization = {
									type = special_status:japanese_emperor
									international_organization = international_organization:japanese_shogunate
								}
							}
						}
					}
				}
			}
			custom_tooltip = "NORTHERN_COURT_EMPEROR"
		}
		else_if = { #Southern Supporter
			limit = {	
				OR = {
					any_foreign_building_countries_in_location = {
						AND = {
							has_variable = supports_southern_court 
							NOT = {
								has_special_status_in_international_organization = {
									type = special_status:japanese_emperor
									international_organization = international_organization:japanese_shogunate
								}
							}
						}
					}
					AND = {
						num_foreign_buildings = 0
						owner ?= { has_variable = supports_southern_court	}
					}
				}
			}
			custom_tooltip = "SOUTHERN_COURT_SUPPORTER"
		}
		else_if = { #Southern Emperor
			limit = {	
				OR = {
					any_foreign_building_countries_in_location = { 
						AND = {
							has_variable = supports_southern_court
							has_special_status_in_international_organization = {
								type = special_status:japanese_emperor
								international_organization = international_organization:japanese_shogunate
							}
						}
					}
					AND = {
						num_foreign_buildings = 0
						owner ?= { 
							AND = {
								has_variable = supports_southern_court
								has_special_status_in_international_organization = {
									type = special_status:japanese_emperor
									international_organization = international_organization:japanese_shogunate
								}
							}
						}
					}
				}
			}
			custom_tooltip = "SOUTHERN_COURT_EMPEROR"
		}
		if = {
			limit = {
				is_multiplayer_session = no
				OR = {
					any_foreign_building_countries_in_location = { is_human = yes }
					top_owner ?= { is_human = yes }
				}
			}
			custom_tooltip = this_is_the_player_tt
		}
	}

	map_color = {
		if = { #Northern Supporter
			limit = {	
				OR = {
					any_foreign_building_countries_in_location = {
						AND = {
							has_variable = supports_northern_court 
							NOT = {
								has_special_status_in_international_organization = {
									type = special_status:japanese_emperor
									international_organization = international_organization:japanese_shogunate
								}
							}
						}
					}
					AND = {
						num_foreign_buildings = 0
						owner ?= { has_variable = supports_northern_court	}
					}
				}
			}
			value = yellow
		}
		else_if = { #Northern Emperor
			limit = {	
				OR = {
					any_foreign_building_countries_in_location = { 
						AND = {
							has_variable = supports_northern_court
							has_special_status_in_international_organization = {
								type = special_status:japanese_emperor
								international_organization = international_organization:japanese_shogunate
							}
						}
					}
					AND = {
						num_foreign_buildings = 0
						owner ?= { 
							AND = {
								has_variable = supports_northern_court
								has_special_status_in_international_organization = {
									type = special_status:japanese_emperor
									international_organization = international_organization:japanese_shogunate
								}
							}
						}
					}
				}
			}
			value = red
		}
		else_if = { #Southern Supporter
			limit = {	
				OR = {
					any_foreign_building_countries_in_location = {
						AND = {
							has_variable = supports_southern_court 
							NOT = {
								has_special_status_in_international_organization = {
									type = special_status:japanese_emperor
									international_organization = international_organization:japanese_shogunate
								}
							}
						}
					}
					AND = {
						num_foreign_buildings = 0
						owner ?= { has_variable = supports_southern_court	}
					}
				}
			}
			value = blue
		}
		else_if = { #Southern Emperor
			limit = {	
				OR = {
					any_foreign_building_countries_in_location = { 
						AND = {
							has_variable = supports_southern_court
							has_special_status_in_international_organization = {
								type = special_status:japanese_emperor
								international_organization = international_organization:japanese_shogunate
							}
						}
					}
					AND = {
						num_foreign_buildings = 0
						owner ?= { 
							AND = {
								has_variable = supports_southern_court
								has_special_status_in_international_organization = {
									type = special_status:japanese_emperor
									international_organization = international_organization:japanese_shogunate
								}
							}
						}
					}
				}
			}
			value = green
		}
		else = {
			value = define:NMapColors|DEFAULT_COLOR
		}
	}
	
	legend_key = { 
		desc = "NORTHERN_COURT_SUPPORTER"
		color = yellow
		require_color_on_map = yes # Don't show key if this color is not on the map.
	}
	legend_key = { 
		desc = "NORTHERN_COURT_EMPEROR"
		color = red
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "SOUTHERN_COURT_SUPPORTER"
		color = blue
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "SOUTHERN_COURT_EMPEROR"
		color = green
		require_color_on_map = yes
	}

	secondary_map_color = {
		if = {
			limit = {
				is_multiplayer_session = no
				OR = {
					any_foreign_building_countries_in_location = { is_human = yes }
					owner ?= { is_human = yes }
				}
			}
			value = white
		}
	}
}
