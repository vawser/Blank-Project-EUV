reformation = {
	monthly_spawn_chance = monthly_spawn_chance_high
	
	can_start = {
		current_year >= 1510
	}
	
	can_end = {
		reformation_end_trigger = yes
	}
	
	visible = {
		exists = religion
		religion.group = religion_group:christian
		NOT = {
			OR = {
				religion = religion:miaphysite
				religion = religion:nestorianism
			}
			capital ?= {
				NOT = { continent = continent:europe }
			}
		}
	}
	

	on_start = {
		religion:lutheran = {
			enable_religion = yes
		}
		set_variable = {
			name = reformation_lutheran_preachers_counter
			value = 0
		}
		set_variable = {
			name = reformation_calvinist_preachers_counter
			value = 0
		}
		continent:europe = {
			random_location_in_continent = {
				limit = {
					exists = owner
					population > 1
					has_building_with_at_least_one_level = university
					dominant_religion = religion:catholic
					NOT = { location_key = rome }
					NOT = { owner = c:PAP }
				}
				weight = {
					base = 1
					modifier = {
						add = 12
						region = region:north_german_region
					}
					modifier = {
						add = 4
						region = region:south_german_region
					}
					modifier = {
						add = 6
						region = region:scandinavian_region
					}
					modifier = {
						add = -0.5
						region = region:iberia_region
					}
					modifier = {
						add = -0.5
						region = region:italy_region
					}
					modifier = {
						add = 4
						is_owned_by_international_organization = international_organization:hre
					}
				}
	
				every_pop = {
					limit = {
						religion = religion:catholic
					}
					split_pop = {
						fraction = 0.50
						religion = religion:lutheran
					}
				}
				root = {
					set_variable = { name = lutheran_origin value = prev } 
				}
	
				construct_building = { building_type = building_type:lutheran_preachers }
				owner ?= {
					create_character = {
						first_name = name_martin
						last_name = Luther
						religion = religion:lutheran
						culture = culture:saxon
						birth_date = 1483.11.10
						birth_location = location:eisleben
						estate = estate_type:clergy_estate
						adm = { 40 60 }
						dip = { 40 60 }
						mil = { 80 100 }
						script = martin_luther
						root = {
							set_variable = { name = lutheran_character value = prev } 
						}
					}
				}
			}
		}


		every_country = {
			limit = {
				religion = religion:catholic
			}
		
			trigger_event_non_silently = reformation.1
		}
	}

	on_monthly = {
		every_location_in_the_world = {
			limit = {
				OR = {
					has_building = building_type:lutheran_preachers
					dominant_religion ?= religion:lutheran
				}
			}
			
			every_coast_border_location = {
					limit = {
						population > 0
						dominant_religion = religion:catholic
						OR = {
							NOT = { has_building = building_type:lutheran_preachers }
							any_buildings_in_location = {
								building_type = building_type:lutheran_preachers
								is_max_level = no
							}
						}
						NOT = { has_variable = lutherans_blocked_in_location }
					}
			
				random_list =  {
					3 = {
						construct_building = { building_type = building_type:lutheran_preachers }
					}
					2 = {
						set_variable = {
							name = lutherans_blocked_in_location 
							value = 1
						}
					}
					20 = {  }
				}
			}
		}

		# bible translations
		
		random_country = {
			limit = {
				religion = religion:catholic
				has_embraced_institution = institution:printing_press
				NOT = { has_variable = bibles_translated_in_country }
			}
			
			set_variable = { 
				name = bibles_translated_in_country 
				value = 1
			} 
			trigger_event_non_silently = reformation.2
		}

		#Historical Reformers of the Faith
		#Lutherans

		#Philip Melanchton

		location:wittenberg = {
			owner ?= {
				if = {
					limit = {
						current_year >= 1517
						current_year <= 1561
						religion.group = religion_group:christian
						NOT = { has_variable = received_reformer }
					}
					random_list = {
						10 = {
							trigger_event_non_silently = reformation.3
						}
						90 = {  }
					}
				}
			}
		}

		#Justus Jonas

		location:halle_an_der_saale = {
			owner ?= {
				if = {
					limit = {
						current_year >= 1515
						current_year <= 1556
						religion.group = religion_group:christian
						NOT = { has_variable = received_reformer }
					}
					random_list = {
						10 = {
							trigger_event_non_silently = reformation.4
						}
						90 = {  }
					}
				}
			}
		}

		#Mikael Agricola

		location:abo = {
			owner ?= {
				if = {
					limit = {
						current_year >= 1530
						current_year <= 1558
						religion.group = religion_group:christian
						NOT = { has_variable = received_reformer }
					}
					random_list = {
						10 = {
							trigger_event_non_silently = reformation.5
						}
						90 = {  }
					}
				}
			}
		}

		#Hans Tausen

		location:kobenhavn = {
			owner ?= {
				if = {
					limit = {
						current_year >= 1520
						current_year <= 1562
						religion.group = religion_group:christian
						NOT = { has_variable = received_reformer }
					}
					random_list = {
						10 = {
							trigger_event_non_silently = reformation.6
						}
						90 = {  }
					}
				}
			}
		}

		#John Calvin

		location:basel = {
			owner ?= {
				if = {
					limit = {
						current_year >= 1530
						current_year <= 1565
						religion.group = religion_group:christian
						NOT = { has_variable = received_reformer }
					}
					random_list = {
						40 = {
							trigger_event_non_silently = reformation.7
						}
						60 = {  }
					}
				}
			}
		}

		#Huldrych Zwingli

		location:bern = {
			owner ?= {
				if = {
					limit = {
						current_year <= 1531
						religion.group = religion_group:christian
					}
					random_list = {
						40 = {
							trigger_event_non_silently = reformation.8
						}
						60 = {  }
					}
				}
			}
		}

		#Heinrich Bullinger

		location:zurich = {
			owner ?= {
				if = {
					limit = {
						current_year >= 1524
						current_year <= 1576
						religion.group = religion_group:christian
					}
					random_list = {
						1 = {
							trigger_event_non_silently = reformation.9
						}
						99 = {  }
					}
				}
			}
		}

		#John Knox

		location:edinburgh = {
			owner ?= {
				if = {
					limit = {
						religion:calvinist = {
							is_religion_enabled = yes
						}
						current_year >= 1534
						current_year <= 1573
						religion.group = religion_group:christian
						NOT = { has_variable = received_reformer }
					}
					random_list = {
						10 = {
							trigger_event_non_silently = reformation.10
						}
						90 = {  }
					}
				}
			}
		}

		#Guido de Bres

		location:antwerp = {
			owner ?= {
				if = {
					limit = {
						religion:calvinist = {
							is_religion_enabled = yes
						}
						current_year >= 1542
						current_year <= 1568
						religion.group = religion_group:christian
						NOT = { has_variable = received_reformer }
					}
					random_list = {
						1 = {
							trigger_event_non_silently = reformation.11
						}
						99 = {  }
					}
				}

			}
		}

		hidden_effect = {
			#random events for all countries
			every_country = {
				if = {
					limit = {
						current_year <= 1600
						OR = {
							is_protestant = yes
							religion = religion:catholic
						}
						any_character = {
							is_alive = yes
							is_adult = yes
							religion = prev.religion
							NOT = {
								is_target_in_global_variable_list = {
									name = reformer_list
									target = this
								}
							}
						}
						any_neighbor_country = {
							exists = yes
						}
					}
					random_list = {
						1 = { trigger_event_non_silently = reformation.12 } #A Character Converts
						99 = { }
					}
				}
				if = {
					limit = {
						current_year <= 1600
						OR = {
							is_protestant = yes
							religion = religion:catholic
						}
						any_owned_location = {
							dominant_religion.group = religion_group:christian
							dominant_religion != prev.religion
						}
						any_neighbor_country = {
							exists = yes
						}
					}
					random_list = {
						1 = { trigger_event_non_silently = reformation.13 } #Minority Migrates away
						99 = { }
					}
				}
				if = {
					limit = {
						current_year <= 1600
						situation:reformation = {
							years_since_situation_start > 20
						}
						OR = {
							is_protestant = yes
							religion = religion:catholic
						}
						any_owned_location = {
							has_building_with_at_least_one_level = university
						}
						any_character = {
							religion.group = prev.religion.group
							religion != prev.religion
							OR = {
								has_estate = estate_type:burghers_estate
								has_estate = estate_type:clergy_estate
							}
						}
						any_neighbor_country = {
							exists = yes
						}
					}
					random_list = {
						1 = { trigger_event_non_silently = reformation.14 } #A Heretic Professor
						99 = { }
					}
				}
				if = {
					limit = {
						current_year <= 1600
						religion = religion:catholic
						any_owned_location = {
							has_building_with_at_least_one_level = monastery
						}
					}
					random_list = {
						1 = { trigger_event_non_silently = reformation.15 } #A Monastery joins the reformation
						99 = { }
					}
				}
				if = {
					limit = {
						current_year <= 1600
						OR = {
							religion = religion:lutheran
							religion = religion:calvinist
						}
						has_variable = received_reformer
						religious_unity <= 0.8
					}
					random_list = {
						1 = { trigger_event_non_silently = reformation.16 } #Reformer asks for additional funds
						99 = { }
					}
				}
			}
		}
	}


	on_ended = {
		every_location_in_the_world = {
			remove_variable = lutherans_blocked_in_location
		}
		every_country = {
			remove_variable = bibles_translated_in_country
			remove_variable = lutheran_origin
		}
		remove_variable = reformation_lutheran_preachers_counter
		remove_variable = reformation_calvinist_preachers_counter
		clear_global_variable_list = reformer_list
	}

	tooltip = {
		if = {
			limit = {
				any_in_global_list = {
					variable = reformer_list
					location ?= prev
				}
			}
			custom_tooltip = REFORMATION_LOCAL_ACTIVE_REFORMER
		}
		else_if = {
			limit = {
				dominant_religion ?= religion:catholic
				has_owner = yes
				owner = {
					has_policy = jesuits_allowed
				}
			}
			custom_tooltip = REFORMATION_HAS_JESUITS_ACTIVE
		}
		else_if = {
			limit = {
				has_building = building_type:lutheran_preachers
			}
			custom_tooltip = REFORMATION_HAS_LUTHERAN_PREACHERS
		}
		else_if = {
			limit = {
				has_building = building_type:calvinist_preachers
			}
			custom_tooltip = REFORMATION_HAS_CALVINIST_PREACHERS
		}
	}

	map_color = {
		if = {
			limit = {
				any_in_global_list = {
					variable = reformer_list
					location ?= prev
				}
			}
			if = {
				limit = {
					has_building = building_type:lutheran_preachers
				}
				lerp = {
					min_color = reformation_reformer
					max_color = color_lutheran
					factor = 0.5
				}
			}
			else_if = {
				limit = {
					has_building = building_type:calvinist_preachers
				}
				lerp = {
					min_color = reformation_reformer
					max_color = color_calvinist
					factor = 0.5
				}
			}
			else = {
				value = reformation_reformer
			}
		}
		else_if = {
			limit = {
				dominant_religion ?= religion:catholic
			}
			if = {
				limit = {
					has_owner = yes
					owner = {
						has_policy = jesuits_allowed
					}
				}
				if = {
					limit = {
						has_building = building_type:lutheran_preachers
					}
					lerp = {
						min_color = reformation_jesuits_state
						max_color = color_lutheran
						factor = 0.5
					}
				}
				else_if = {
					limit = {
						has_building = building_type:calvinist_preachers
					}
					lerp = {
						min_color = reformation_jesuits_state
						max_color = color_calvinist
						factor = 0.5
					}
				}
				else = {
					value = reformation_jesuits_state
				}
			}
			else = {
				if = {
					limit = {
						has_building = building_type:lutheran_preachers
					}
					lerp = {
						min_color = religion_catholic
						max_color = color_lutheran
						factor = 0.5
					}
				}
				else_if = {
					limit = {
						has_building = building_type:calvinist_preachers
					}
					lerp = {
						min_color = religion_catholic
						max_color = color_calvinist
						factor = 0.5
					}
				}
				else = {
					value = religion_catholic
				}
			}
		}
		else_if = {
			limit = { dominant_religion ?= religion:lutheran }
			value = color_lutheran
		}
		else_if = {
			limit = { dominant_religion ?= religion:calvinist }
			value = color_calvinist
		}
		else_if = {
			limit = { dominant_religion ?= religion:hussite }
			value = color_hussite
		}
		else_if = {
			limit = { dominant_religion ?= religion:anglican }
			value = color_anglican
		}
		else = {
			value = define:NMapColors|DEFAULT_COLOR
		}
	}
	
	legend_key = { 
		desc = "lutheran_preachers"
		color = {
			lerp = {
				min_color = reformation_reformer
				max_color = color_lutheran
				factor = 0.5
			}
		}
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "calvinist_preachers"
		color = {
			lerp = {
				min_color = reformation_reformer
				max_color = color_calvinist
				factor = 0.5
			}
		}
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "lutheran_preachers"
		color = {
			lerp = {
				min_color = reformation_jesuits_state
				max_color = color_lutheran
				factor = 0.5
			}
		}
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "calvinist_preachers"
		color = {
			lerp = {
				min_color = reformation_jesuits_state
				max_color = color_calvinist
				factor = 0.5
			}
		}
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "lutheran_preachers"
		color = {
			lerp = {
				min_color = religion_catholic
				max_color = color_lutheran
				factor = 0.5
			}
		}
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "calvinist_preachers"
		color = {
			lerp = {
				min_color = religion_catholic
				max_color = color_calvinist
				factor = 0.5
			}
		}
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "Reformers" #FIX
		color = reformation_reformer
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "jesuits_allowed"
		color = reformation_jesuits_state
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "catholic_ADJ"
		color = religion_catholic
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "lutheran_ADJ"
		color = color_lutheran
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "calvinist_ADJ"
		color = color_calvinist
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "hussite_ADJ"
		color = color_hussite
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "anglican_ADJ"
		color = color_anglican
		require_color_on_map = yes
	}
}
