war_of_religions = {
	monthly_spawn_chance = monthly_spawn_chance_ultimate
	can_start = {
		current_year >= 1590
		situation:council_of_trent = {
			situation_is_active = no
			situation_has_ended = yes
		}
		reformation_is_enabled = yes

		any_war = { #Is a catholic country at war with a protestant country
			any_war_participant = { religion = religion:catholic }
			any_war_participant = { is_protestant = yes }
		}
		exists = international_organization:hre
		international_organization:hre = {
			exists = leader_country
			any_international_organization_member = { 
				is_subject = no
				religion = religion:catholic
			}
			any_international_organization_member = { 
				is_subject = no
				is_protestant = yes
			}
		}
	}
	
	can_end = { #War never changes but it does need to end
		war_of_religions_end_trigger = yes
	}
	visible = {
		has_presence_in = continent:europe
	}

	on_start = {
		set_variable = { name = war_of_religions_total_war_participants_counter value = 0 }
		set_variable = { name = war_of_religions_peace_demands_counter value = 0 }
		set_variable = { name = war_of_religions_peace_demands_ratio value = 0 }
		international_organization:hre = {
			leader_country ?= {
				trigger_event_non_silently = war_of_religions.1000
			}
			every_international_organization_member = {
				limit = { NOT = { is_leader_of_international_organization = PREV } }
				trigger_event_non_silently = war_of_religions.1001
			}
			ordered_international_organization_member = {
				limit = {
					is_protestant = yes
					is_subject = no
				}
				order_by = great_power_score
				max = 1
				check_range_bounds = no
				create_international_organization = {
					type = international_organization_type:protestant_union
					add_country_to_international_organization = prev
					set_leader_country = prev
				}
				international_organization:protestant_union = { set_leader_country = PREV }
			}
			ordered_international_organization_member = {
				limit = {
					religion = religion:catholic
					is_subject = no
				}
				order_by = great_power_score
				max = 1
				check_range_bounds = no
				create_international_organization = {
					type = international_organization_type:catholic_league
					add_country_to_international_organization = prev
					set_leader_country = prev
				}
				international_organization:catholic_league = { set_leader_country = PREV }
			}
		}
		continent:europe = {
			every_present_country = {
				limit = {
					can_see_situation = ROOT
					NOT = { is_member_of_international_organization = international_organization:hre }
				}
				trigger_event_non_silently = war_of_religions.1002
			}
		}
	}

	on_monthly = {
		hidden_effect = {
			if = {
				limit = { has_variable = war_of_religion_current_war }
				set_variable = { name = war_of_religions_total_war_participants_counter value = 0 }
				set_variable = { name = war_of_religions_peace_demands_counter value = 0 }
				clear_global_variable_list = war_of_religions_wants_war_list
				clear_global_variable_list = war_of_religions_wants_peace_list
				#Update the list of countries who favor war / peace
				var:war_of_religion_current_war = { 
					every_war_participant = {
						root = { change_variable = { name = war_of_religions_total_war_participants_counter add = 1 } }
						if = {
							limit = {
								scope:target_war = { war_length_in_years > 5 }
								OR = {
									scope:target_war = { war_length_in_years > 25 }	#At this point everyone just wants to leave
									AND = {
										scope:target_war = { war_length_in_years > 20 }	#We really don't wanna be in that war anymore
										war_exhaustion_percentage > 0.2
									}
									AND = {
										scope:target_war = { war_length_in_years > 15 }
										war_exhaustion_percentage > 0.4
									}
									AND = {
										scope:target_war = { war_length_in_years > 10 }
										war_exhaustion_percentage > 0.6
									}
									war_exhaustion_percentage > 0.8
								}
							}
							root = { change_variable = { name = war_of_religions_peace_demands_counter add = 1 } }
							add_to_global_variable_list = { name = war_of_religions_wants_peace_list target = this }
						}
						else = {
							add_to_global_variable_list = { name = war_of_religions_wants_war_list target = this }
						}
					}			
					save_scope_as = target_war 
				}
				if = {
					limit = { var:war_of_religions_total_war_participants_counter > 0 }
					set_variable = {
						name = war_of_religions_peace_demands_ratio
						value = {
							value = var:war_of_religions_peace_demands_counter
							divide = var:war_of_religions_total_war_participants_counter
						}
					}
					if = {
						limit = { var:war_of_religions_peace_demands_ratio > 0.8 }
						if = {
							limit = { international_organization:hre = { international_organization_has_leader = yes } }
							international_organization:hre.leader_country ?= { save_scope_as = target_country }
						}
						else = {
							random_in_global_list = {
								variable = war_of_religions_wants_peace_list
								save_scope_as = target_country
							}
						}
						scope:target_country = {
							trigger_event_non_silently = war_of_religions.1300	#Peace of Westphalia
						}
					}	
				}
			}
		}

		#Generals of the War
		continent:europe = {
			every_present_country = {
				#Emperor - Austria
				if = { #Wallenstein
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1605
						current_year <= 1655
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							culture = culture:danube_bavarian
							culture = culture:czech
						}
						OR = {
							owns = location:nachod
							is_leader_of_international_organization = international_organization:hre
							tag = BOH
							tag = HAB
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.1200
						}
						99 = {  }
					}
				}
				if = { #Ottavio Piccolomini
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1625
						current_year <= 1675
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							owns = location:florence
							is_leader_of_international_organization = international_organization:hre
							tag = SPA
							tag = HAB
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.1
						}
						99 = {  }
					}
				}
				if = { #Matthias Gallas
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1625
						current_year <= 1645
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							owns = location:trento
							is_leader_of_international_organization = international_organization:hre
							tag = HAB
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.2
						}
						99 = {  }
					}
				}
				if = { #Charles de Longueval
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1615
						current_year <= 1645
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							owns = location:arras
							is_leader_of_international_organization = international_organization:hre
							tag = HAB
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.3
						}
						99 = {  }
					}
				}
				#Bavaria - Catholic League Leader
				if = { #Franz von Mercy
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1625
						current_year <= 1665
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							owns = location:longwy
							is_leader_of_international_organization = international_organization:catholic_league
							tag = BAV
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.4
						}
						99 = {  }
					}
				}
				if = { #Johann Tilly
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1605
						current_year <= 1645
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							owns = location:nivelles
							is_leader_of_international_organization = international_organization:hre
							is_leader_of_international_organization = international_organization:catholic_league
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.13
						}
						99 = {  }
					}
				}
				if = { #Johann von Aldringen
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1615
						current_year <= 1645
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							owns = location:luxembourg
							is_leader_of_international_organization = international_organization:hre
							is_leader_of_international_organization = international_organization:catholic_league
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.14
						}
						99 = {  }
					}
				}
				if = { #Otto Heinrich Fugger
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1615
						current_year <= 1665
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							owns = location:augsburg
							is_leader_of_international_organization = international_organization:hre
							is_leader_of_international_organization = international_organization:catholic_league
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.15
						}
						99 = {  }
					}
				}
				if = { #Gottfried Heinrich zu Pappenheim
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1615
						current_year <= 1645
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							owns = location:eichstatt
							is_leader_of_international_organization = international_organization:hre
							is_leader_of_international_organization = international_organization:catholic_league
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.16
						}
						99 = {  }
					}
				}
				#Spain
				if = { #Ambrogio Spinola
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1615
						current_year <= 1645
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							owns = location:genoa
							tag = SPA
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.5
						}
						99 = {  }
					}
				}
				if = { #Tommaso Caracciolo
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1615
						current_year <= 1645
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						religion = religion:catholic
						OR = {
							owns = location:naples
							tag = SPA
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.6
						}
						99 = {  }
					}
				}
				#Palatinate - Protestant Union Leader
				if = { #Peter Ernst von Mansfeld
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1615
						current_year <= 1645
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						is_protestant = yes
						OR = {
							owns = location:luxembourg
							is_leader_of_international_organization = international_organization:protestant_union
							tag = PAL
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.7
						}
						99 = {  }
					}
				}
				if = { #Heinrich Matthias von Thurn
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1605
						current_year <= 1640
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						is_protestant = yes
						OR = {
							owns = location:nemecky_brod
							is_leader_of_international_organization = international_organization:protestant_union
							tag = BOH
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.8
						}
						99 = {  }
					}
				}
				#Sweden
				if = { #Johan Banér
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1625
						current_year <= 1665
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						is_protestant = yes
						OR = {
							owns = location:stockholm
							tag = SWE
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.9
						}
						99 = {  }
					}
				}
				if = { #Lennart Torstensson
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1625
						current_year <= 1665
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						is_protestant = yes
						OR = {
							owns = location:ekholm
							tag = SWE
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.10
						}
						99 = {  }
					}
				}
				if = { #Gustaf Horn
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1625
						current_year <= 1665
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						is_protestant = yes
						OR = {
							owns = location:uppsala
							tag = SWE
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.11
						}
						99 = {  }
					}
				}
				#France
				if = { #Turenne
					limit = {
						can_see_situation = situation:war_of_religions
						current_year >= 1625
						current_year <= 1665
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
						OR = {
							owns = location:mouzon
							tag = FRA
						}
					}
					random_list = {
						1 = {
							trigger_event_non_silently = war_of_religions.12
						}
						99 = {  }
					}
				}
			}
			#Gustavus Adolphus Event
			if = {
				limit = { NOT = { has_global_variable = wor_ruler_died_gloriously } }
				random_present_country = {
					limit = {
						is_situation_active = situation:war_of_religions
						has_ruler = yes
						ruler = {
							character_in_combat = yes
						}
						in_war_of_casus_belli = casus_belli:cb_religious_superiority
					}
					random_list = {
						40 = {
							trigger_event_non_silently = war_of_religions.19
						}
						60 = {  }
					}
				}
			}
		}
		location:hanau = {
			controller ?= {
				if = {
					limit = {
						current_year > 1638
						is_situation_active = situation:war_of_religions
					}
					random_list = {
						50 = {
							trigger_event_non_silently = war_of_religions.1400
						}
						50 = {  }
					}
				}
			}
		}
	}


	on_ended = {
		clear_global_variable_list = war_of_religions_wants_war_list
		clear_global_variable_list = war_of_religions_wants_peace_list
		remove_variable = war_of_religions_total_war_participants_counter
		remove_variable = war_of_religions_peace_demands_counter
		remove_variable = war_of_religions_peace_demands_ratio
		random_country = {
            destroy_international_organization = { target = international_organization:protestant_union }
            destroy_international_organization = { target = international_organization:catholic_league }
        }
		remove_global_variable = wor_ruler_died_gloriously
		international_organization_chooses_new_leader = international_organization:hre
	}



	tooltip = {
		if = {
			limit = {
				has_owner = yes
				owner ?= {
					is_member_of_international_organization = international_organization:protestant_union
					is_leader_of_international_organization = international_organization:protestant_union
				}
			}
			custom_tooltip = protestant_union_leader.tt
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					is_member_of_international_organization = international_organization:catholic_league
					is_leader_of_international_organization = international_organization:catholic_league
				}
			}
			custom_tooltip = catholic_league_leader.tt
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= { is_member_of_international_organization = international_organization:protestant_union }
			}
			custom_tooltip = protestant_union.tt
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= { is_member_of_international_organization = international_organization:catholic_league }
			}
			custom_tooltip = catholic_league.tt
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					any_related_country = {
						type = alliance
						is_leader_of_international_organization = international_organization:protestant_union
					}
					NOT = {
						any_related_country = {
							type = alliance
							is_leader_of_international_organization = international_organization:catholic_league
						}
					}
				}
			}
			custom_tooltip = protestant_union_ally.tt
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					any_related_country = {
						type = alliance
						is_leader_of_international_organization = international_organization:catholic_league
					}
					NOT = {
						any_related_country = {
							type = alliance
							is_leader_of_international_organization = international_organization:protestant_union
						}
					}
				}
			}
			custom_tooltip = catholic_league_ally.tt
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					NOT = {
						OR = {
							is_member_of_international_organization = international_organization:protestant_union
							is_member_of_international_organization = international_organization:catholic_league
						}
					}
				}
			}
			custom_tooltip = war_of_religions_neutral.tt
		}
	}

	map_color = {
		if = {
			limit = { #Leader of the Protestant Union
				has_owner = yes
				owner ?= {
					is_member_of_international_organization = international_organization:protestant_union
					is_leader_of_international_organization = international_organization:protestant_union
				}
			}
			value = war_of_religions_protestant_union_leader_color
		}
		else_if = {
			limit = { #Leader of the Catholic League
				has_owner = yes
				owner ?= {
					is_member_of_international_organization = international_organization:catholic_league
					is_leader_of_international_organization = international_organization:catholic_league
				}
			}
			value = war_of_religions_catholic_league_leader_color
		}
		else_if = {
			limit = { #Member of the Protestant Union
				has_owner = yes
				owner ?= { is_member_of_international_organization = international_organization:protestant_union }
			}
			value = war_of_religions_protestant_union_color
		}
		else_if = {
			limit = { #Member of the Catholic League
				has_owner = yes
				owner ?= { is_member_of_international_organization = international_organization:catholic_league }
			}
			value = war_of_religions_catholic_league_color
		}
		else_if = {
			limit = { #Ally of the Protestant Union Leader
				has_owner = yes
				owner ?= {
					any_related_country = {
						type = alliance
						is_leader_of_international_organization = international_organization:protestant_union
					}
					NOT = {
						any_related_country = {
							type = alliance
							is_leader_of_international_organization = international_organization:catholic_league
						}
					}
				}
			}
			value = war_of_religions_protestant_union_ally_color
		}
		else_if = {
			limit = { #Ally of the Catholic League Leader
				has_owner = yes
				owner ?= {
					any_related_country = {
						type = alliance
						is_leader_of_international_organization = international_organization:catholic_league
					}
					NOT = {
						any_related_country = {
							type = alliance
							is_leader_of_international_organization = international_organization:protestant_union
						}
					}
				}
			}
			value = war_of_religions_catholic_league_ally_color
		}
		else_if = {
			limit = { #Neutral
				has_owner = yes
				owner ?= {
					can_see_situation = situation:war_of_religions
					NOR = {
						OR = {
							is_member_of_international_organization = international_organization:protestant_union
							is_member_of_international_organization = international_organization:catholic_league
						}
					}
				}
			}
			value = rtr_neutral_color
		}
		else = {
			value = define:NMapColors|DEFAULT_COLOR
		}
	}
	
	legend_key = {
		desc = "WAR_OF_RELIGIONS_PROTESTANT_UNION_LEADER"
		color = war_of_religions_protestant_union_leader_color
		require_color_on_map = yes
	}
	legend_key = {
		desc = "WAR_OF_RELIGIONS_CATHOLIC_LEAGUE_LEADER"
		color = war_of_religions_catholic_league_leader_color
		require_color_on_map = yes
	}
	legend_key = {
		desc = "protestant_union"
		color = war_of_religions_protestant_union_color
		require_color_on_map = yes
	}
	legend_key = {
		desc = "catholic_league"
		color = war_of_religions_catholic_league_color
		require_color_on_map = yes
	}
	legend_key = {
		desc = "protestant" #ALLY OF
		color = war_of_religions_protestant_union_ally_color
		require_color_on_map = yes
	}
	legend_key = {
		desc = "catholic" #ALLY OF
		color = war_of_religions_catholic_league_ally_color
		require_color_on_map = yes
	}
	legend_key = {
		desc = "RTR_NEUTRALS_TITLE"
		color = rtr_neutral_color
		require_color_on_map = yes
	}
}
