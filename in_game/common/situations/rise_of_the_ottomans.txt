rise_of_the_ottomans = {
	monthly_spawn_chance = monthly_spawn_chance_unique
	
	can_start = {
		current_date > 1337.4.1
		current_date < 1350
	}
	
	can_end = {
		rise_of_the_ottomans_end_trigger = yes
	}
	
	visible = {
		OR = {
			tag = TUR
			is_neighbor_of = c:TUR
			has_presence_in = region:balkan_region
			has_presence_in = region:anatolia_region
			has_reform = government_reform:anatolian_beylik
		}
	}
	

	on_start = {
		
		every_country = {
			limit = {
				has_reform = government_reform:anatolian_beylik
			}
			add_to_global_variable_list = { name = eligible_beylik_list target = this }

			add_country_modifier = {
				modifier = ai_force_annexation
				years = -1
				mode = add_and_extend
			}
		}
		ordered_in_global_list = {  
			variable = eligible_beylik_list
			order_by = {
				
				add = {
					value = military_strength
				}
				add = {
					value = monthly_income_trade_and_tax
				}
				if = {	#If they are a subject, they receive a -25% penalty to their score 
					limit = { is_subject = yes }
					multiply = 0.75
				}
			} 
			max = 1
			check_range_bounds = no 
			situation:rise_of_the_ottomans = {
				set_variable = {
					name = strongest_beylik_variable
					value = prev
				}
				set_variable = {
					name = strongest_strongest_beylik_total_score_variable
					value = {
						add = var:strongest_beylik_variable.military_strength
						add = var:strongest_beylik_variable.monthly_income_trade_and_tax 
						if = {
							limit = {	#If they are a subject, they receive a -25% penalty to their score 
								var:strongest_beylik_variable ?= { is_subject = yes }
							}
							multiply = 0.75
						}
					}
				}
			}
			trigger_event_non_silently = rise_of_the_ottomans.2
		}
		ordered_in_global_list = {  
			variable = eligible_beylik_list
			limit = { this != situation:rise_of_the_ottomans.var:strongest_beylik_variable }
			order_by = {
					
				add = {
					value = military_strength
				}
				add = {
					value = monthly_income_trade_and_tax
				}

				if = {	#If they are a subject, they receive a -25% penalty to their score 
					limit = { is_subject = yes }
					multiply = 0.75
				}
			} 
			max = 1
			check_range_bounds = no 
			situation:rise_of_the_ottomans = {
				set_variable = {
					name = second_strongest_strongest_beylik_variable
					value = prev
				}
				set_variable = {
					name = second_strongest_strongest_beylik_total_score_variable
					value = {
						add = var:second_strongest_strongest_beylik_variable.military_strength
						add = var:second_strongest_strongest_beylik_variable.monthly_income_trade_and_tax
						if = {
							limit = {	#If they are a subject, they receive a -25% penalty to their score 
								var:second_strongest_strongest_beylik_variable ?= { is_subject = yes }
							}
							multiply = 0.75
						}
					}
				}
			}
		}
		ordered_in_global_list = {  
			variable = eligible_beylik_list
			limit = {
				this != situation:rise_of_the_ottomans.var:strongest_beylik_variable 
				this != situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable 
			}
			order_by = {
					
				add = {
					value = military_strength
				}
				add = {
					value = monthly_income_trade_and_tax
				}

				if = {	#If they are a subject, they receive a -25% penalty to their score 
					limit = { is_subject = yes }
					multiply = 0.75
				}
			} 
			max = 1
			check_range_bounds = no 
			situation:rise_of_the_ottomans = {
				set_variable = {
					name = third_strongest_strongest_beylik_variable
					value = prev
				}
				set_variable = {
					name = third_strongest_strongest_beylik_total_score_variable
					value = {
						add = var:third_strongest_strongest_beylik_variable.military_strength
						add = var:third_strongest_strongest_beylik_variable.monthly_income_trade_and_tax
						if = {
							limit = {	#If they are a subject, they receive a -25% penalty to their score 
								var:third_strongest_strongest_beylik_variable ?= { is_subject = yes }
							}
							multiply = 0.75
						}
					}
				}
			}
		}
		every_country = {
			limit = {
				NOT = { situation:rise_of_the_ottomans.var:strongest_beylik_variable = this }
				OR = {
					has_reform = government_reform:anatolian_beylik
					capital = {
						OR = {
							region = region:balkan_region
							region = region:anatolia_region
						}
					}
				}
			}
			trigger_event_non_silently = rise_of_the_ottomans.1
		}
	}

	on_monthly = {
		############################################################################
		###########See in_game\common\scripted_effects\situation_effects############
		#####This effectively recalculates the top 3 positions in the situation#####

		rise_of_the_ottomans_recalculate_top_3 = yes

		############################################################################
		
		situation:rise_of_the_ottomans.var:strongest_beylik_variable ?= {
			if = {
				limit = {
					NOT = { tag = TUR }
					NOT = { has_variable = declined_leader_of_the_turks_variable }
					NOT = { has_reform = government_reform:leader_of_the_turks }
				}
				trigger_event_silently = rise_of_the_ottomans.6
			}
		}
		
		
		random_list =  {
			93 = { }
			4 = {
				trigger = {
					var:strongest_beylik_variable ?= {
						any_owned_location = {
							integration_level = conquered
							integration_progress > 0
						}
					}
				}
				var:strongest_beylik_variable ?= {
					trigger_event_non_silently = rise_of_the_ottomans.105
				}
			}
			3 = {
				trigger = {
					var:strongest_beylik_variable ?= {
						has_ruler = yes
						num_subjects < 2
						any_neighbor_country = {
							NOT = { has_variable = rise_of_the_ottomans_vassal_cooldown_variable }
							is_subject = no
							at_war = no
							NOT = { is_subject_of = prev }
							NOT = { is_rival_of = prev }
							NOT = { is_enemy_of = prev }
							religion = prev.religion
							total_population < prev.total_population
							culture.language = prev.culture.language
						}
					}
				}
				var:strongest_beylik_variable ?= {
					trigger_event_non_silently = rise_of_the_ottomans.101
				}
			}
		}
		random_list = {
			95 = {  }
			5 = {
				trigger = {
					any_in_global_list = {
						variable = eligible_beylik_list
						has_reform = government_reform:anatolian_beylik
						any_fort_in_country = {
							NOR = { 
								has_location_modifier = recently_inspected_fortifications_modifier 
								has_location_modifier = decaying_defenses_modifier
							}
						}
					}
				}
				random_in_list = {
					variable = eligible_beylik_list
					limit = {
						has_reform = government_reform:anatolian_beylik
						any_fort_in_country = {
							NOR = { 
								has_location_modifier = recently_inspected_fortifications_modifier 
								has_location_modifier = decaying_defenses_modifier
							}
						}
					}		#Castle Falls in Disrepair
					trigger_event_non_silently = rise_of_the_ottomans.300
				}
			}
		}
		if = {
			limit = { current_year > 1337 }
			random_list = {
				50 = { }
				25 = { 
					every_in_global_list = { 
						variable = eligible_beylik_list
						trigger_event_non_silently = rise_of_the_ottomans.213 
					}
				}
				25 = { 
					every_in_global_list = { 
						variable = eligible_beylik_list
						trigger_event_non_silently = rise_of_the_ottomans.214 
					}
				}
			}
		}
		if = {
			limit = {
				var:strongest_beylik_variable ?= { num_locations > 120 }
			}
			var:strongest_beylik_variable = { trigger_event_non_silently = rise_of_the_ottomans.400 }
			var:strongest_beylik_variable = {
				trigger_event_non_silently = {
					id = rise_of_the_ottomans.215
					days = { 10 25 }
				} 
			}
		}
		if = {
			limit = {
				var:strongest_beylik_variable ?= {
					num_locations > 300
					num_of_non_rural >= 30
					owns = location:constantinople
					NOT = { has_variable = roto600_variable }
				}
			}
			var:strongest_beylik_variable ?= { trigger_event_non_silently = rise_of_the_ottomans.600 }
		}	
	}


	on_ended = {
		#if = {
		#	limit = {
		#		var:rot_timer > 600
		#	}
		#	every_country = {
		#		limit = {
		#			capital = {
		#				OR = {
		#					region = region:balkan_region
		#					region = region:anatolia_region
		#				}
		#			}
		#		}
		#		trigger_event_non_silently = rise_of_the_ottomans.3
		#	}
		#}
		#else =  {
			every_country = {
				remove_country_modifier = ai_force_annexation  

				limit = {
					NOT = { situation:rise_of_the_ottomans.var:strongest_beylik_variable = this }
					OR = {
						has_reform = government_reform:anatolian_beylik
						capital = {
							OR = {
								region = region:balkan_region
								region = region:anatolia_region
							}
						}
					}
				}
				trigger_event_non_silently = rise_of_the_ottomans.4
			}
			if = {
				limit = { 
					NOT = { var:strongest_beylik_variable = c:TUR }
					NOT = { country_exists = c:TUR }
				}
				every_location_in_the_world = {
					limit = {
						is_core_of = c:TUR
					}
					remove_core = c:TUR
				}
				var:strongest_beylik_variable = {
					change_country_tag = TUR
					set_variable = was_not_tur_variable
				}
			}
			var:strongest_beylik_variable ?= {
				if = {
					limit = { has_variable = roto600_variable }
					remove_variable = roto600_variable
				}
				trigger_event_non_silently = rise_of_the_ottomans.5
				set_global_variable = {
					name = victory_in_rise_of_ottomans_variable
					years = 2
				}
			}
			clear_global_variable_list = eligible_beylik_list
			remove_variable = strongest_strongest_beylik_total_score_variable
			remove_variable = second_strongest_strongest_beylik_total_score_variable
			remove_variable = third_strongest_strongest_beylik_total_score_variable
			if = {
				limit = {
					current_year > 1400
					NOT = {
						any_in_global_list = {
							variable = eligible_beylik_list
							num_locations >= 100
						}
					}
					global_variable_list_size = {
						name = eligible_beylik_list
						value >= 1
					}
				}
				every_in_global_list = {
					variable = eligible_beylik_list
					trigger_event_non_silently = rise_of_the_ottomans.500
				}
			}
		}
	#}

	tooltip = {
		if = { #Stronghold City
			limit = {
				has_owner = yes
				has_building = building_type:bey_fortress
			}
			custom_tooltip = "STRONGHOLD_CITY_TOOLTIP"
		}
		if = { #Seljuk Mint
			limit = {
				has_owner = yes
				has_building = building_type:seljuk_mint
			}
			custom_tooltip = "SELJUK_MINT_TOOLTIP"
		}
		if = {
			limit = {
				has_owner = yes
				OR = {
					this = location:konya
					this = location:sivas
					this = location:erzurum
				}
			}
			custom_tooltip = "TRUNK_ROAD_TOOLTIP"
		}
		if = { #Strongest Beylik
			limit = {
				has_owner = yes
				situation:rise_of_the_ottomans.var:strongest_beylik_variable = owner
			}
			custom_tooltip = "STRONGEST_BEYLIK_TOOLTIP"
		}
		else_if = {
			limit = { #Second Strongest Beylik
				has_owner = yes
				situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable = owner
			}
			custom_tooltip = "SECOND_STRONGEST_BEYLIK"
		}
		else_if = { #Third Strongest Beylik
			limit = {
				has_owner = yes
				situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable ?= owner
			}
			custom_tooltip = "THIRD_STRONGEST_BEYLIK"
		}

		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					is_subject = yes
					top_overlord ?= situation:rise_of_the_ottomans.var:strongest_beylik_variable
				}
			}
			custom_tooltip = "STRONGEST_BEYLIK_SUBJECT_TOOLTIP"
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					is_subject = yes
					top_overlord ?= situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable	
				}
			}
			custom_tooltip = "SECOND_STRONGEST_BEYLIK_SUBJECT_TOOLTIP"
		}
		else_if = {
			limit = {
				has_owner = yes
				owner ?= {
					is_subject = yes
					top_overlord ?= situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable	
				}
			}
			custom_tooltip = "THIRD_STRONGEST_BEYLIK_SUBJECT_TOOLTIP"
		}
	}

	map_color = {
		if = {
			limit = {
				has_owner = yes
				has_building = building_type:bey_fortress
			}
			value = purple
		}
		if = {
			limit = {
				has_owner = yes
				OR = {
					this = location:konya
					this = location:sivas
					this = location:erzurum
				}
			}
			value = yellow
		}
		else_if = {
			limit = {
				situation:rise_of_the_ottomans.var:strongest_beylik_variable = prev.owner
			}
			value = situation:rise_of_the_ottomans.var:strongest_beylik_variable.country_color
		}
		else_if = {
			limit = {
				country_exists = situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable
				situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable = prev.owner
			}
			value = situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable.country_color
		}
		else_if = {
			limit = {
				country_exists = situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable
				situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable = prev.owner
			}
			value = situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable.country_color
		}
		else_if = {
			limit = {
				owner ?= { is_subject_of = situation:rise_of_the_ottomans.var:strongest_beylik_variable }
			}
			value = situation:rise_of_the_ottomans.var:strongest_beylik_variable.country_color
		}
		else_if = {
			limit = {
				owner ?= { is_subject_of = situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable }
			}
			value = situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable.country_color
		}
		else_if = {
			limit = {
				owner ?= { is_subject_of = situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable }
			}
			value = situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable.country_color
		}
		else = {
			value = define:NMapColors|DEFAULT_COLOR
		}
	}
	
	legend_key = { 
		desc = "bey_fortress"
		color = purple
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "trunk_road_to_erzurum_privilege"
		color = yellow
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "STRONGEST_BEYLIK_TOOLTIP"
		color = situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable.country_color
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "SECOND_STRONGEST_BEYLIK"
		color = situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable.country_color
		require_color_on_map = yes
	}
	legend_key = { 
		desc = "THIRD_STRONGEST_BEYLIK"
		color = situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable.country_color
		require_color_on_map = yes
	}

	secondary_map_color = {
		if = {
			limit = {
				has_owner = yes
				has_building = building_type:seljuk_mint
			}
			value = red
		}
		else_if = {
			limit = {
				situation:rise_of_the_ottomans.var:strongest_beylik_variable = prev.owner
			}
			value = situation:rise_of_the_ottomans.var:strongest_beylik_variable.country_color
		}
		else_if = {
			limit = {
				country_exists = situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable
				situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable = prev.owner
			}
			value = situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable.country_color
		}
		else_if = {
			limit = {
				country_exists = situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable
				situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable = prev.owner
			}
			value = situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable.country_color
		}
		else_if = {
			limit = {
				owner ?= { is_subject_of = situation:rise_of_the_ottomans.var:strongest_beylik_variable }
			}
			value = situation:rise_of_the_ottomans.var:strongest_beylik_variable.country_color
		}
		else_if = {
			limit = {
				owner ?= { is_subject_of = situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable }
			}
			value = situation:rise_of_the_ottomans.var:second_strongest_strongest_beylik_variable.country_color
		}
		else_if = {
			limit = {
				owner ?= { is_subject_of = situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable }
			}
			value = situation:rise_of_the_ottomans.var:third_strongest_strongest_beylik_variable.country_color
		}
		else = {
			value = define:NMapColors|DEFAULT_COLOR
		}
	}
}